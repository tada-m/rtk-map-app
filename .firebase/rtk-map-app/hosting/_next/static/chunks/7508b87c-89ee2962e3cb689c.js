"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[135],{9745:(e,t,n)=>{n.d(t,{$$:()=>cO,$1:()=>uW,$c:()=>uJ,$t:()=>cc,AB:()=>uQ,AM:()=>ht,B:()=>lU,BN:()=>cv,Bh:()=>c6,C3:()=>cY,CL:()=>cW,Ci:()=>ui,Cq:()=>uq,Cs:()=>lP,Dc:()=>eu,EO:()=>uH,F7:()=>c4,FA:()=>Y,FC:()=>cS,FD:()=>u0,Fs:()=>un,G8:()=>ce,GA:()=>c$,GG:()=>cp,GV:()=>cX,Gv:()=>uX,H6:()=>lj,H9:()=>lL,HM:()=>uY,He:()=>_,Ix:()=>ue,J_:()=>c5,K$:()=>X,K7:()=>cB,LA:()=>l4,LV:()=>c1,Li:()=>uB,MH:()=>l6,Mh:()=>lG,My:()=>uG,NJ:()=>cu,O5:()=>cJ,O8:()=>cr,O_:()=>cC,Os:()=>l5,P:()=>uL,Q5:()=>lZ,Rr:()=>cw,Rw:()=>tH,S0:()=>ur,St:()=>l8,T1:()=>lV,U9:()=>ct,Uo:()=>u$,V7:()=>us,W6:()=>k,Wc:()=>l9,Wq:()=>ca,Ws:()=>lH,XK:()=>lM,Y$:()=>z,YQ:()=>cl,YS:()=>lO,Z9:()=>he,ZX:()=>cj,_7:()=>lQ,_A:()=>lW,_J:()=>co,_M:()=>uU,_e:()=>cg,aQ:()=>cT,aU:()=>lJ,bI:()=>C,bg:()=>cE,c4:()=>cQ,c8:()=>ee,cY:()=>cU,cm:()=>ne,cz:()=>u7,d_:()=>cD,eQ:()=>V,fS:()=>u3,gS:()=>cb,gT:()=>cn,hq:()=>cH,i1:()=>cZ,iB:()=>l2,jy:()=>uK,kA:()=>hn,kL:()=>cV,kU:()=>cy,kd:()=>c_,lN:()=>ch,lo:()=>es,mT:()=>c3,mZ:()=>cI,mc:()=>cs,me:()=>l1,nY:()=>cm,oN:()=>l7,ol:()=>lX,or:()=>uz,po:()=>l3,qG:()=>tJ,qi:()=>E,rJ:()=>lF,rf:()=>uZ,ts:()=>cF,uY:()=>ut,vK:()=>cP,vN:()=>lR,wP:()=>c0,wx:()=>uP,wy:()=>B,x7:()=>cd,xC:()=>uj,yf:()=>c8,yx:()=>lq,z6:()=>cx});var r,i,s,a,o=n(1055),l=n(2881),u=n(6702),c=n(1280),h=n(2107),d=n(927),f=n(9509),m=n(9641).Buffer;let g="@firebase/firestore",p="4.9.0";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="12.0.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function _(e){v.setLogLevel(e)}function b(e,...t){if(v.logLevel<=u.$b.DEBUG){let n=t.map(S);v.debug(`Firestore (${w}): ${e}`,...n)}}function T(e,...t){if(v.logLevel<=u.$b.ERROR){let n=t.map(S);v.error(`Firestore (${w}): ${e}`,...n)}}function E(e,...t){if(v.logLevel<=u.$b.WARN){let n=t.map(S);v.warn(`Firestore (${w}): ${e}`,...n)}}function S(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,N(e,r,n)}function N(e,t,n){let r=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw T(r),Error(r)}function D(e,t,n,r){let i="Unexpected state";"string"==typeof n?i=n:r=n,e||N(t,i,r)}function C(e,t){e||x(57014,t)}let A={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class k extends c.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class R{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class M{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class V{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class O{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class F{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){D(void 0===this.o,42304);let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new R;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new R,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{b("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(b("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new R)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(b("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(D("string"==typeof t.accessToken,31837,{l:t}),new M(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return D(null===e||"string"==typeof e,2055,{h:e}),new y(e)}}class P{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);let e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class L{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new P(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class q{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class U{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){D(void 0===this.o,3512);let n=e=>{null!=e.error&&b("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.m;return this.m=e.token,b("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{b("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?r(e):b("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new q(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(D("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new q(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class B{getToken(){return Promise.resolve(new q(""))}invalidateToken(){}start(e,t){}shutdown(){}}class z{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function $(e,t){return e<t?-1:+(e>t)}function K(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.charAt(r),i=t.charAt(r);if(n!==i)return G(n)===G(i)?$(n,i):G(n)?1:-1}return $(e.length,t.length)}function G(e){let t=e.charCodeAt(0);return t>=55296&&t<=57343}function j(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}let Q="__name__";class W{constructor(e,t,n){void 0===t?t=0:t>e.length&&x(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&x(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===W.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof W?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=W.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return $(e.length,t.length)}static compareSegments(e,t){let n=W.isNumericId(e),r=W.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?W.extractNumericId(e).compare(W.extractNumericId(t)):K(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return h.jz.fromString(e.substring(4,e.length-2))}}class J extends W{construct(e,t,n){return new J(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new k(A.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new J(t)}static emptyPath(){return new J([])}}let H=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Y extends W{construct(e,t,n){return new Y(e,t,n)}static isValidIdentifier(e){return H.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Y.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===Q}static keyField(){return new Y([Q])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new k(A.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new k(A.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new k(A.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new k(A.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Y(t)}static emptyPath(){return new Y([])}}class X{constructor(e){this.path=e}static fromPath(e){return new X(J.fromString(e))}static fromName(e){return new X(J.fromString(e).popFirst(5))}static empty(){return new X(J.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===J.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return J.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new X(new J(e.slice()))}}function Z(e,t,n){if(!n)throw new k(A.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function ee(e,t,n,r){if(!0===t&&!0===r)throw new k(A.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function et(e){if(!X.isDocumentKey(e))throw new k(A.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function en(e){if(X.isDocumentKey(e))throw new k(A.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function er(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function ei(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":x(12329,{type:typeof e})}function es(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new k(A.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=ei(e);throw new k(A.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function ea(e,t){if(t<=0)throw new k(A.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}function eo(e,t){let n={typeString:e};return t&&(n.value=t),n}function el(e,t){let n;if(!er(e))throw new k(A.INVALID_ARGUMENT,"JSON must be an object");for(let r in t)if(t[r]){let i=t[r].typeString,s="value"in t[r]?{value:t[r].value}:void 0;if(!(r in e)){n=`JSON missing required field: '${r}'`;break}let a=e[r];if(i&&typeof a!==i){n=`JSON field '${r}' must be a ${i}.`;break}if(void 0!==s&&a!==s.value){n=`Expected '${r}' field to equal '${s.value}'`;break}}if(n)throw new k(A.INVALID_ARGUMENT,n);return!0}class eu{static now(){return eu.fromMillis(Date.now())}static fromDate(e){return eu.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new eu(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new k(A.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new k(A.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?$(this.nanoseconds,e.nanoseconds):$(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:eu._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(el(e,eu._jsonSchema))return new eu(e.seconds,e.nanoseconds)}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}eu._jsonSchemaVersion="firestore/timestamp/1.0",eu._jsonSchema={type:eo("string",eu._jsonSchemaVersion),seconds:eo("number"),nanoseconds:eo("number")};class ec{static fromTimestamp(e){return new ec(e)}static min(){return new ec(new eu(0,0))}static max(){return new ec(new eu(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class eh{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ed(e){return e.fields.find(e=>2===e.kind)}function ef(e){return e.fields.filter(e=>2!==e.kind)}function em(e,t){let n=$(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(0!==(n=function(e,t){let n=Y.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:$(e.kind,t.kind)}(e.fields[r],t.fields[r])))return n;return $(e.fields.length,t.fields.length)}eh.UNKNOWN_ID=-1;class eg{constructor(e,t){this.fieldPath=e,this.kind=t}}class ep{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new ep(0,ev.min())}}function ey(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new ev(ec.fromTimestamp(1e9===r?new eu(n+1,0):new eu(n,r)),X.empty(),t)}function ew(e){return new ev(e.readTime,e.key,-1)}class ev{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ev(ec.min(),X.empty(),-1)}static max(){return new ev(ec.max(),X.empty(),-1)}}function eI(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=X.comparator(e.documentKey,t.documentKey))?n:$(e.largestBatchId,t.largestBatchId)}let e_="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class eb{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function eT(e){if(e.code!==A.FAILED_PRECONDITION||e.message!==e_)throw e;b("LocalStore","Unexpectedly lost primary lease")}class eE{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new eE((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof eE?t:eE.resolve(t)}catch(e){return eE.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):eE.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):eE.reject(t)}static resolve(e){return new eE((t,n)=>{t(e)})}static reject(e){return new eE((t,n)=>{n(e)})}static waitFor(e){return new eE((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=eE.resolve(!1);for(let n of e)t=t.next(e=>e?eE.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new eE((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new eE((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let eS="SimpleDb";class ex{static open(e,t,n,r){try{return new ex(t,e.transaction(r,n))}catch(e){throw new eA(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new R,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new eA(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let n=eO(t.target.error);this.S.reject(new eA(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(b(eS,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new eR(this.transaction.objectStore(e))}}class eN{static delete(e){return b(eS,"Removing database:",e),eM((0,c.mS)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,c.zW)())return!1;if(eN.F())return!0;let e=(0,c.ZQ)(),t=eN.M(e),n=eD(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static F(){return void 0!==f&&"YES"===f.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.N=n,this.B=null,12.2===eN.M((0,c.ZQ)())&&T("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(b(eS,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new eA(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new k(A.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new k(A.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new eA(e,r))},r.onupgradeneeded=e=>{b(eS,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.N.k(t,r.transaction,e.oldVersion,this.version).next(()=>{b(eS,"Database upgrade to version "+this.version+" complete")})}})),this.q&&(this.db.onversionchange=e=>this.q(e)),this.db}$(e){this.q=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.L(e);let t=ex.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),eE.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(b(eS,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eD(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eC{constructor(e){this.U=e,this.K=!1,this.W=null}get isDone(){return this.K}get G(){return this.W}set cursor(e){this.U=e}done(){this.K=!0}j(e){this.W=e}delete(){return eM(this.U.delete())}}class eA extends k{constructor(e,t){super(A.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ek(e){return"IndexedDbTransactionError"===e.name}class eR{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(b(eS,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(b(eS,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eM(n)}add(e){return b(eS,"ADD",this.store.name,e,e),eM(this.store.add(e))}get(e){return eM(this.store.get(e)).next(t=>(void 0===t&&(t=null),b(eS,"GET",this.store.name,e,t),t))}delete(e){return b(eS,"DELETE",this.store.name,e),eM(this.store.delete(e))}count(){return b(eS,"COUNT",this.store.name),eM(this.store.count())}J(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new eE((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.H(e,(e,n)=>{t.push(n)}).next(()=>t)}}Y(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new eE((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}Z(e,t){b(eS,"DELETE ALL",this.store.name);let n=this.options(e,t);n.X=!1;let r=this.cursor(n);return this.H(r,(e,t,n)=>n.delete())}ee(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.H(r,t)}te(e){let t=this.cursor({});return new eE((n,r)=>{t.onerror=e=>{r(eO(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}H(e,t){let n=[];return new eE((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new eC(i),a=t(i.primaryKey,i.value,s);if(a instanceof eE){let e=a.catch(e=>(s.done(),eE.reject(e)));n.push(e)}s.isDone?r():null===s.G?i.continue():i.continue(s.G)}}).next(()=>eE.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eM(e){return new eE((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eO(e.target.error))}})}let eV=!1;function eO(e){let t=eN.M((0,c.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eV||(eV=!0,setTimeout(()=>{throw e},0)),e}}return e}let eF="IndexBackfiller";class eP{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){b(eF,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ne.ie();b(eF,`Documents written: ${e}`)}catch(e){ek(e)?b(eF,"Ignoring IndexedDB error during index backfill: ",e):await eT(e)}await this.re(6e4)})}}class eL{constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){let n=new Set,r=t,i=!0;return eE.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return b(eF,`Processing collection: ${t}`),this.oe(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}oe(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this._e(r,n)).next(n=>(b(eF,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}_e(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=ew(t);eI(r,n)>0&&(n=r)}),new ev(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eq{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}}function eU(e){return null==e}function eB(e){return 0===e&&1/e==-1/0}function ez(e){return"number"==typeof e&&Number.isInteger(e)&&!eB(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function e$(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}eq.ce=-1;function eK(e){let t=e.length;if(D(t>=2,64408,{path:e}),2===t)return D("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),J.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&x(50515,{path:e}),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x(61167,{path:e})}s=t+2}return new J(r)}let eG="remoteDocuments",ej="owner",eQ="owner",eW="mutationQueues",eJ="mutations",eH="batchId",eY="userMutationsIndex",eX=["userId","batchId"],eZ={},e0="documentMutations",e1="remoteDocumentsV14",e2=["prefixPath","collectionGroup","readTime","documentId"],e5="documentKeyIndex",e4=["prefixPath","collectionGroup","documentId"],e6="collectionGroupIndex",e3=["collectionGroup","readTime","prefixPath","documentId"],e8="remoteDocumentGlobal",e9="remoteDocumentGlobalKey",e7="targets",te="queryTargetsIndex",tt=["canonicalId","targetId"],tn="targetDocuments",tr=["targetId","path"],ti="documentTargetsIndex",ts=["path","targetId"],ta="targetGlobalKey",to="targetGlobal",tl="collectionParents",tu=["collectionId","parent"],tc="clientMetadata",th="bundles",td="namedQueries",tf="indexConfiguration",tm="collectionGroupIndex",tg="indexState",tp=["indexId","uid"],ty="sequenceNumberIndex",tw=["uid","sequenceNumber"],tv="indexEntries",tI=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],t_="documentKeyIndex",tb=["indexId","uid","orderedDocumentKey"],tT="documentOverlays",tE=["userId","collectionPath","documentId"],tS="collectionPathOverlayIndex",tx=["userId","collectionPath","largestBatchId"],tN="collectionGroupOverlayIndex",tD=["userId","collectionGroup","largestBatchId"],tC="globals",tA=[eW,eJ,e0,eG,e7,ej,to,tn,tc,e8,tl,th,td],tk=[...tA,tT],tR=[eW,eJ,e0,e1,e7,ej,to,tn,tc,e8,tl,th,td,tT],tM=[...tR,tf,tg,tv],tV=[...tM,tC];class tO extends eb{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function tF(e,t){return eN.O(e.le,t)}function tP(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tL(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tq(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function tU(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tB{constructor(e,t){this.comparator=e,this.root=t||t$.EMPTY}insert(e,t){return new tB(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,t$.BLACK,null,null))}remove(e){return new tB(this.comparator,this.root.remove(e,this.comparator).copy(null,null,t$.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tz(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tz(this.root,e,this.comparator,!1)}getReverseIterator(){return new tz(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tz(this.root,e,this.comparator,!0)}}class tz{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class t${constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:t$.RED,this.left=null!=r?r:t$.EMPTY,this.right=null!=i?i:t$.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new t$(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return t$.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return t$.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,t$.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,t$.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw x(43730,{key:this.key,value:this.value});if(this.right.isRed())throw x(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw x(27949);return e+ +!this.isRed()}}t$.EMPTY=null,t$.RED=!0,t$.BLACK=!1,t$.EMPTY=new class{constructor(){this.size=0}get key(){throw x(57766)}get value(){throw x(16141)}get color(){throw x(16727)}get left(){throw x(29726)}get right(){throw x(36894)}copy(e,t,n,r,i){return this}insert(e,t,n){return new t$(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tK{constructor(e){this.comparator=e,this.data=new tB(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tG(this.data.getIterator())}getIteratorFrom(e){return new tG(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tK)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tK(this.comparator);return t.data=e,t}}class tG{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tj(e){return e.hasNext()?e.getNext():void 0}class tQ{constructor(e){this.fields=e,e.sort(Y.comparator)}static empty(){return new tQ([])}unionWith(e){let t=new tK(Y.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tQ(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return j(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tW extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function tJ(){return"undefined"!=typeof atob}class tH{constructor(e){this.binaryString=e}static fromBase64String(e){return new tH(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tW("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tH(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return $(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tH.EMPTY_BYTE_STRING=new tH("");let tY=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tX(e){if(D(!!e,39018),"string"==typeof e){let t=0,n=tY.exec(e);if(D(!!n,46558,{timestamp:e}),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tZ(e.seconds),nanos:tZ(e.nanos)}}function tZ(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function t0(e){return"string"==typeof e?tH.fromBase64String(e):tH.fromUint8Array(e)}let t1="server_timestamp",t2="__type__",t5="__previous_value__",t4="__local_write_time__";function t6(e){return(e?.mapValue?.fields||{})[t2]?.stringValue===t1}function t3(e){let t=e.mapValue.fields[t5];return t6(t)?t3(t):t}function t8(e){let t=tX(e.mapValue.fields[t4].timestampValue);return new eu(t.seconds,t.nanos)}class t9{constructor(e,t,n,r,i,s,a,o,l,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u}}let t7="(default)";class ne{constructor(e,t){this.projectId=e,this.database=t||t7}static empty(){return new ne("","")}get isDefaultDatabase(){return this.database===t7}isEqual(e){return e instanceof ne&&e.projectId===this.projectId&&e.database===this.database}}let nt="__type__",nn="__max__",nr={mapValue:{fields:{__type__:{stringValue:nn}}}},ni="__vector__",ns="value",na={nullValue:"NULL_VALUE"};function no(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?t6(e)?4:nb(e)?0x1fffffffffffff:nI(e)?10:11:x(28295,{value:e})}function nl(e,t){if(e===t)return!0;let n=no(e);if(n!==no(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return t8(e).isEqual(t8(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=tX(e.timestampValue),i=tX(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return t0(e.bytesValue).isEqual(t0(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tZ(e.geoPointValue.latitude)===tZ(t.geoPointValue.latitude)&&tZ(e.geoPointValue.longitude)===tZ(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return tZ(e.integerValue)===tZ(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tZ(e.doubleValue),r=tZ(t.doubleValue);return n===r?eB(n)===eB(r):isNaN(n)&&isNaN(r)}return!1;case 9:return j(e.arrayValue.values||[],t.arrayValue.values||[],nl);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(tP(s)!==tP(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!nl(s[e],a[e])))return!1;return!0;default:return x(52216,{left:e})}}function nu(e,t){return void 0!==(e.values||[]).find(e=>nl(e,t))}function nc(e,t){if(e===t)return 0;let n=no(e),r=no(t);if(n!==r)return $(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return $(e.booleanValue,t.booleanValue);case 2:let i=tZ(e.integerValue||e.doubleValue),s=tZ(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return nh(e.timestampValue,t.timestampValue);case 4:return nh(t8(e),t8(t));case 5:return K(e.stringValue,t.stringValue);case 6:return function(e,t){let n=t0(e),r=t0(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=$(n[e],r[e]);if(0!==t)return t}return $(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=$(tZ(e.latitude),tZ(t.latitude));return 0!==n?n:$(tZ(e.longitude),tZ(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return nd(e.arrayValue,t.arrayValue);case 10:return function(e,t){let n=e.fields||{},r=t.fields||{},i=n[ns]?.arrayValue,s=r[ns]?.arrayValue,a=$(i?.values?.length||0,s?.values?.length||0);return 0!==a?a:nd(i,s)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===nr.mapValue&&t===nr.mapValue)return 0;if(e===nr.mapValue)return 1;if(t===nr.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=K(r[e],s[e]);if(0!==t)return t;let a=nc(n[r[e]],i[s[e]]);if(0!==a)return a}return $(r.length,s.length)}(e.mapValue,t.mapValue);default:throw x(23264,{he:n})}}function nh(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return $(e,t);let n=tX(e),r=tX(t),i=$(n.seconds,r.seconds);return 0!==i?i:$(n.nanos,r.nanos)}function nd(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=nc(n[e],r[e]);if(t)return t}return $(n.length,r.length)}function nf(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tX(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?t0(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,X.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=nf(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${nf(e.fields[i])}`;return n+"}"}(e.mapValue):x(61005,{value:e})}function nm(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function ng(e){return!!e&&"integerValue"in e}function np(e){return!!e&&"arrayValue"in e}function ny(e){return!!e&&"nullValue"in e}function nw(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nv(e){return!!e&&"mapValue"in e}function nI(e){return(e?.mapValue?.fields||{})[nt]?.stringValue===ni}function n_(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){let t={mapValue:{fields:{}}};return tL(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=n_(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=n_(e.arrayValue.values[n]);return t}return{...e}}function nb(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===nn}let nT={mapValue:{fields:{[nt]:{stringValue:ni},[ns]:{arrayValue:{}}}}};function nE(e,t){let n=nc(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nS(e,t){let n=nc(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nx{constructor(e){this.value=e}static empty(){return new nx({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nv(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=n_(t)}setAll(e){let t=Y.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=n_(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nv(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return nl(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nv(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tL(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new nx(n_(this.value))}}class nN{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new nN(e,0,ec.min(),ec.min(),ec.min(),nx.empty(),0)}static newFoundDocument(e,t,n,r){return new nN(e,1,t,ec.min(),n,r,0)}static newNoDocument(e,t){return new nN(e,2,t,ec.min(),ec.min(),nx.empty(),0)}static newUnknownDocument(e,t){return new nN(e,3,t,ec.min(),ec.min(),nx.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(ec.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nx.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nx.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ec.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nN&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nN(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nD{constructor(e,t){this.position=e,this.inclusive=t}}function nC(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?X.comparator(X.fromName(a.referenceValue),n.key):nc(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nA(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!nl(e.position[n],t.position[n]))return!1;return!0}class nk{constructor(e,t="asc"){this.field=e,this.dir=t}}class nR{}class nM extends nR{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nU(e,t,n):"array-contains"===t?new nK(e,n):"in"===t?new nG(e,n):"not-in"===t?new nj(e,n):"array-contains-any"===t?new nQ(e,n):new nM(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nB(e,n):new nz(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(nc(t,this.value)):null!==t&&no(this.value)===no(t)&&this.matchesComparison(nc(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nV extends nR{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new nV(e,t)}matches(e){return nO(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function nO(e){return"and"===e.op}function nF(e){return"or"===e.op}function nP(e){return nL(e)&&nO(e)}function nL(e){for(let t of e.filters)if(t instanceof nV)return!1;return!0}function nq(e,t){let n=e.filters.concat(t);return nV.create(n,e.op)}class nU extends nM{constructor(e,t,n){super(e,t,n),this.key=X.fromName(n.referenceValue)}matches(e){let t=X.comparator(e.key,this.key);return this.matchesComparison(t)}}class nB extends nM{constructor(e,t){super(e,"in",t),this.keys=n$("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nz extends nM{constructor(e,t){super(e,"not-in",t),this.keys=n$("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function n$(e,t){return(t.arrayValue?.values||[]).map(e=>X.fromName(e.referenceValue))}class nK extends nM{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return np(t)&&nu(t.arrayValue,this.value)}}class nG extends nM{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&nu(this.value.arrayValue,t)}}class nj extends nM{constructor(e,t){super(e,"not-in",t)}matches(e){if(nu(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!nu(this.value.arrayValue,t)}}class nQ extends nM{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!np(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>nu(this.value.arrayValue,e))}}class nW{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.Te=null}}function nJ(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nW(e,t,n,r,i,s,a)}function nH(e){if(null===e.Te){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nM)return t.field.canonicalString()+t.op.toString()+nf(t.value);if(nP(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eU(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nf(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nf(e)).join(",")),e.Te=t}return e.Te}function nY(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nM?n instanceof nM&&t.op===n.op&&t.field.isEqual(n.field)&&nl(t.value,n.value):t instanceof nV?n instanceof nV&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void x(19439)}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nA(e.startAt,t.startAt)&&nA(e.endAt,t.endAt)}function nX(e){return X.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nZ(e,t){return e.filters.filter(e=>e instanceof nM&&e.field.isEqual(t))}function n0(e,t,n){let r=na,i=!0;for(let n of nZ(e,t)){let e=na,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?na:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?nm(ne.empty(),X.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nI(s)?nT:{mapValue:{}}:x(35942,{value:s});break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=na}0>nE({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>nE({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function n1(e,t,n){let r=nr,i=!0;for(let n of nZ(e,t)){let e=nr,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?nm(ne.empty(),X.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nT:"mapValue"in s?nI(s)?{mapValue:{}}:nr:x(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=nr}nS({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];nS({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class n2{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}}function n5(e){return new n2(e)}function n4(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function n6(e){return null!==e.collectionGroup}function n3(e){if(null===e.Ie){let t;e.Ie=[];let n=new Set;for(let t of e.explicitOrderBy)e.Ie.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tK(Y.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.Ie.push(new nk(t,r))}),n.has(Y.keyField().canonicalString())||e.Ie.push(new nk(Y.keyField(),r))}return e.Ie}function n8(e){return e.Ee||(e.Ee=n7(e,n3(e))),e.Ee}function n9(e){return e.de||(e.de=n7(e,e.explicitOrderBy)),e.de}function n7(e,t){if("F"===e.limitType)return nJ(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nk(e.field,t)});let n=e.endAt?new nD(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nD(e.startAt.position,e.startAt.inclusive):null;return nJ(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function re(e,t){let n=e.filters.concat([t]);return new n2(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function rt(e,t,n){return new n2(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function rn(e,t){return nY(n8(e),n8(t))&&e.limitType===t.limitType}function rr(e){return`${nH(n8(e))}|lt:${e.limitType}`}function ri(e){var t;let n;return`Query(target=${n=(t=n8(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nM?`${t.field.canonicalString()} ${t.op} ${nf(t.value)}`:t instanceof nV?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eU(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>nf(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>nf(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function rs(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):X.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of n3(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nC(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,n3(e),t))&&(!e.endAt||!!function(e,t,n){let r=nC(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,n3(e),t))}function ra(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function ro(e){return(t,n)=>{let r=!1;for(let i of n3(e)){let e=function(e,t,n){let r=e.field.isKeyField()?X.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?nc(r,i):x(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return x(19790,{direction:e.dir})}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class rl{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tL(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tU(this.inner)}size(){return this.innerSize}}let ru=new tB(X.comparator),rc=new tB(X.comparator);function rh(...e){let t=rc;for(let n of e)t=t.insert(n.key,n);return t}function rd(e){let t=rc;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rf(){return new rl(e=>e.toString(),(e,t)=>e.isEqual(t))}let rm=new tB(X.comparator),rg=new tK(X.comparator);function rp(...e){let t=rg;for(let n of e)t=t.add(n);return t}let ry=new tK($);function rw(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eB(t)?"-0":t}}function rv(e){return{integerValue:""+e}}function rI(e,t){return ez(t)?rv(t):rw(e,t)}class r_{constructor(){this._=void 0}}function rb(e,t){return e instanceof rD?ng(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rT extends r_{}class rE extends r_{constructor(e){super(),this.elements=e}}function rS(e,t){let n=rA(t);for(let t of e.elements)n.some(e=>nl(e,t))||n.push(t);return{arrayValue:{values:n}}}class rx extends r_{constructor(e){super(),this.elements=e}}function rN(e,t){let n=rA(t);for(let t of e.elements)n=n.filter(e=>!nl(e,t));return{arrayValue:{values:n}}}class rD extends r_{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function rC(e){return tZ(e.integerValue||e.doubleValue)}function rA(e){return np(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rk{constructor(e,t){this.field=e,this.transform=t}}class rR{constructor(e,t){this.version=e,this.transformResults=t}}class rM{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rM}static exists(e){return new rM(void 0,e)}static updateTime(e){return new rM(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rV(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rO{}function rF(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rK(e.key,rM.none()):new rq(e.key,e.data,rM.none());{let n=e.data,r=nx.empty(),i=new tK(Y.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rU(e.key,r,new tQ(i.toArray()),rM.none())}}function rP(e,t,n,r){return e instanceof rq?function(e,t,n,r){if(!rV(e.precondition,t))return n;let i=e.value.clone(),s=r$(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rU?function(e,t,n,r){if(!rV(e.precondition,t))return n;let i=r$(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rB(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rV(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rL(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&j(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rE&&r instanceof rE||n instanceof rx&&r instanceof rx?j(n.elements,r.elements,nl):n instanceof rD&&r instanceof rD?nl(n.Ae,r.Ae):n instanceof rT&&r instanceof rT)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rq extends rO{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rU extends rO{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rB(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rz(e,t,n){let r=new Map;D(e.length===n.length,32656,{Re:n.length,Ve:e.length});for(let s=0;s<n.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);r.set(a.field,(i=n[s],o instanceof rE?rS(o,l):o instanceof rx?rN(o,l):i))}return r}function r$(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rT?function(e,t){let n={fields:{[t2]:{stringValue:t1},[t4]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&t6(t)&&(t=t3(t)),t&&(n.fields[t5]=t),{mapValue:n}}(t,s):e instanceof rE?rS(e,s):e instanceof rx?rN(e,s):function(e,t){let n=rb(e,t),r=rC(n)+rC(e.Ae);return ng(n)&&ng(e.Ae)?rv(r):rw(e.serializer,r)}(e,s))}return r}class rK extends rO{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rG extends rO{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rj{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){e instanceof rq?function(e,t,n){let r=e.value.clone(),i=rz(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof rU?function(e,t,n){if(!rV(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=rz(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rB(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rP(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rP(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=rf();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rF(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(ec.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rp())}isEqual(e){return this.batchId===e.batchId&&j(this.mutations,e.mutations,(e,t)=>rL(e,t))&&j(this.baseMutations,e.baseMutations,(e,t)=>rL(e,t))}}class rQ{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){D(e.mutations.length===n.length,58842,{me:e.mutations.length,fe:n.length});let r=rm,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rQ(e,t,n,r)}}class rW{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rJ{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class rH{constructor(e,t){this.count=e,this.unchangedNames=t}}function rY(e){switch(e){case A.OK:return x(64938);case A.CANCELLED:case A.UNKNOWN:case A.DEADLINE_EXCEEDED:case A.RESOURCE_EXHAUSTED:case A.INTERNAL:case A.UNAVAILABLE:case A.UNAUTHENTICATED:return!1;case A.INVALID_ARGUMENT:case A.NOT_FOUND:case A.ALREADY_EXISTS:case A.PERMISSION_DENIED:case A.FAILED_PRECONDITION:case A.ABORTED:case A.OUT_OF_RANGE:case A.UNIMPLEMENTED:case A.DATA_LOSS:return!0;default:return x(15467,{code:e})}}function rX(e){if(void 0===e)return T("GRPC error has no .code"),A.UNKNOWN;switch(e){case r.OK:return A.OK;case r.CANCELLED:return A.CANCELLED;case r.UNKNOWN:return A.UNKNOWN;case r.DEADLINE_EXCEEDED:return A.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return A.RESOURCE_EXHAUSTED;case r.INTERNAL:return A.INTERNAL;case r.UNAVAILABLE:return A.UNAVAILABLE;case r.UNAUTHENTICATED:return A.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return A.INVALID_ARGUMENT;case r.NOT_FOUND:return A.NOT_FOUND;case r.ALREADY_EXISTS:return A.ALREADY_EXISTS;case r.PERMISSION_DENIED:return A.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return A.FAILED_PRECONDITION;case r.ABORTED:return A.ABORTED;case r.OUT_OF_RANGE:return A.OUT_OF_RANGE;case r.UNIMPLEMENTED:return A.UNIMPLEMENTED;case r.DATA_LOSS:return A.DATA_LOSS;default:return x(39323,{code:e})}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rZ=null;function r0(){return new TextEncoder}let r1=new h.jz([0xffffffff,0xffffffff],0);function r2(e){let t=r0().encode(e),n=new h.VV;return n.update(t),new Uint8Array(n.digest())}function r5(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new h.jz([n,r],0),new h.jz([i,s],0)]}class r4{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new r6(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new r6(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new r6(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=h.jz.fromNumber(this.ge)}ye(e,t,n){let r=e.add(t.multiply(h.jz.fromNumber(n)));return 1===r.compare(r1)&&(r=new h.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;let[t,n]=r5(r2(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);if(!this.we(r))return!1}return!0}static create(e,t,n){let r=new r4(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.ge)return;let[t,n]=r5(r2(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);this.Se(r)}}Se(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class r6 extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class r3{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,r8.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new r3(ec.min(),r,new tB($),ru,rp())}}class r8{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new r8(n,t,rp(),rp(),rp())}}class r9{constructor(e,t,n,r){this.be=e,this.removedTargetIds=t,this.key=n,this.De=r}}class r7{constructor(e,t){this.targetId=e,this.Ce=t}}class ie{constructor(e,t,n=tH.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class it{constructor(){this.ve=0,this.Fe=is(),this.Me=tH.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=rp(),t=rp(),n=rp();return this.Fe.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:x(38017,{changeType:i})}}),new r8(this.Me,this.xe,e,t,n)}qe(){this.Oe=!1,this.Fe=is()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,D(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}}class ir{constructor(e){this.Ge=e,this.ze=new Map,this.je=ru,this.Je=ii(),this.He=ii(),this.Ye=new tB($)}Ze(e){for(let t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let n=this.nt(t);switch(e.state){case 0:this.rt(t)&&n.Le(e.resumeToken);break;case 1:n.Ke(),n.Ne||n.qe(),n.Le(e.resumeToken);break;case 2:n.Ke(),n.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(n.We(),n.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),n.Le(e.resumeToken));break;default:x(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,n)=>{this.rt(n)&&t(n)})}st(e){let t=e.targetId,n=e.Ce.count,r=this.ot(t);if(r){let i=r.target;if(nX(i))if(0===n){let e=new X(i.path);this.et(t,e,nN.newNoDocument(e,ec.min()))}else D(1===n,20013,{expectedCount:n});else{let r=this._t(t);if(r!==n){let n=this.ut(e),i=n?this.ct(n,e,r):1;0!==i&&(this.it(t),this.Ye=this.Ye.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch")),rZ?.lt(function(e,t,n,r,i){let s={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},a=t.unchangedNames;return a&&(s.bloomFilter={applied:0===i,hashCount:a?.hashCount??0,bitmapLength:a?.bits?.bitmap?.length??0,padding:a?.bits?.padding??0,mightContain:e=>r?.mightContain(e)??!1}),s}(r,e.Ce,this.Ge.ht(),n,i))}}}}ut(e){let t,n,r=e.Ce.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=t0(i).toUint8Array()}catch(e){if(e instanceof tW)return E("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new r4(t,s,a)}catch(e){return E(e instanceof r6?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.ge?null:n}ct(e,t,n){return 2*(t.Ce.count!==n-this.Pt(e,t.targetId))}Pt(e,t){let n=this.Ge.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Ge.ht(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.et(t,n,null),r++)}),r}Tt(e){let t=new Map;this.ze.forEach((n,r)=>{let i=this.ot(r);if(i){if(n.current&&nX(i.target)){let t=new X(i.target.path);this.It(t).has(r)||this.Et(r,t)||this.et(r,t,nN.newNoDocument(t,e))}n.Be&&(t.set(r,n.ke()),n.qe())}});let n=rp();this.He.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.je.forEach((t,n)=>n.setReadTime(e));let r=new r3(e,t,this.Ye,this.je,n);return this.je=ru,this.Je=ii(),this.He=ii(),this.Ye=new tB($),r}Xe(e,t){if(!this.rt(e))return;let n=2*!!this.Et(e,t.key);this.nt(e).Qe(t.key,n),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,n){if(!this.rt(e))return;let r=this.nt(e);this.Et(e,t)?r.Qe(t,1):r.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),n&&(this.je=this.je.insert(t,n))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new it,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new tK($),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new tK($),this.Je=this.Je.insert(e,t)),t}rt(e){let t=null!==this.ot(e);return t||b("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new it),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function ii(){return new tB(X.comparator)}function is(){return new tB(X.comparator)}let ia={asc:"ASCENDING",desc:"DESCENDING"},io={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},il={and:"AND",or:"OR"};class iu{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ic(e,t){return e.useProto3Json||eU(t)?t:{value:t}}function ih(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function id(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function im(e){return D(!!e,49232),ec.fromTimestamp(function(e){let t=tX(e);return new eu(t.seconds,t.nanos)}(e))}function ig(e,t){return ip(e,t).canonicalString()}function ip(e,t){let n=new J(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function iy(e){let t=J.fromString(e);return D(iV(t),10190,{key:t.toString()}),t}function iw(e,t){return ig(e.databaseId,t.path)}function iv(e,t){let n=iy(t);if(n.get(1)!==e.databaseId.projectId)throw new k(A.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new k(A.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new X(iT(n))}function iI(e,t){return ig(e.databaseId,t)}function i_(e){let t=iy(e);return 4===t.length?J.emptyPath():iT(t)}function ib(e){return new J(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function iT(e){return D(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function iE(e,t,n){return{name:iw(e,t),fields:n.value.mapValue.fields}}function iS(e,t,n){let r=iv(e,t.name),i=im(t.updateTime),s=t.createTime?im(t.createTime):ec.min(),a=new nx({mapValue:{fields:t.fields}}),o=nN.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ix(e,t){var n;let r;if(t instanceof rq)r={update:iE(e,t.key,t.value)};else if(t instanceof rK)r={delete:iw(e,t.key)};else if(t instanceof rU)r={update:iE(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rG))return x(16599,{Vt:t.type});r={verify:iw(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rT)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rE)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rx)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rD)return{fieldPath:t.field.canonicalString(),increment:n.Ae};throw x(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:ih(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:x(27497)),r}function iN(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rM.updateTime(im(n.updateTime)):void 0!==n.exists?rM.exists(n.exists):rM.none():rM.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?(D("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rT):"appendMissingElements"in t?n=new rE(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new rx(t.removeAllFromArray.values||[]):"increment"in t?n=new rD(e,t.increment):x(16584,{proto:t}),new rk(Y.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=iv(e,t.update.name),s=new nx({mapValue:{fields:t.update.fields}});return t.updateMask?new rU(n,s,new tQ((t.updateMask.fieldPaths||[]).map(e=>Y.fromServerFormat(e))),r,i):new rq(n,s,r,i)}return t.delete?new rK(iv(e,t.delete),r):t.verify?new rG(iv(e,t.verify),r):x(1463,{proto:t})}function iD(e,t){return{documents:[iI(e,t.path)]}}function iC(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=iI(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof nM?function(e){if("=="===e.op){if(nw(e.value))return{unaryFilter:{field:iR(e.field),op:"IS_NAN"}};if(ny(e.value))return{unaryFilter:{field:iR(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nw(e.value))return{unaryFilter:{field:iR(e.field),op:"IS_NOT_NAN"}};if(ny(e.value))return{unaryFilter:{field:iR(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iR(e.field),op:io[e.op],value:e.value}}}(t):t instanceof nV?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:il[t.op],filters:n}}}(t):x(54877,{filter:t})}(nV.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iR(e.field),direction:ia[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=ic(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ft:s,parent:i}}function iA(e,t,n,r){let{ft:i,parent:s}=iC(e,t),a={},o=[],l=0;return n.forEach(e=>{let t=r?e.alias:"aggregate_"+l++;a[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:iR(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:iR(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:i.structuredQuery},parent:i.parent},gt:a,parent:s}}function ik(e){var t;let n,r=i_(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){D(1===s,65062);let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=iM(e.unaryFilter.field);return nM.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=iM(e.unaryFilter.field);return nM.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=iM(e.unaryFilter.field);return nM.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=iM(e.unaryFilter.field);return nM.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return x(61313);default:return x(60726)}}(t):void 0!==t.fieldFilter?nM.create(iM(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return x(58110);default:return x(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nV.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x(1026)}}(t.compositeFilter.op)):x(30097,{filter:t})}(e);return t instanceof nV&&nP(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nk(iM(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eU(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let c=null;i.startAt&&(c=function(e){let t=!!e.before;return new nD(e.values||[],t)}(i.startAt));let h=null;return i.endAt&&(h=function(e){let t=!e.before;return new nD(e.values||[],t)}(i.endAt)),new n2(r,a,l,o,u,"F",c,h)}function iR(e){return{fieldPath:e.canonicalString()}}function iM(e){return Y.fromServerFormat(e.fieldPath)}function iV(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iO{constructor(e,t,n,r,i=ec.min(),s=ec.min(),a=tH.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iO(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iO(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iO(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iO(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iF{constructor(e){this.yt=e}}function iP(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:iL(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:iw(i=e.yt,t.key),fields:t.data.value.mapValue.fields,updateTime:ih(i,t.version.toTimestamp()),createTime:ih(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iq(t.version)};else{if(!t.isUnknownDocument())return x(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iq(t.version)}}return r}function iL(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iq(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iU(e){let t=new eu(e.seconds,e.nanoseconds);return ec.fromTimestamp(t)}function iB(e,t){let n=(t.baseMutations||[]).map(t=>iN(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>iN(e.yt,t)),i=eu.fromMillis(t.localWriteTimeMs);return new rj(t.batchId,i,n,r)}function iz(e){let t=iU(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iU(e.lastLimboFreeSnapshotVersion):ec.min();return new iO(void 0!==e.query.documents?function(e){let t=e.documents.length;return D(1===t,1966,{count:t}),n8(n5(i_(e.documents[0])))}(e.query):n8(ik(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,tH.fromBase64String(e.resumeToken))}function i$(e,t){let n,r=iq(t.snapshotVersion),i=iq(t.lastLimboFreeSnapshotVersion);n=nX(t.target)?iD(e.yt,t.target):iC(e.yt,t.target).ft;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nH(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iK(e){let t=ik({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rt(t,t.limit,"L"):t}function iG(e,t){return new rW(t.largestBatchId,iN(e.yt,t.overlayMutation))}function ij(e,t){let n=t.path.lastSegment();return[e,e$(t.path.popLast()),n]}function iQ(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iq(r.readTime),documentKey:e$(r.documentKey.path),largestBatchId:r.largestBatchId}}class iW{getBundleMetadata(e,t){return tF(e,th).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iU(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tF(e,th).put({bundleId:t.id,createTime:iq(im(t.createTime)),version:t.version})}getNamedQuery(e,t){return tF(e,td).get(t).next(e=>{if(e)return{name:e.name,query:iK(e.bundledQuery),readTime:iU(e.readTime)}})}saveNamedQuery(e,t){return tF(e,td).put({name:t.name,readTime:iq(im(t.readTime)),bundledQuery:t.bundledQuery})}}class iJ{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){return new iJ(e,t.uid||"")}getOverlay(e,t){return tF(e,tT).get(ij(this.userId,t)).next(e=>e?iG(this.serializer,e):null)}getOverlays(e,t){let n=rf();return eE.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rW(t,i);r.push(this.St(e,s))}),eE.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(e$(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tF(e,tT).Z(tS,r))}),eE.waitFor(i)}getOverlaysForCollection(e,t,n){let r=rf(),i=e$(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,1/0],!0);return tF(e,tT).J(tS,s).next(e=>{for(let t of e){let e=iG(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=rf(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,1/0],!0);return tF(e,tT).ee({index:tN,range:a},(e,t,n)=>{let a=iG(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}St(e,t){return tF(e,tT).put(function(e,t,n){let[r,i,s]=ij(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ix(e.yt,n.mutation)}}(this.serializer,this.userId,t))}}class iH{bt(e){return tF(e,tC)}getSessionToken(e){return this.bt(e).get("sessionToken").next(e=>{let t=e?.value;return t?tH.fromUint8Array(t):tH.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.bt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iY{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(+!!e.booleanValue);else if("integerValue"in e)this.Ft(t,15),t.Mt(tZ(e.integerValue));else if("doubleValue"in e){let n=tZ(e.doubleValue);isNaN(n)?this.Ft(t,13):(this.Ft(t,15),eB(n)?t.Mt(0):t.Mt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Ft(t,20),"string"==typeof n&&(n=tX(n)),t.xt(`${n.seconds||""}`),t.Mt(n.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(t0(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.Ft(t,45),t.Mt(n.latitude||0),t.Mt(n.longitude||0)}else"mapValue"in e?nb(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):nI(e)?this.kt(e.mapValue,t):(this.qt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.Qt(e.arrayValue,t),this.Nt(t)):x(19022,{$t:e})}Ot(e,t){this.Ft(t,25),this.Ut(e,t)}Ut(e,t){t.xt(e)}qt(e,t){let n=e.fields||{};for(let e of(this.Ft(t,55),Object.keys(n)))this.Ot(e,t),this.Ct(n[e],t)}kt(e,t){let n=e.fields||{};this.Ft(t,53);let r=n[ns].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(tZ(r)),this.Ot(ns,t),this.Ct(n[ns],t)}Qt(e,t){let n=e.values||[];for(let e of(this.Ft(t,50),n))this.Ct(e,t)}Lt(e,t){this.Ft(t,37),X.fromName(e).path.forEach(e=>{this.Ft(t,60),this.Ut(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}function iX(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iY.Kt=new iY;class iZ{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Wt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Gt(n.value),n=t.next();this.zt()}jt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Jt(n.value),n=t.next();this.Ht()}Yt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{let e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{let e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Ht()}Xt(e){let t=this.en(e),n=iX(t);this.tn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){let t=this.en(e),n=iX(t);this.tn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(255),this.sn(255)}_n(){this.an(255),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}Gt(e){let t=255&e;0===t?(this.sn(0),this.sn(255)):255===t?(this.sn(255),this.sn(0)):this.sn(t)}Jt(e){let t=255&e;0===t?(this.an(0),this.an(255)):255===t?(this.an(255),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Ht(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class i0{constructor(e){this.cn=e}Bt(e){this.cn.Wt(e)}xt(e){this.cn.Yt(e)}Mt(e){this.cn.Xt(e)}vt(){this.cn.rn()}}class i1{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class i2{constructor(){this.cn=new iZ,this.ln=new i0(this.cn),this.hn=new i1(this.cn)}seed(e){this.cn.seed(e)}Pn(e){return 0===e?this.ln:this.hn}un(){return this.cn.un()}reset(){this.cn.reset()}}class i5{constructor(e,t,n,r){this.Tn=e,this.In=t,this.En=n,this.dn=r}An(){let e=this.dn.length,t=0===e||255===this.dn[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.dn,0),t!==e?n.set([0],this.dn.length):++n[n.length-1],new i5(this.Tn,this.In,this.En,n)}Rn(e,t,n){return{indexId:this.Tn,uid:e,arrayValue:i3(this.En),directionalValue:i3(this.dn),orderedDocumentKey:i3(t),documentKey:n.path.toArray()}}Vn(e,t,n){let r=this.Rn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function i4(e,t){let n=e.Tn-t.Tn;return 0!==n||0!==(n=i6(e.En,t.En))||0!==(n=i6(e.dn,t.dn))?n:X.comparator(e.In,t.In)}function i6(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function i3(e){return(0,c.Ov)()?function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function i8(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class i9{constructor(e){for(let t of(this.mn=new tK((e,t)=>Y.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.fn=e.orderBy,this.gn=[],e.filters))t.isInequality()?this.mn=this.mn.add(t):this.gn.push(t)}get pn(){return this.mn.size>1}yn(e){if(D(e.collectionGroup===this.collectionId,49279),this.pn)return!1;let t=ed(e);if(void 0!==t&&!this.wn(t))return!1;let n=ef(e),r=new Set,i=0,s=0;for(;i<n.length&&this.wn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.mn.size>0){let e=this.mn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.Sn(e,t)||!this.bn(this.fn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.fn.length||!this.bn(this.fn[s++],e))return!1}return!0}Dn(){if(this.pn)return null;let e=new tK(Y.comparator),t=[];for(let n of this.gn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new eg(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new eg(n.field,0))}for(let n of this.fn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new eg(n.field,+("asc"!==n.dir))));return new eh(eh.UNKNOWN_ID,this.collectionId,t,ep.empty())}wn(e){for(let t of this.gn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}bn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function i7(e){return e instanceof nM}function se(e){return e instanceof nV&&nP(e)}function st(e){return i7(e)||se(e)||function(e){if(e instanceof nV&&nF(e)){for(let t of e.getFilters())if(!i7(t)&&!se(t))return!1;return!0}return!1}(e)}function sn(e,t){return D(e instanceof nM||e instanceof nV,38388),D(t instanceof nM||t instanceof nV,25473),si(e instanceof nM?t instanceof nM?nV.create([e,t],"and"):sr(e,t):t instanceof nM?sr(t,e):function(e,t){if(D(e.filters.length>0&&t.filters.length>0,48005),nO(e)&&nO(t))return nq(e,t.getFilters());let n=nF(e)?e:t,r=nF(e)?t:e,i=n.filters.map(e=>sn(e,r));return nV.create(i,"or")}(e,t))}function sr(e,t){if(nO(t))return nq(t,e.getFilters());{let n=t.filters.map(t=>sn(e,t));return nV.create(n,"or")}}function si(e){if(D(e instanceof nM||e instanceof nV,11850),e instanceof nM)return e;let t=e.getFilters();if(1===t.length)return si(t[0]);if(nL(e))return e;let n=t.map(e=>si(e)),r=[];return n.forEach(t=>{t instanceof nM?r.push(t):t instanceof nV&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nV.create(r,e.op)}class ss{constructor(){this.Cn=new sa}addToCollectionParentIndex(e,t){return this.Cn.add(t),eE.resolve()}getCollectionParents(e,t){return eE.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return eE.resolve()}deleteFieldIndex(e,t){return eE.resolve()}deleteAllFieldIndexes(e){return eE.resolve()}createTargetIndexes(e,t){return eE.resolve()}getDocumentsMatchingTarget(e,t){return eE.resolve(null)}getIndexType(e,t){return eE.resolve(0)}getFieldIndexes(e,t){return eE.resolve([])}getNextCollectionGroupToUpdate(e){return eE.resolve(null)}getMinOffset(e,t){return eE.resolve(ev.min())}getMinOffsetFromCollectionGroup(e,t){return eE.resolve(ev.min())}updateCollectionGroup(e,t,n){return eE.resolve()}updateIndexEntries(e,t){return eE.resolve()}}class sa{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tK(J.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tK(J.comparator)).toArray()}}let so="IndexedDbIndexManager",sl=new Uint8Array(0);class su{constructor(e,t){this.databaseId=t,this.vn=new sa,this.Fn=new rl(e=>nH(e),(e,t)=>nY(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.vn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.vn.add(t)});let i={collectionId:n,parent:e$(r)};return tF(e,tl).put(i)}return eE.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tF(e,tl).J(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eK(r.parent))}return n})}addFieldIndex(e,t){let n=tF(e,tf),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tF(e,tg);return i.next(e=>{n.put(iQ(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tF(e,tf),r=tF(e,tg),i=tF(e,tv);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tF(e,tf),n=tF(e,tv),r=tF(e,tg);return t.Z().next(()=>n.Z()).next(()=>r.Z())}createTargetIndexes(e,t){return eE.forEach(this.Mn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new i9(t).Dn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tF(e,tv),r=!0,i=new Map;return eE.forEach(this.Mn(t),t=>this.xn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=rp(),r=[];return eE.forEach(i,(i,s)=>{b(so,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nH(t)}`);let a=function(e,t){let n=ed(t);if(void 0===n)return null;for(let t of nZ(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of ef(t))for(let t of nZ(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of ef(t)){let t=0===i.kind?n0(e,i.fieldPath,e.startAt):n1(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nD(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of ef(t)){let t=0===i.kind?n1(e,i.fieldPath,e.endAt):n0(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nD(n,r)}(s,i),c=this.On(i,s,l),h=this.On(i,s,u),d=this.Nn(i,s,o),f=this.Bn(i.indexId,a,c,l.inclusive,h,u.inclusive,d);return eE.forEach(f,i=>n.Y(i,t.limit).next(t=>{t.forEach(t=>{let n=X.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return eE.resolve(null)})}Mn(e){let t=this.Fn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(D(t instanceof nM||t instanceof nV,34018),t instanceof nM)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nV.create(n,t.op);return st(r=si(r))?r:(D(r instanceof nV,64498),D(nO(r),40251),D(r.filters.length>1,57927),r.filters.reduce((e,t)=>sn(e,t)))}(function e(t){if(D(t instanceof nM||t instanceof nV,20012),t instanceof nM){if(t instanceof nG){let e=t.value.arrayValue?.values?.map(e=>nM.create(t.field,"==",e))||[];return nV.create(e,"or")}return t}let n=t.filters.map(t=>e(t));return nV.create(n,t.op)}(e));return D(st(t),7391),i7(t)||se(t)?[t]:t.getFilters()})(nV.create(e.filters,"and")).map(t=>nJ(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Fn.set(e,t)),t}Bn(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let c=0;c<o;++c){let o=t?this.Ln(t[c/l]):sl,h=this.kn(e,o,n[c%l],r),d=this.qn(e,o,i[c%l],s),f=a.map(t=>this.kn(e,o,t,!0));u.push(...this.createRange(h,d,f))}return u}kn(e,t,n,r){let i=new i5(e,X.empty(),t,n);return r?i:i.An()}qn(e,t,n,r){let i=new i5(e,X.empty(),t,n);return r?i.An():i}xn(e,t){let n=new i9(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.yn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.Mn(t);return eE.forEach(r,t=>this.xn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tK(Y.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}Qn(e,t){let n=new i2;for(let r of ef(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.Pn(r.kind);iY.Kt.Dt(e,i)}return n.un()}Ln(e){let t=new i2;return iY.Kt.Dt(e,t.Pn(0)),t.un()}$n(e,t){let n=new i2;return iY.Kt.Dt(nm(this.databaseId,t),n.Pn(function(e){let t=ef(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.un()}Nn(e,t,n){if(null===n)return[];let r=[];r.push(new i2);let i=0;for(let s of ef(e)){let e=n[i++];for(let n of r)if(this.Un(t,s.fieldPath)&&np(e))r=this.Kn(r,s,e);else{let t=n.Pn(s.kind);iY.Kt.Dt(e,t)}}return this.Wn(r)}On(e,t,n){return this.Nn(e,t,n.position)}Wn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].un();return t}Kn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new i2;r.seed(n.un()),iY.Kt.Dt(e,r.Pn(t.kind)),i.push(r)}return i}Un(e,t){return!!e.filters.find(e=>e instanceof nM&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tF(e,tf),r=tF(e,tg);return(t?n.J(tm,IDBKeyRange.bound(t,t)):n.J()).next(e=>{let t=[];return eE.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new ep(t.sequenceNumber,new ev(iU(t.readTime),new X(eK(t.documentKey)),t.largestBatchId)):ep.empty(),r=e.fields.map(([e,t])=>new eg(Y.fromServerFormat(e),t));return new eh(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:$(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tF(e,tf),i=tF(e,tg);return this.Gn(e).next(e=>r.J(tm,IDBKeyRange.bound(t,t)).next(t=>eE.forEach(t,t=>i.put(iQ(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return eE.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?eE.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),eE.forEach(i,n=>this.zn(e,t,n).next(t=>{let i=this.jn(r,n);return t.isEqual(i)?eE.resolve():this.Jn(e,r,n,t,i)}))))})}Hn(e,t,n,r){return tF(e,tv).put(r.Rn(this.uid,this.$n(n,t.key),t.key))}Yn(e,t,n,r){return tF(e,tv).delete(r.Vn(this.uid,this.$n(n,t.key),t.key))}zn(e,t,n){let r=tF(e,tv),i=new tK(i4);return r.ee({index:t_,range:IDBKeyRange.only([n.indexId,this.uid,i3(this.$n(n,t))])},(e,r)=>{i=i.add(new i5(n.indexId,t,i8(r.arrayValue),i8(r.directionalValue)))}).next(()=>i)}jn(e,t){let n=new tK(i4),r=this.Qn(t,e);if(null==r)return n;let i=ed(t);if(null!=i){let s=e.data.field(i.fieldPath);if(np(s))for(let i of s.arrayValue.values||[])n=n.add(new i5(t.indexId,e.key,this.Ln(i),r))}else n=n.add(new i5(t.indexId,e.key,sl,r));return n}Jn(e,t,n,r,i){b(so,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tj(s),l=tj(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tj(a)):t?(i(o),o=tj(s)):(o=tj(s),l=tj(a))}}(r,i,i4,r=>{s.push(this.Hn(e,t,n,r))},r=>{s.push(this.Yn(e,t,n,r))}),eE.waitFor(s)}Gn(e){let t=1;return tF(e,tg).ee({index:ty,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>i4(e,t)).filter((e,t,n)=>!t||0!==i4(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=i4(i,e),s=i4(i,t);if(0===n)r[0]=e.An();else if(n>0&&s<0)r.push(i),r.push(i.An());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Zn(r[e],r[e+1]))return[];let t=r[e].Vn(this.uid,sl,X.empty()),n=r[e+1].Vn(this.uid,sl,X.empty());i.push(IDBKeyRange.bound(t,n))}return i}Zn(e,t){return i4(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(sc)}getMinOffset(e,t){return eE.mapArray(this.Mn(t),t=>this.xn(e,t).next(e=>e||x(44426))).next(sc)}}function sc(e){D(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>eI(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ev(t.readTime,t.documentKey,n)}let sh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class sd{static withCacheSize(e){return new sd(e,sd.DEFAULT_COLLECTION_PERCENTILE,sd.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function sf(e,t,n){let r=e.store(eJ),i=e.store(e0),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.ee({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{D(1===o,47070,{batchId:n.batchId})}));let u=[];for(let e of n.mutations){var c,h;let r=(c=e.key.path,h=n.batchId,[t,e$(c),h]);s.push(i.delete(r)),u.push(e.key)}return eE.waitFor(s).next(()=>u)}function sm(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x(14731);t=e.noDocument}return JSON.stringify(t).length}sd.DEFAULT_COLLECTION_PERCENTILE=10,sd.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,sd.DEFAULT=new sd(0x2800000,sd.DEFAULT_COLLECTION_PERCENTILE,sd.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),sd.DISABLED=new sd(-1,0,0);class sg{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Xn={}}static wt(e,t,n,r){return D(""!==e.uid,64387),new sg(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,-1/0],[this.userId,1/0]);return sy(e).ee({index:eY,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tF(e,e0),s=sy(e);return s.add({}).next(a=>{D("number"==typeof a,49019);let o=new rj(a,t,n,r),l=function(e,t,n){let r=n.baseMutations.map(t=>ix(e.yt,t)),i=n.mutations.map(t=>ix(e.yt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,o),u=[],c=new tK((e,t)=>$(e.canonicalString(),t.canonicalString()));for(let e of r){var h,d;let t=(h=this.userId,d=e.key.path,[h,e$(d),a]);c=c.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eZ))}return c.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Xn[a]=o.keys()}),eE.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return sy(e).get(t).next(e=>e?(D(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iB(this.serializer,e)):null)}er(e,t){return this.Xn[t]?eE.resolve(this.Xn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Xn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return sy(e).ee({index:eY,range:r},(e,t,r)=>{t.userId===this.userId&&(D(t.batchId>=n,47524,{tr:n}),i=iB(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,1/0]),n=-1;return sy(e).ee({index:eY,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,1/0]);return sy(e).J(eY,t).next(e=>e.map(e=>iB(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,e$(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tF(e,e0).ee({range:r},(n,r,s)=>{let[a,o,l]=n,u=eK(o);if(a===this.userId&&t.path.isEqual(u))return sy(e).get(l).next(e=>{if(!e)throw x(61480,{nr:n,batchId:l});D(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(iB(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tK($),r=[];return t.forEach(t=>{let i=[this.userId,e$(t.path)],s=IDBKeyRange.lowerBound(i),a=tF(e,e0).ee({range:s},(e,r,i)=>{let[s,a,o]=e,l=eK(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),eE.waitFor(r).next(()=>this.rr(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,e$(n)],s=IDBKeyRange.lowerBound(i),a=new tK($);return tF(e,e0).ee({range:s},(e,t,i)=>{let[s,o,l]=e,u=eK(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.rr(e,a))}rr(e,t){let n=[],r=[];return t.forEach(t=>{r.push(sy(e).get(t).next(e=>{if(null===e)throw x(35274,{batchId:t});D(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(iB(this.serializer,e))}))}),eE.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return sf(e.le,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.ir(t.batchId)}),eE.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}ir(e){delete this.Xn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return eE.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tF(e,e0).ee({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eK(e[1]);r.push(t)}else n.done()}).next(()=>{D(0===r.length,56720,{sr:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return sp(e,this.userId,t)}_r(e){return tF(e,eW).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sp(e,t,n){let r=[t,e$(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tF(e,e0).ee({range:s,X:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function sy(e){return tF(e,eJ)}class sw{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new sw(0)}static cr(){return new sw(-1)}}class sv{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.lr(e).next(t=>{let n=new sw(t.highestTargetId);return t.highestTargetId=n.next(),this.hr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.lr(e).next(e=>ec.fromTimestamp(new eu(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.lr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.lr(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.hr(e,r)))}addTargetData(e,t){return this.Pr(e,t).next(()=>this.lr(e).next(n=>(n.targetCount+=1,this.Tr(t,n),this.hr(e,n))))}updateTargetData(e,t){return this.Pr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tF(e,e7).delete(t.targetId)).next(()=>this.lr(e)).next(t=>(D(t.targetCount>0,8065),t.targetCount-=1,this.hr(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tF(e,e7).ee((s,a)=>{let o=iz(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>eE.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tF(e,e7).ee((e,n)=>{t(iz(n))})}lr(e){return tF(e,to).get(ta).next(e=>(D(null!==e,2888),e))}hr(e,t){return tF(e,to).put(ta,t)}Pr(e,t){return tF(e,e7).put(i$(this.serializer,t))}Tr(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.lr(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nH(t),r=IDBKeyRange.bound([n,-1/0],[n,1/0]),i=null;return tF(e,e7).ee({range:r,index:te},(e,n,r)=>{let s=iz(n);nY(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=sI(e);return t.forEach(t=>{let s=e$(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),eE.waitFor(r)}removeMatchingKeys(e,t,n){let r=sI(e);return eE.forEach(t,t=>{let i=e$(t.path);return eE.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=sI(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=sI(e),i=rp();return r.ee({range:n,X:!0},(e,t,n)=>{let r=new X(eK(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=e$(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return sI(e).ee({index:ti,X:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}At(e,t){return tF(e,e7).get(t).next(e=>e?iz(e):null)}}function sI(e){return tF(e,tn)}let s_="LruGarbageCollector";function sb([e,t],[n,r]){let i=$(e,n);return 0===i?$(t,r):i}class sT{constructor(e){this.Ir=e,this.buffer=new tK(sb),this.Er=0}dr(){return++this.Er}Ar(e){let t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>sb(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sE{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Vr(e){b(s_,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ek(e)?b(s_,"Ignoring IndexedDB error during garbage collection: ",e):await eT(e)}await this.Vr(3e5)})}}class sS{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return eE.resolve(eq.ce);let n=new sT(t);return this.mr.forEachTarget(e,e=>n.Ar(e.sequenceNumber)).next(()=>this.mr.pr(e,e=>n.Ar(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.mr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(b("LruGarbageCollector","Garbage collection skipped; disabled"),eE.resolve(sh)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(b("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),sh):this.yr(e,t))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let n,r,i,s,a,o,l,c=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(b("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&b("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-c}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-c}ms`),eE.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sx{constructor(e,t){this.db=e,this.garbageCollector=new sS(this,t)}gr(e){let t=this.wr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pr(e,t){return this.Sr(e,(e,n)=>t(n))}addReference(e,t,n){return sN(e,n)}removeReference(e,t,n){return sN(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sN(e,t)}br(e,t){let n;return n=!1,tF(e,eW).te(r=>sp(e,r,t).next(e=>(e&&(n=!0),eE.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.Sr(e,(s,a)=>{if(a<=t){let t=this.br(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,ec.min()),sI(e).delete([0,e$(s.path)])))});r.push(t)}}).next(()=>eE.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sN(e,t)}Sr(e,t){let n=sI(e),r,i=eq.ce;return n.ee({index:ti},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==eq.ce&&t(new X(eK(r)),i),i=a,r=s):i=eq.ce}).next(()=>{i!==eq.ce&&t(new X(eK(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sN(e,t){var n;return sI(e).put((n=e.currentSequenceNumber,{targetId:0,path:e$(t.path),sequenceNumber:n}))}class sD{constructor(){this.changes=new rl(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nN.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?eE.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sC{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tF(e,e1).put(n)}removeEntry(e,t,n){return tF(e,e1).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],iL(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.Dr(e,n)))}getEntry(e,t){let n=nN.newInvalidDocument(t);return tF(e,e1).ee({index:e5,range:IDBKeyRange.only(sk(t))},(e,r)=>{n=this.Cr(t,r)}).next(()=>n)}vr(e,t){let n={size:0,document:nN.newInvalidDocument(t)};return tF(e,e1).ee({index:e5,range:IDBKeyRange.only(sk(t))},(e,r)=>{n={document:this.Cr(t,r),size:sm(r)}}).next(()=>n)}getEntries(e,t){let n=ru;return this.Fr(e,t,(e,t)=>{let r=this.Cr(e,t);n=n.insert(e,r)}).next(()=>n)}Mr(e,t){let n=ru,r=new tB(X.comparator);return this.Fr(e,t,(e,t)=>{let i=this.Cr(e,t);n=n.insert(e,i),r=r.insert(e,sm(t))}).next(()=>({documents:n,Or:r}))}Fr(e,t,n){if(t.isEmpty())return eE.resolve();let r=new tK(sM);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sk(r.first()),sk(r.last())),s=r.getIterator(),a=s.getNext();return tF(e,e1).ee({index:e5,range:i},(e,t,r)=>{let i=X.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sM(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.j(sk(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),iL(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tF(e,e1).J(IDBKeyRange.bound(a,o,!0)).next(e=>{i?.incrementDocumentReadCount(e.length);let n=ru;for(let i of e){let e=this.Cr(X.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(rs(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=ru,s=sR(t,n),a=sR(t,ev.max());return tF(e,e1).ee({index:e6,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.Cr(X.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sA(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tF(e,e8).get(e9).next(e=>(D(!!e,20021),e))}Dr(e,t){return tF(e,e8).put(e9,t)}Cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=iS(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=X.fromSegments(t.noDocument.path),r=iU(t.noDocument.readTime);n=nN.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return x(56709);{let e=X.fromSegments(t.unknownDocument.path),r=iU(t.unknownDocument.version);n=nN.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new eu(e[0],e[1]);return ec.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(ec.min())))return e}return nN.newInvalidDocument(e)}}class sA extends sD{constructor(e,t){super(),this.Nr=e,this.trackRemovals=t,this.Br=new rl(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tK((e,t)=>$(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Br.get(i);if(t.push(this.Nr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iP(this.Nr.serializer,s);r=r.add(i.path.popLast());let l=sm(o);n+=l-a.size,t.push(this.Nr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=iP(this.Nr.serializer,s.convertToNoDocument(ec.min()));t.push(this.Nr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Nr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Nr.updateMetadata(e,n)),eE.waitFor(t)}getFromCache(e,t){return this.Nr.vr(e,t).next(e=>(this.Br.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Nr.Mr(e,t).next(({documents:e,Or:t})=>(t.forEach((t,n)=>{this.Br.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sk(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sR(e,t){let n=t.documentKey.path.toArray();return[e,iL(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sM(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=$(n[e],r[e]))return i;return(i=$(n.length,r.length))||(i=$(n[n.length-2],r[r.length-2]))||$(n[n.length-1],r[r.length-1])}class sV{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sO{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rP(n.mutation,e,tQ.empty(),eu.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rp()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rp()){let r=rf();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rh();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=rf();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rp()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=ru,s=rf(),a=rf();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rU)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rP(a.mutation,t,a.mutation.getFieldMask(),eu.now())):s.set(t.key,tQ.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>a.set(e,new sV(t,s.get(e)??null))),a))}recalculateAndSaveOverlays(e,t){let n=rf(),r=new tB((e,t)=>e-t),i=rp();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tQ.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||rp()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=rf();l.forEach(e=>{if(!i.has(e)){let r=rF(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return eE.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return X.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):n6(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):eE.resolve(rf()),a=-1,o=i;return s.next(t=>eE.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?eE.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,rp())).next(e=>({batchId:a,changes:rd(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new X(t)).next(e=>{let t=rh();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=rh();return this.indexManager.getCollectionParents(e,i).next(a=>eE.forEach(a,a=>{let o=new n2(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,nN.newInvalidDocument(r)))});let n=rh();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rP(s.mutation,r,tQ.empty(),eu.now()),rs(t,r)&&(n=n.insert(e,r))}),n})}}class sF{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return eE.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,{id:t.id,version:t.version,createTime:im(t.createTime)}),eE.resolve()}getNamedQuery(e,t){return eE.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,{name:t.name,query:iK(t.bundledQuery),readTime:im(t.readTime)}),eE.resolve()}}class sP{constructor(){this.overlays=new tB(X.comparator),this.qr=new Map}getOverlay(e,t){return eE.resolve(this.overlays.get(t))}getOverlays(e,t){let n=rf();return eE.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.St(e,t,r)}),eE.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.qr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.qr.delete(n)),eE.resolve()}getOverlaysForCollection(e,t,n){let r=rf(),i=t.length+1,s=new X(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return eE.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tB((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rf(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=rf(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return eE.resolve(a)}St(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.qr.get(r.largestBatchId).delete(n.key);this.qr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rW(t,n));let i=this.qr.get(t);void 0===i&&(i=rp(),this.qr.set(t,i)),this.qr.set(t,i.add(n.key))}}class sL{constructor(){this.sessionToken=tH.EMPTY_BYTE_STRING}getSessionToken(e){return eE.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,eE.resolve()}}class sq{constructor(){this.Qr=new tK(sU.$r),this.Ur=new tK(sU.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){let n=new sU(e,t);this.Qr=this.Qr.add(n),this.Ur=this.Ur.add(n)}Wr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Gr(new sU(e,t))}zr(e,t){e.forEach(e=>this.removeReference(e,t))}jr(e){let t=new X(new J([])),n=new sU(t,e),r=new sU(t,e+1),i=[];return this.Ur.forEachInRange([n,r],e=>{this.Gr(e),i.push(e.key)}),i}Jr(){this.Qr.forEach(e=>this.Gr(e))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){let t=new X(new J([])),n=new sU(t,e),r=new sU(t,e+1),i=rp();return this.Ur.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sU(e,0),n=this.Qr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sU{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return X.comparator(e.key,t.key)||$(e.Yr,t.Yr)}static Kr(e,t){return $(e.Yr,t.Yr)||X.comparator(e.key,t.key)}}class sB{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new tK(sU.$r)}checkEmpty(e){return eE.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rj(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Zr=this.Zr.add(new sU(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return eE.resolve(s)}lookupMutationBatch(e,t){return eE.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.ei(t+1),r=n<0?0:n;return eE.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return eE.resolve(0===this.mutationQueue.length?-1:this.tr-1)}getAllMutationBatches(e){return eE.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sU(t,0),r=new sU(t,1/0),i=[];return this.Zr.forEachInRange([n,r],e=>{let t=this.Xr(e.Yr);i.push(t)}),eE.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tK($);return t.forEach(e=>{let t=new sU(e,0),r=new sU(e,1/0);this.Zr.forEachInRange([t,r],e=>{n=n.add(e.Yr)})}),eE.resolve(this.ti(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;X.isDocumentKey(i)||(i=i.child(""));let s=new sU(new X(i),0),a=new tK($);return this.Zr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Yr)),!0)},s),eE.resolve(this.ti(a))}ti(e){let t=[];return e.forEach(e=>{let n=this.Xr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){D(0===this.ni(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Zr;return eE.forEach(t.mutations,r=>{let i=new sU(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Zr=n})}ir(e){}containsKey(e,t){let n=new sU(t,0),r=this.Zr.firstAfterOrEqual(n);return eE.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,eE.resolve()}ni(e,t){return this.ei(e)}ei(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Xr(e){let t=this.ei(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sz{constructor(e){this.ri=e,this.docs=new tB(X.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.ri(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return eE.resolve(n?n.document.mutableCopy():nN.newInvalidDocument(t))}getEntries(e,t){let n=ru;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nN.newInvalidDocument(e))}),eE.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=ru,s=t.path,a=new X(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=eI(ew(a),n)||(r.has(a.key)||rs(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return eE.resolve(i)}getAllFromCollectionGroup(e,t,n,r){x(9500)}ii(e,t){return eE.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new s$(this)}getSize(e){return eE.resolve(this.size)}}class s$ extends sD{constructor(e){super(),this.Nr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Nr.addEntry(e,r)):this.Nr.removeEntry(n)}),eE.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}}class sK{constructor(e){this.persistence=e,this.si=new rl(e=>nH(e),nY),this.lastRemoteSnapshotVersion=ec.min(),this.highestTargetId=0,this.oi=0,this._i=new sq,this.targetCount=0,this.ai=sw.ur()}forEachTarget(e,t){return this.si.forEach((e,n)=>t(n)),eE.resolve()}getLastRemoteSnapshotVersion(e){return eE.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return eE.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),eE.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.oi&&(this.oi=t),eE.resolve()}Pr(e){this.si.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.ai=new sw(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,eE.resolve()}updateTargetData(e,t){return this.Pr(t),eE.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,eE.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.si.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.si.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),eE.waitFor(i).next(()=>r)}getTargetCount(e){return eE.resolve(this.targetCount)}getTargetData(e,t){let n=this.si.get(t)||null;return eE.resolve(n)}addMatchingKeys(e,t,n){return this._i.Wr(t,n),eE.resolve()}removeMatchingKeys(e,t,n){this._i.zr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),eE.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),eE.resolve()}getMatchingKeysForTargetId(e,t){let n=this._i.Hr(t);return eE.resolve(n)}containsKey(e,t){return eE.resolve(this._i.containsKey(t))}}class sG{constructor(e,t){this.ui={},this.overlays={},this.ci=new eq(0),this.li=!1,this.li=!0,this.hi=new sL,this.referenceDelegate=e(this),this.Pi=new sK(this),this.indexManager=new ss,this.remoteDocumentCache=new sz(e=>this.referenceDelegate.Ti(e)),this.serializer=new iF(t),this.Ii=new sF(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sP,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.ui[e.toKey()];return n||(n=new sB(t,this.referenceDelegate),this.ui[e.toKey()]=n),n}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,n){b("MemoryPersistence","Starting transaction:",e);let r=new sj(this.ci.next());return this.referenceDelegate.Ei(),n(r).next(e=>this.referenceDelegate.di(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ai(e,t){return eE.or(Object.values(this.ui).map(n=>()=>n.containsKey(e,t)))}}class sj extends eb{constructor(e){super(),this.currentSequenceNumber=e}}class sQ{constructor(e){this.persistence=e,this.Ri=new sq,this.Vi=null}static mi(e){return new sQ(e)}get fi(){if(this.Vi)return this.Vi;throw x(60996)}addReference(e,t,n){return this.Ri.addReference(n,t),this.fi.delete(n.toString()),eE.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.fi.add(n.toString()),eE.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),eE.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach(e=>this.fi.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.fi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ei(){this.Vi=new Set}di(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return eE.forEach(this.fi,n=>{let r=X.fromPath(n);return this.gi(e,r).next(e=>{e||t.removeEntry(r,ec.min())})}).next(()=>(this.Vi=null,t.apply(e)))}updateLimboDocument(e,t){return this.gi(e,t).next(e=>{e?this.fi.delete(t.toString()):this.fi.add(t.toString())})}Ti(e){return 0}gi(e,t){return eE.or([()=>eE.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}class sW{constructor(e,t){this.persistence=e,this.pi=new rl(e=>e$(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sS(this,t)}static mi(e,t){return new sW(e,t)}Ei(){}di(e){return eE.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){let t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}pr(e,t){return eE.forEach(this.pi,(n,r)=>this.br(e,n,r).next(e=>e?eE.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.ii(e,r=>this.br(e,r,t).next(e=>{e||(n++,i.removeEntry(r,ec.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),eE.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),eE.resolve()}removeReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),eE.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),eE.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(no(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=t3(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return t0(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tL(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw x(13486,{value:t})}}(e.data.value)),t}br(e,t,n){return eE.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.pi.get(t);return eE.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sJ{constructor(e){this.serializer=e}k(e,t,n,r){let i=new ex("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore(ej),e.createObjectStore(eW,{keyPath:"userId"}),e.createObjectStore(eJ,{keyPath:eH,autoIncrement:!0}).createIndex(eY,eX,{unique:!0}),e.createObjectStore(e0),sH(e),e.createObjectStore(eG));let s=eE.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(tn),e.deleteObjectStore(e7),e.deleteObjectStore(to),sH(e)),s=s.next(()=>(function(e){let t=e.store(to),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ec.min().toTimestamp(),targetCount:0};return t.put(ta,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eJ).J().next(t=>{e.deleteObjectStore(eJ),e.createObjectStore(eJ,{keyPath:eH,autoIncrement:!0}).createIndex(eY,eX,{unique:!0});let n=i.store(eJ),r=t.map(e=>n.put(e));return eE.waitFor(r)}))),s=s.next(()=>{e.createObjectStore(tc,{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this.yi(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore(e8),this.wi(i)))),n<7&&r>=7&&(s=s.next(()=>this.Si(i))),n<8&&r>=8&&(s=s.next(()=>this.bi(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.Di(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore(th,{keyPath:"bundleId"}),e.createObjectStore(td,{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t=e.createObjectStore(tT,{keyPath:tE});t.createIndex(tS,tx,{unique:!1}),t.createIndex(tN,tD,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(e1,{keyPath:e2});t.createIndex(e5,e4),t.createIndex(e6,e3)})(e)).next(()=>this.Ci(e,i)).next(()=>e.deleteObjectStore(eG))),n<14&&r>=14&&(s=s.next(()=>this.Fi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(tf,{keyPath:"indexId",autoIncrement:!0}).createIndex(tm,"collectionGroup",{unique:!1}),e.createObjectStore(tg,{keyPath:tp}).createIndex(ty,tw,{unique:!1}),e.createObjectStore(tv,{keyPath:tI}).createIndex(t_,tb,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(tg).clear()}).next(()=>{t.objectStore(tv).clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore(tC,{keyPath:"name"})})),n<18&&r>=18&&(0,c.Ov)()&&(s=s.next(()=>{t.objectStore(tg).clear()}).next(()=>{t.objectStore(tv).clear()})),s}wi(e){let t=0;return e.store(eG).ee((e,n)=>{t+=sm(n)}).next(()=>{let n={byteSize:t};return e.store(e8).put(e9,n)})}yi(e){let t=e.store(eW),n=e.store(eJ);return t.J().next(t=>eE.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.J(eY,r).next(n=>eE.forEach(n,n=>{D(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});let r=iB(this.serializer,n);return sf(e,t.userId,r).next(()=>{})}))}))}Si(e){let t=e.store(tn),n=e.store(eG);return e.store(to).get(ta).next(e=>{let r=[];return n.ee((n,i)=>{let s=new J(n),a=[0,e$(s)];r.push(t.get(a).next(n=>n?eE.resolve():t.put({targetId:0,path:e$(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>eE.waitFor(r))})}bi(e,t){e.createObjectStore(tl,{keyPath:tu});let n=t.store(tl),r=new sa,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:e$(r)})}};return t.store(eG).ee({X:!0},(e,t)=>i(new J(e).popLast())).next(()=>t.store(e0).ee({X:!0},([e,t,n],r)=>i(eK(t).popLast())))}Di(e){let t=e.store(e7);return t.ee((e,n)=>{let r=iz(n),i=i$(this.serializer,r);return t.put(i)})}Ci(e,t){let n=t.store(eG),r=[];return n.ee((e,n)=>{let i=t.store(e1),s=(n.document?new X(J.fromString(n.document.name).popFirst(5)):n.noDocument?X.fromSegments(n.noDocument.path):n.unknownDocument?X.fromSegments(n.unknownDocument.path):x(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>eE.waitFor(r))}Fi(e,t){let n=t.store(eJ),r=new sC(this.serializer),i=new sG(sQ.mi,this.serializer.yt);return n.J().next(e=>{let n=new Map;return e.forEach(e=>{let t=n.get(e.userId)??rp();iB(this.serializer,e).keys().forEach(e=>t=t.add(e)),n.set(e.userId,t)}),eE.forEach(n,(e,n)=>{let s=new y(n),a=iJ.wt(this.serializer,s),o=i.getIndexManager(s);return new sO(r,sg.wt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tO(t,eq.ce),e).next()})})}}function sH(e){e.createObjectStore(tn,{keyPath:tr}).createIndex(ti,ts,{unique:!0}),e.createObjectStore(e7,{keyPath:"targetId"}).createIndex(te,tt,{unique:!0}),e.createObjectStore(to)}let sY="IndexedDbPersistence",sX="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",sZ="main";class s0{constructor(e,t,n,r,i,s,a,o,l,u,c=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Mi=i,this.window=s,this.document=a,this.xi=l,this.Oi=u,this.Ni=c,this.ci=null,this.li=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Bi=null,this.inForeground=!1,this.Li=null,this.ki=null,this.qi=-1/0,this.Qi=e=>Promise.resolve(),!s0.v())throw new k(A.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sx(this,r),this.$i=t+sZ,this.serializer=new iF(o),this.Ui=new eN(this.$i,this.Ni,new sJ(this.serializer)),this.hi=new iH,this.Pi=new sv(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sC(this.serializer),this.Ii=new iW,this.window&&this.window.localStorage?this.Ki=this.window.localStorage:(this.Ki=null,!1===u&&T(sY,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(A.FAILED_PRECONDITION,sX);return this.Gi(),this.zi(),this.ji(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Pi.getHighestSequenceNumber(e))}).then(e=>{this.ci=new eq(e,this.xi)}).then(()=>{this.li=!0}).catch(e=>(this.Ui&&this.Ui.close(),Promise.reject(e)))}Ji(e){return this.Qi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ui.$(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Mi.enqueueAndForget(async()=>{this.started&&await this.Wi()}))}Wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tF(e,tc).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Hi(e).next(e=>{e||(this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)))})}).next(()=>this.Yi(e)).next(t=>this.isPrimary&&!t?this.Zi(e).next(()=>!1):!!t&&this.Xi(e).next(()=>!0))).catch(e=>{if(ek(e))return b(sY,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return b(sY,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Mi.enqueueRetryable(()=>this.Qi(e)),this.isPrimary=e})}Hi(e){return tF(e,ej).get(eQ).next(e=>eE.resolve(this.es(e)))}ts(e){return tF(e,tc).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.rs(this.qi,18e5)){this.qi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tF(e,tc);return t.J().next(e=>{let n=this.ss(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return eE.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ki)for(let t of e)this.Ki.removeItem(this._s(t.clientId))}}ji(){this.ki=this.Mi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Wi().then(()=>this.ns()).then(()=>this.ji()))}es(e){return!!e&&e.ownerId===this.clientId}Yi(e){return this.Oi?eE.resolve(!0):tF(e,ej).get(eQ).next(t=>{if(null!==t&&this.rs(t.leaseTimestampMs,5e3)&&!this.us(t.ownerId)){if(this.es(t)&&this.networkEnabled)return!0;if(!this.es(t)){if(!t.allowTabSynchronization)throw new k(A.FAILED_PRECONDITION,sX);return!1}}return!(!this.networkEnabled||!this.inForeground)||tF(e,tc).J().next(e=>void 0===this.ss(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&b(sY,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.li=!1,this.cs(),this.ki&&(this.ki.cancel(),this.ki=null),this.ls(),this.hs(),await this.Ui.runTransaction("shutdown","readwrite",[ej,tc],e=>{let t=new tO(e,eq.ce);return this.Zi(t).next(()=>this.ts(t))}),this.Ui.close(),this.Ps()}ss(e,t){return e.filter(e=>this.rs(e.updateTimeMs,t)&&!this.us(e.clientId))}Ts(){return this.runTransaction("getActiveClients","readonly",e=>tF(e,tc).J().next(e=>this.ss(e,18e5).map(e=>e.clientId)))}get started(){return this.li}getGlobalsCache(){return this.hi}getMutationQueue(e,t){return sg.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new su(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return iJ.wt(this.serializer,e)}getBundleCache(){return this.Ii}runTransaction(e,t,n){var r;let i;b(sY,"Starting transaction:",e);let s=18===(r=this.Ni)||17===r?tV:16===r||15===r?tM:14===r||13===r?tR:12===r?tk:11===r?tA:void x(60245);return this.Ui.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tO(r,this.ci?this.ci.next():eq.ce),"readwrite-primary"===t?this.Hi(i).next(e=>!!e||this.Yi(i)).next(t=>{if(!t)throw T(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)),new k(A.FAILED_PRECONDITION,e_);return n(i)}).next(e=>this.Xi(i).next(()=>e)):this.Is(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Is(e){return tF(e,ej).get(eQ).next(e=>{if(null!==e&&this.rs(e.leaseTimestampMs,5e3)&&!this.us(e.ownerId)&&!this.es(e)&&!(this.Oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new k(A.FAILED_PRECONDITION,sX)})}Xi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tF(e,ej).put(eQ,t)}static v(){return eN.v()}Zi(e){let t=tF(e,ej);return t.get(eQ).next(e=>this.es(e)?(b(sY,"Releasing primary lease."),t.delete(eQ)):eE.resolve())}rs(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(T(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Li=()=>{this.Mi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Wi()))},this.document.addEventListener("visibilitychange",this.Li),this.inForeground="visible"===this.document.visibilityState)}ls(){this.Li&&(this.document.removeEventListener("visibilitychange",this.Li),this.Li=null)}zi(){"function"==typeof this.window?.addEventListener&&(this.Bi=()=>{this.cs();let e=/(?:Version|Mobile)\/1[456]/;(0,c.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Mi.enterRestrictedMode(!0),this.Mi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Bi))}hs(){this.Bi&&(this.window.removeEventListener("pagehide",this.Bi),this.Bi=null)}us(e){try{let t=null!==this.Ki?.getItem(this._s(e));return b(sY,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return T(sY,"Failed to get zombied client id.",e),!1}}cs(){if(this.Ki)try{this.Ki.setItem(this._s(this.clientId),String(Date.now()))}catch(e){T("Failed to set zombie client id.",e)}}Ps(){if(this.Ki)try{this.Ki.removeItem(this._s(this.clientId))}catch(e){}}_s(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function s1(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class s2{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Es=n,this.ds=r}static As(e,t){let n=rp(),r=rp();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new s2(e,t.fromCache,n,r)}}class s5{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class s4{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=(0,c.nr)()?8:eD((0,c.ZQ)())>0?6:4}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.ys(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ws(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new s5;return this.Ss(e,t,n).next(r=>{if(i.result=r,this.Vs)return this.bs(e,t,n,r.size)})}).next(()=>i.result)}bs(e,t,n,r){return n.documentReadCount<this.fs?(I()<=u.$b.DEBUG&&b("QueryEngine","SDK will not create cache indexes for query:",ri(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),eE.resolve()):(I()<=u.$b.DEBUG&&b("QueryEngine","Query:",ri(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.gs*r?(I()<=u.$b.DEBUG&&b("QueryEngine","The SDK decides to create cache indexes for query:",ri(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,n8(t))):eE.resolve())}ys(e,t){if(n4(t))return eE.resolve(null);let n=n8(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=n8(t=rt(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=rp(...r);return this.ps.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.Ds(t,r);return this.Cs(t,s,i,n.readTime)?this.ys(e,rt(t,null,"F")):this.vs(e,s,t,n)}))})))}ws(e,t,n,r){return n4(t)||r.isEqual(ec.min())?eE.resolve(null):this.ps.getDocuments(e,n).next(i=>{let s=this.Ds(t,i);return this.Cs(t,s,n,r)?eE.resolve(null):(I()<=u.$b.DEBUG&&b("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ri(t)),this.vs(e,s,t,ey(r,-1)).next(e=>e))})}Ds(e,t){let n=new tK(ro(e));return t.forEach((t,r)=>{rs(e,r)&&(n=n.add(r))}),n}Cs(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ss(e,t,n){return I()<=u.$b.DEBUG&&b("QueryEngine","Using full collection scan to execute query:",ri(t)),this.ps.getDocumentsMatchingQuery(e,t,ev.min(),n)}vs(e,t,n,r){return this.ps.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let s6="LocalStore";class s3{constructor(e,t,n,r){this.persistence=e,this.Fs=t,this.serializer=r,this.Ms=new tB($),this.xs=new rl(e=>nH(e),nY),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(n)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sO(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}}async function s8(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.Bs(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=rp();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Ls:e,removedBatchIds:i,addedBatchIds:s}))})})}function s9(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Pi.getLastRemoteSnapshotVersion(t))}function s7(e,t,n){let r=rp(),i=rp();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=ru;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(ec.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):b(s6,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{ks:r,qs:i}})}function ae(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Pi.getTargetData(n,t).next(i=>i?(r=i,eE.resolve(r)):e.Pi.allocateTargetId(n).next(i=>(r=new iO(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Pi.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.Ms.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.Ms=e.Ms.insert(n.targetId,n),e.xs.set(t,n.targetId)),n})}async function at(e,t,n){let r=e.Ms.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!ek(e))throw e;b(s6,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ms=e.Ms.remove(t),e.xs.delete(r.target)}function an(e,t,n){let r=ec.min(),i=rp();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.xs.get(n);return void 0!==r?eE.resolve(e.Ms.get(r)):e.Pi.getTargetData(t,n)})(e,s,n8(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Pi.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Fs.getDocumentsMatchingQuery(s,t,n?r:ec.min(),n?i:rp())).next(n=>(as(e,ra(t),n),{documents:n,Qs:i})))}function ar(e,t){let n=e.Pi,r=e.Ms.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.At(e,t).next(e=>e?e.target:null))}function ai(e,t){let n=e.Os.get(t)||ec.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.Ns.getAllFromCollectionGroup(r,t,ey(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(as(e,t,n),n))}function as(e,t,n){let r=e.Os.get(t)||ec.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Os.set(t,r)}async function aa(e,t,n,r){let i=rp(),s=ru;for(let e of n){let n=t.$s(e.metadata.name);e.document&&(i=i.add(n));let r=t.Us(e);r.setReadTime(t.Ks(e.metadata.readTime)),s=s.insert(n,r)}let a=e.Ns.newChangeBuffer({trackRemovals:!0}),o=await ae(e,n8(n5(J.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>s7(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Pi.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Pi.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.ks,n.qs)).next(()=>n.ks)))}async function ao(e,t,n=rp()){let r=await ae(e,n8(iK(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=im(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Ii.saveNamedQuery(i,t);let a=r.withResumeToken(tH.EMPTY_BYTE_STRING,s);return e.Ms=e.Ms.insert(a.targetId,a),e.Pi.updateTargetData(i,a).next(()=>e.Pi.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Pi.addMatchingKeys(i,n,r.targetId)).next(()=>e.Ii.saveNamedQuery(i,t))})}let al="firestore_clients";function au(e,t){return`${al}_${e}_${t}`}let ac="firestore_mutations";function ah(e,t,n){let r=`${ac}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let ad="firestore_targets";function af(e,t){return`${ad}_${e}_${t}`}let am="SharedClientState";class ag{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ws(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new k(r.error.code,r.error.message)),s?new ag(e,t,r.state,i):(T(am,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ap{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ws(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new k(n.error.code,n.error.message)),i?new ap(e,n.state,r):(T(am,`Failed to parse target state for ID '${e}': ${t}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ay{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ws(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=ry;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ez(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new ay(e,i):(T(am,`Failed to parse client data for instance '${e}': ${t}`),null)}}class aw{constructor(e,t){this.clientId=e,this.onlineState=t}static Ws(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new aw(t.clientId,t.onlineState):(T(am,`Failed to parse online state: ${e}`),null)}}class av{constructor(){this.activeTargetIds=ry}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class aI{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Mi=t,this.persistenceKey=n,this.Js=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Hs=this.Ys.bind(this),this.Zs=new tB($),this.started=!1,this.Xs=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.eo=au(this.persistenceKey,this.Js),this.no=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Zs=this.Zs.insert(this.Js,new av),this.ro=RegExp(`^${al}_${l}_([^_]*)$`),this.io=RegExp(`^${ac}_${l}_(\\d+)(?:_(.*))?$`),this.so=RegExp(`^${ad}_${l}_(\\d+)$`),this.oo=(a=this.persistenceKey,`firestore_online_state_${a}`),this._o=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Hs)}static v(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Ts())){if(e===this.Js)continue;let t=this.getItem(au(this.persistenceKey,e));if(t){let n=ay.Ws(e,t);n&&(this.Zs=this.Zs.insert(n.clientId,n))}}this.ao();let e=this.storage.getItem(this.oo);if(e){let t=this.uo(e);t&&this.co(t)}for(let e of this.Xs)this.Ys(e);this.Xs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.no,JSON.stringify(e))}getAllActiveQueryTargets(){return this.lo(this.Zs)}isActiveQueryTarget(e){let t=!1;return this.Zs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.ho(e,"pending")}updateMutationState(e,t,n){this.ho(e,t,n),this.Po(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(af(this.persistenceKey,e));if(t){let r=ap.Ws(e,t);r&&(n=r.state)}}return t&&this.To.zs(e),this.ao(),n}removeLocalQueryTarget(e){this.To.js(e),this.ao()}isLocalQueryTarget(e){return this.To.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(af(this.persistenceKey,e))}updateQueryState(e,t,n){this.Io(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Po(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Eo(e)}notifyBundleLoaded(e){this.Ao(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Hs),this.removeItem(this.eo),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return b(am,"READ",e,t),t}setItem(e,t){b(am,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){b(am,"REMOVE",e),this.storage.removeItem(e)}Ys(e){if(e.storageArea===this.storage){if(b(am,"EVENT",e.key,e.newValue),e.key===this.eo)return void T("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Mi.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.ro.test(e.key)){if(null==e.newValue){let t=this.Ro(e.key);return this.Vo(t,null)}{let t=this.mo(e.key,e.newValue);if(t)return this.Vo(t.clientId,t)}}else if(this.io.test(e.key)){if(null!==e.newValue){let t=this.fo(e.key,e.newValue);if(t)return this.po(t)}}else if(this.so.test(e.key)){if(null!==e.newValue){let t=this.yo(e.key,e.newValue);if(t)return this.wo(t)}}else if(e.key===this.oo){if(null!==e.newValue){let t=this.uo(e.newValue);if(t)return this.co(t)}}else if(e.key===this.no){let t=function(e){let t=eq.ce;if(null!=e)try{let n=JSON.parse(e);D("number"==typeof n,30636,{So:e}),t=n}catch(e){T(am,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eq.ce&&this.sequenceNumberHandler(t)}else if(e.key===this._o){let t=this.bo(e.newValue);await Promise.all(t.map(e=>this.syncEngine.Do(e)))}}}else this.Xs.push(e)})}}get To(){return this.Zs.get(this.Js)}ao(){this.setItem(this.eo,this.To.Gs())}ho(e,t,n){let r=new ag(this.currentUser,e,t,n),i=ah(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Gs())}Po(e){let t=ah(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Eo(e){let t={clientId:this.Js,onlineState:e};this.storage.setItem(this.oo,JSON.stringify(t))}Io(e,t,n){let r=af(this.persistenceKey,e),i=new ap(e,t,n);this.setItem(r,i.Gs())}Ao(e){let t=JSON.stringify(Array.from(e));this.setItem(this._o,t)}Ro(e){let t=this.ro.exec(e);return t?t[1]:null}mo(e,t){let n=this.Ro(e);return ay.Ws(n,t)}fo(e,t){let n=this.io.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return ag.Ws(new y(i),r,t)}yo(e,t){let n=Number(this.so.exec(e)[1]);return ap.Ws(n,t)}uo(e){return aw.Ws(e)}bo(e){return JSON.parse(e)}async po(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);b(am,`Ignoring mutation for non-active user ${e.user.uid}`)}wo(e){return this.syncEngine.vo(e.targetId,e.state,e.error)}Vo(e,t){let n=t?this.Zs.insert(e,t):this.Zs.remove(e),r=this.lo(this.Zs),i=this.lo(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Fo(s,a).then(()=>{this.Zs=n})}co(e){this.Zs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}lo(e){let t=ry;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class a_{constructor(){this.Mo=new av,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,n){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new av,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ab{Oo(e){}shutdown(){}}let aT="ConnectivityMonitor";class aE{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){for(let e of(b(aT,"Network connectivity changed: AVAILABLE"),this.qo))e(0)}ko(){for(let e of(b(aT,"Network connectivity changed: UNAVAILABLE"),this.qo))e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let aS=null;function ax(){return null===aS?aS=0x10000000+Math.round(0x80000000*Math.random()):aS++,"0x"+aS.toString(16)}let aN="RestConnection",aD={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class aC{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${n}/databases/${r}`,this.Wo=this.databaseId.database===t7?`project_id=${n}`:`project_id=${n}&database_id=${r}`}Go(e,t,n,r,i){let s=ax(),a=this.zo(e,t.toUriEncodedString());b(aN,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(o,r,i);let{host:l}=new URL(a),u=(0,c.zJ)(l);return this.Jo(e,a,o,n,u).then(t=>(b(aN,`Received RPC '${e}' ${s}: `,t),t),t=>{throw E(aN,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Ho(e,t,n,r,i,s){return this.Go(e,t,n,r,i)}jo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}zo(e,t){let n=aD[e];return`${this.Uo}/v1/${t}:${n}`}terminate(){}}class aA{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}}let ak="WebChannelConnection";class aR extends aC{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,n,r,i){let s=ax();return new Promise((i,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();b(ak,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case d.O4.TIMEOUT:b(ak,`RPC '${e}' ${s} timed out`),a(new k(A.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(b(ak,`RPC '${e}' ${s} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=e?.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(A).indexOf(t)>=0?t:A.UNKNOWN}(t.status);a(new k(e,t.message))}else a(new k(A.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new k(A.UNAVAILABLE,"Connection failed."));break;default:x(9055,{l_:e,streamId:s,h_:o.getLastErrorCode(),P_:o.getLastError()})}}finally{b(ak,`RPC '${e}' ${s} completed.`)}});let l=JSON.stringify(r);b(ak,`RPC '${e}' ${s} sending request:`,r),o.send(t,"POST",l,n,15)})}T_(e,t,n){let i=ax(),s=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.jo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let c=s.join("");b(ak,`Creating RPC '${e}' stream ${i}: ${c}`,l);let h=a.createWebChannel(c,l);this.I_(h);let f=!1,m=!1,g=new aA({Yo:t=>{m?b(ak,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(b(ak,`Opening RPC '${e}' stream ${i} transport.`),h.open(),f=!0),b(ak,`RPC '${e}' stream ${i} sending:`,t),h.send(t))},Zo:()=>h.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(h,d.iO.EventType.OPEN,()=>{m||(b(ak,`RPC '${e}' stream ${i} transport opened.`),g.o_())}),p(h,d.iO.EventType.CLOSE,()=>{m||(m=!0,b(ak,`RPC '${e}' stream ${i} transport closed`),g.a_(),this.E_(h))}),p(h,d.iO.EventType.ERROR,t=>{m||(m=!0,E(ak,`RPC '${e}' stream ${i} transport errored. Name:`,t.name,"Message:",t.message),g.a_(new k(A.UNAVAILABLE,"The operation could not be completed")))}),p(h,d.iO.EventType.MESSAGE,t=>{if(!m){let n=t.data[0];D(!!n,16349);let s=n?.error||n[0]?.error;if(s){b(ak,`RPC '${e}' stream ${i} received error:`,s);let t=s.status,n=function(e){let t=r[e];if(void 0!==t)return rX(t)}(t),a=s.message;void 0===n&&(n=A.INTERNAL,a="Unknown error status: "+t+" with message "+s.message),m=!0,g.a_(new k(n,a)),h.close()}else b(ak,`RPC '${e}' stream ${i} received:`,n),g.u_(n)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?b(ak,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&b(ak,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.__()},0),g}terminate(){this.c_.forEach(e=>e.close()),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter(t=>t===e)}}function aM(){return"undefined"!=typeof window?window:null}function aV(){return"undefined"!=typeof document?document:null}function aO(e){return new iu(e,!0)}class aF{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Mi=e,this.timerId=t,this.d_=n,this.A_=r,this.R_=i,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();let t=Math.floor(this.V_+this.y_()),n=Math.max(0,Date.now()-this.f_),r=Math.max(0,t-n);r>0&&b("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,r,()=>(this.f_=Date.now(),e())),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}}let aP="PersistentStream";class aL{constructor(e,t,n,r,i,s,a,o){this.Mi=e,this.S_=n,this.b_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new aF(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,()=>this.k_()))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===A.RESOURCE_EXHAUSTED?(T(t.toString()),T("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===A.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;let e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.D_===t&&this.G_(e,n)},t=>{e(()=>{let e=new k(A.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){let n=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo(()=>{n(()=>this.listener.Xo())}),this.stream.t_(()=>{n(()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.t_()))}),this.stream.r_(e=>{n(()=>this.z_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.F_?this.J_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return b(aP,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget(()=>this.D_===e?t():(b(aP,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aq extends aL{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:x(39313,{state:r}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(D(void 0===i||"string"==typeof i,58123),tH.fromBase64String(i||"")):(D(void 0===i||i instanceof m||i instanceof Uint8Array,16193),tH.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new ie(s,a,o,l&&new k(void 0===l.code?A.UNKNOWN:rX(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=iv(e,r.document.name),s=im(r.document.updateTime),a=r.document.createTime?im(r.document.createTime):ec.min(),o=new nx({mapValue:{fields:r.document.fields}}),l=nN.newFoundDocument(i,s,a,o);n=new r9(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=iv(e,r.document),s=r.readTime?im(r.readTime):ec.min(),a=nN.newNoDocument(i,s);n=new r9([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=iv(e,r.document);n=new r9([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x(11601,{Rt:t});{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rH(r,i);n=new r7(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return ec.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?ec.min():t.readTime?im(t.readTime):ec.min()}(e);return this.listener.H_(t,n)}Y_(e){let t={};t.database=ib(this.serializer),t.addTarget=function(e,t){let n,r=t.target;if((n=nX(r)?{documents:iD(e,r)}:{query:iC(e,r).ft}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=id(e,t.resumeToken);let r=ic(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(ec.min())>0){n.readTime=ih(e,t.snapshotVersion.toTimestamp());let r=ic(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.q_(t)}Z_(e){let t={};t.database=ib(this.serializer),t.removeTarget=e,this.q_(t)}}class aU extends aL{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return D(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,D(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){var t,n;D(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(D(void 0!==n,14353),t.map(e=>{let t;return(t=e.updateTime?im(e.updateTime):im(n)).isEqual(ec.min())&&(t=im(n)),new rR(t,e.transformResults||[])})):[]),i=im(e.commitTime);return this.listener.na(i,r)}ra(){let e={};e.database=ib(this.serializer),this.q_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ix(this.serializer,e))};this.q_(t)}}class aB{}class az extends aB{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.ia=!1}sa(){if(this.ia)throw new k(A.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,n,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Go(e,ip(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===A.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new k(A.UNKNOWN,e.toString())})}Ho(e,t,n,r,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Ho(e,ip(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===A.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new k(A.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class a${constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(T(t),this.aa=!1):b("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}let aK="RemoteStore";class aG{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=i,this.Aa.Oo(e=>{n.enqueueAndForget(async()=>{a0(this)&&(b(aK,"Restarting streams for network reachability change."),await async function(e){e.Ea.add(4),await aQ(e),e.Ra.set("Unknown"),e.Ea.delete(4),await aj(e)}(this))})}),this.Ra=new a$(n,r)}}async function aj(e){if(a0(e))for(let t of e.da)await t(!0)}async function aQ(e){for(let t of e.da)await t(!1)}function aW(e,t){e.Ia.has(t.targetId)||(e.Ia.set(t.targetId,t),aZ(e)?aX(e):oa(e).O_()&&aH(e,t))}function aJ(e,t){let n=oa(e);e.Ia.delete(t),n.O_()&&aY(e,t),0===e.Ia.size&&(n.O_()?n.L_():a0(e)&&e.Ra.set("Unknown"))}function aH(e,t){if(e.Va.Ue(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(ec.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}oa(e).Y_(t)}function aY(e,t){e.Va.Ue(t),oa(e).Z_(t)}function aX(e){e.Va=new ir({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),oa(e).start(),e.Ra.ua()}function aZ(e){return a0(e)&&!oa(e).x_()&&e.Ia.size>0}function a0(e){return 0===e.Ea.size}async function a1(e){e.Ra.set("Online")}async function a2(e){e.Ia.forEach((t,n)=>{aH(e,t)})}async function a5(e,t){e.Va=void 0,aZ(e)?(e.Ra.ha(t),aX(e)):e.Ra.set("Unknown")}async function a4(e,t,n){if(e.Ra.set("Online"),t instanceof ie&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.Ia.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ia.delete(r),e.Va.removeTarget(r))}(e,t)}catch(n){b(aK,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await a6(e,n)}else if(t instanceof r9?e.Va.Ze(t):t instanceof r7?e.Va.st(t):e.Va.tt(t),!n.isEqual(ec.min()))try{let t=await s9(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.Va.Tt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.Ia.get(r);i&&e.Ia.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.Ia.get(t);if(!r)return;e.Ia.set(t,r.withResumeToken(tH.EMPTY_BYTE_STRING,r.snapshotVersion)),aY(e,t);let i=new iO(r.target,t,n,r.sequenceNumber);aH(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){b(aK,"Failed to raise snapshot:",t),await a6(e,t)}}async function a6(e,t,n){if(!ek(t))throw t;e.Ea.add(1),await aQ(e),e.Ra.set("Offline"),n||(n=()=>s9(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{b(aK,"Retrying IndexedDB access"),await n(),e.Ea.delete(1),await aj(e)})}function a3(e,t){return t().catch(n=>a6(e,n,t))}async function a8(e){var t;let n=oo(e),r=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:-1;for(;a0(t=e)&&t.Ta.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.Ta.length&&n.L_();break}r=t.batchId,function(e,t){e.Ta.push(t);let n=oo(e);n.O_()&&n.X_&&n.ea(t.mutations)}(e,t)}catch(t){await a6(e,t)}a9(e)&&a7(e)}function a9(e){return a0(e)&&!oo(e).x_()&&e.Ta.length>0}function a7(e){oo(e).start()}async function oe(e){oo(e).ra()}async function ot(e){let t=oo(e);for(let n of e.Ta)t.ea(n.mutations)}async function on(e,t,n){let r=e.Ta.shift(),i=rQ.from(r,t,n);await a3(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await a8(e)}async function or(e,t){t&&oo(e).X_&&await async function(e,t){var n;if(rY(n=t.code)&&n!==A.ABORTED){let n=e.Ta.shift();oo(e).B_(),await a3(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await a8(e)}}(e,t),a9(e)&&a7(e)}async function oi(e,t){e.asyncQueue.verifyOperationInProgress(),b(aK,"RemoteStore received new credentials");let n=a0(e);e.Ea.add(3),await aQ(e),n&&e.Ra.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ea.delete(3),await aj(e)}async function os(e,t){t?(e.Ea.delete(2),await aj(e)):t||(e.Ea.add(2),await aQ(e),e.Ra.set("Unknown"))}function oa(e){var t,n,r;return e.ma||(t=e.datastore,n=e.asyncQueue,r={Xo:a1.bind(null,e),t_:a2.bind(null,e),r_:a5.bind(null,e),H_:a4.bind(null,e)},t.sa(),e.ma=new aq(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.da.push(async t=>{t?(e.ma.B_(),aZ(e)?aX(e):e.Ra.set("Unknown")):(await e.ma.stop(),e.Va=void 0)})),e.ma}function oo(e){var t,n,r;return e.fa||(t=e.datastore,n=e.asyncQueue,r={Xo:()=>Promise.resolve(),t_:oe.bind(null,e),r_:or.bind(null,e),ta:ot.bind(null,e),na:on.bind(null,e)},t.sa(),e.fa=new aU(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.da.push(async t=>{t?(e.fa.B_(),await a8(e)):(await e.fa.stop(),e.Ta.length>0&&(b(aK,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class ol{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new R,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new ol(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new k(A.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ou(e,t){if(T("AsyncQueue",`${t}: ${e}`),ek(e))return new k(A.UNAVAILABLE,`${t}: ${e}`);throw e}class oc{static emptySet(e){return new oc(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||X.comparator(t.key,n.key):(e,t)=>X.comparator(e.key,t.key),this.keyedMap=rh(),this.sortedSet=new tB(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof oc)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new oc;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class oh{constructor(){this.ga=new tB(X.comparator)}track(e){let t=e.doc.key,n=this.ga.get(t);n?0!==e.type&&3===n.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==n.type?this.ga=this.ga.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.ga=this.ga.remove(t):1===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):x(63341,{Rt:e,pa:n}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,n)=>{e.push(n)}),e}}class od{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new od(e,t,oc.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class of{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some(e=>e.Da())}}class om{constructor(){this.queries=og(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=og(),n.forEach((e,n)=>{for(let e of n.Sa)e.onError(t)})}(this,new k(A.ABORTED,"Firestore shutting down"))}}function og(){return new rl(e=>rr(e),rn)}async function op(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.ba()&&t.Da()&&(n=2):(i=new of,n=+!t.Da());try{switch(n){case 0:i.wa=await e.onListen(r,!0);break;case 1:i.wa=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=ou(n,`Initialization of query '${ri(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.Sa.push(t),t.va(e.onlineState),i.wa&&t.Fa(i.wa)&&oI(e)}async function oy(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?r=+!t.Da():!i.ba()&&t.Da()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function ow(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.Sa)e.Fa(r)&&(n=!0);i.wa=r}}n&&oI(e)}function ov(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.Sa)e.onError(n);e.queries.delete(t)}function oI(e){e.Ca.forEach(e=>{e.next()})}(a=s||(s={})).Ma="default",a.Cache="cache";class o_{constructor(e,t,n){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=n||{}}Fa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new od(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){return!(e.fromCache&&this.Da())||(!this.options.qa||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=od.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==s.Cache}}class ob{constructor(e,t){this.Qa=e,this.byteLength=t}$a(){return"metadata"in this.Qa}}class oT{constructor(e){this.serializer=e}$s(e){return iv(this.serializer,e)}Us(e){return e.metadata.exists?iS(this.serializer,e.document,!1):nN.newNoDocument(this.$s(e.metadata.name),this.Ks(e.metadata.readTime))}Ks(e){return im(e)}}class oE{constructor(e,t){this.Ua=e,this.serializer=t,this.Ka=[],this.Wa=[],this.collectionGroups=new Set,this.progress=oS(e)}get queries(){return this.Ka}get documents(){return this.Wa}Ga(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Qa.namedQuery)this.Ka.push(e.Qa.namedQuery);else if(e.Qa.documentMetadata){this.Wa.push({metadata:e.Qa.documentMetadata}),e.Qa.documentMetadata.exists||++t;let n=J.fromString(e.Qa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Qa.document&&(this.Wa[this.Wa.length-1].document=e.Qa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,{...this.progress}):null}za(e){let t=new Map,n=new oT(this.serializer);for(let r of e)if(r.metadata.queries){let e=n.$s(r.metadata.name);for(let n of r.metadata.queries){let r=(t.get(n)||rp()).add(e);t.set(n,r)}}return t}async ja(e){let t=await aa(e,new oT(this.serializer),this.Wa,this.Ua.id),n=this.za(this.documents);for(let t of this.Ka)await ao(e,t,n.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Ja:this.collectionGroups,Ha:t}}}function oS(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class ox{constructor(e){this.key=e}}class oN{constructor(e){this.key=e}}class oD{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=rp(),this.mutatedKeys=rp(),this.eu=ro(e),this.tu=new oc(this.eu)}get nu(){return this.Ya}ru(e,t){let n=t?t.iu:new oh,r=t?t.tu:this.tu,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),c=rs(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!c&&(c.hasLocalMutations||this.mutatedKeys.has(c.key)&&c.hasCommittedMutations),f=!1;u&&c?u.data.isEqual(c.data)?h!==d&&(n.track({type:3,doc:c}),f=!0):this.su(u,c)||(n.track({type:2,doc:c}),f=!0,(o&&this.eu(c,o)>0||l&&0>this.eu(c,l))&&(a=!0)):!u&&c?(n.track({type:0,doc:c}),f=!0):u&&!c&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(c?(s=s.add(c),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{tu:s,iu:n,Cs:a,mutatedKeys:i}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let s=e.iu.ya();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x(20277,{Rt:e})}};return n(e)-n(t)})(e.type,t.type)||this.eu(e.doc,t.doc)),this.ou(n),r=r??!1;let a=t&&!r?this._u():[],o=0===this.Xa.size&&this.current&&!r?1:0,l=o!==this.Za;return(this.Za=o,0!==s.length||l)?{snapshot:new od(this.query,e.tu,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),au:a}:{au:a}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new oh,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Ya=this.Ya.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ya=this.Ya.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Xa;this.Xa=rp(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Xa=this.Xa.add(e.key))});let t=[];return e.forEach(e=>{this.Xa.has(e)||t.push(new oN(e))}),this.Xa.forEach(n=>{e.has(n)||t.push(new ox(n))}),t}cu(e){this.Ya=e.Qs,this.Xa=rp();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return od.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Za,this.hasCachedResults)}}let oC="SyncEngine";class oA{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class ok{constructor(e){this.key=e,this.hu=!1}}class oR{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Pu={},this.Tu=new rl(e=>rr(e),rn),this.Iu=new Map,this.Eu=new Set,this.du=new tB(X.comparator),this.Au=new Map,this.Ru=new sq,this.Vu={},this.mu=new Map,this.fu=sw.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function oM(e,t,n=!0){let r,i=le(e),s=i.Tu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.lu()):r=await oO(i,t,n,!0),r}async function oV(e,t){let n=le(e);await oO(n,t,!0,!1)}async function oO(e,t,n,r){let i,s=await ae(e.localStore,n8(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await oF(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aW(e.remoteStore,s),i}async function oF(e,t,n,r,i){e.pu=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ru(n);i.Cs&&(i=await an(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oH(e,t.targetId,o.au),o.snapshot})(e,t,n,r);let s=await an(e.localStore,t,!0),a=new oD(t,s.Qs),o=a.ru(s.documents),l=r8.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oH(e,n,u.au);let c=new oA(t,n,a);return e.Tu.set(t,c),e.Iu.has(n)?e.Iu.get(n).push(t):e.Iu.set(n,[t]),u.snapshot}async function oP(e,t,n){let r=e.Tu.get(t),i=e.Iu.get(r.targetId);if(i.length>1)return e.Iu.set(r.targetId,i.filter(e=>!rn(e,t))),void e.Tu.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await at(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aJ(e.remoteStore,r.targetId),oW(e,r.targetId)}).catch(eT)):(oW(e,r.targetId),await at(e.localStore,r.targetId,!0))}async function oL(e,t){let n=e.Tu.get(t),r=e.Iu.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aJ(e.remoteStore,n.targetId))}async function oq(e,t,n){let r=lt(e);try{var i;let e,s=await function(e,t){let n,r,i=eu.now(),s=t.reduce((e,t)=>e.add(t.key),rp());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=ru,l=rp();return e.Ns.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rb(r.transform,e||null);null!=i&&(null===n&&(n=nx.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rU(e.key,t,function e(t){let n=[];return tL(t.fields,(t,r)=>{let i=new Y([t]);if(nv(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tQ(n)}(t.value.mapValue),rM.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:rd(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Vu[r.currentUser.toKey()])||(e=new tB($)),e=e.insert(i,n),r.Vu[r.currentUser.toKey()]=e,await oX(r,s.changes),await a8(r.remoteStore)}catch(t){let e=ou(t,"Failed to persist write");n.reject(e)}}async function oU(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.Ms;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.Ns.newChangeBuffer({trackRemovals:!0});r=e.Ms;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Pi.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Pi.addMatchingKeys(i,s.addedDocuments,o)));let c=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?c=c.withResumeToken(tH.EMPTY_BYTE_STRING,ec.min()).withLastLimboFreeSnapshotVersion(ec.min()):s.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(s.resumeToken,n)),r=r.insert(o,c),l=c,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Pi.updateTargetData(i,c))});let o=ru,l=rp();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(s7(i,s,t.documentUpdates).next(e=>{o=e.ks,l=e.qs})),!n.isEqual(ec.min())){let t=e.Pi.getLastRemoteSnapshotVersion(i).next(t=>e.Pi.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return eE.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ms=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Au.get(n);r&&(D(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?r.hu=!0:t.modifiedDocuments.size>0?D(r.hu,14607):t.removedDocuments.size>0&&(D(r.hu,42227),r.hu=!1))}),await oX(e,n,t)}catch(e){await eT(e)}}function oB(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.Tu.forEach((e,n)=>{let r=n.view.va(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.Sa)e.va(t)&&(n=!0)}),n&&oI(r),i.length&&e.Pu.H_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oz(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Au.get(t),i=r&&r.key;if(i){let n=new tB(X.comparator);n=n.insert(i,nN.newNoDocument(i,ec.min()));let r=rp().add(i),s=new r3(ec.min(),new Map,new tB($),n,r);await oU(e,s),e.du=e.du.remove(i),e.Au.delete(t),oY(e)}else await at(e.localStore,t,!1).then(()=>oW(e,t,n)).catch(eT)}async function o$(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.Ns.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=eE.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);D(null!==s,48541),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=rp();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))}));oQ(e,r,null),oj(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oX(e,i)}catch(e){await eT(e)}}async function oK(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(D(null!==t,37113),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));oQ(e,t,n),oj(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oX(e,i)}catch(e){await eT(e)}}async function oG(e,t){var n;a0(e.remoteStore)||b(oC,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=await (n=e.localStore).persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>n.mutationQueue.getHighestUnacknowledgedBatchId(e));if(-1===r)return void t.resolve();let i=e.mu.get(r)||[];i.push(t),e.mu.set(r,i)}catch(n){let e=ou(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function oj(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function oQ(e,t,n){let r=e.Vu[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Vu[e.currentUser.toKey()]=r}}function oW(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Iu.get(t)))e.Tu.delete(r),n&&e.Pu.yu(r,n);e.Iu.delete(t),e.isPrimaryClient&&e.Ru.jr(t).forEach(t=>{e.Ru.containsKey(t)||oJ(e,t)})}function oJ(e,t){e.Eu.delete(t.path.canonicalString());let n=e.du.get(t);null!==n&&(aJ(e.remoteStore,n),e.du=e.du.remove(t),e.Au.delete(n),oY(e))}function oH(e,t,n){for(let r of n)r instanceof ox?(e.Ru.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.du.get(n)||e.Eu.has(r)||(b(oC,"New document in limbo: "+n),e.Eu.add(r),oY(e))}(e,r)):r instanceof oN?(b(oC,"Document no longer in limbo: "+r.key),e.Ru.removeReference(r.key,t),e.Ru.containsKey(r.key)||oJ(e,r.key)):x(19791,{wu:r})}function oY(e){for(;e.Eu.size>0&&e.du.size<e.maxConcurrentLimboResolutions;){let t=e.Eu.values().next().value;e.Eu.delete(t);let n=new X(J.fromString(t)),r=e.fu.next();e.Au.set(r,new ok(n)),e.du=e.du.insert(n,r),aW(e.remoteStore,new iO(n8(n5(n.path)),r,"TargetPurposeLimboResolution",eq.ce))}}async function oX(e,t,n){let r=[],i=[],s=[];e.Tu.isEmpty()||(e.Tu.forEach((a,o)=>{s.push(e.pu(o,t,n).then(t=>{if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:n?.targetChanges.get(o.targetId)?.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=s2.As(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Pu.H_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>eE.forEach(t,t=>eE.forEach(t.Es,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>eE.forEach(t.ds,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!ek(e))throw e;b(s6,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.Ms.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.Ms=e.Ms.insert(t,i)}}}(e.localStore,i))}async function oZ(e,t){if(!e.currentUser.isEqual(t)){b(oC,"User change. New user:",t.toKey());let n=await s8(e.localStore,t);e.currentUser=t,e.mu.forEach(e=>{e.forEach(e=>{e.reject(new k(A.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.mu.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await oX(e,n.Ls)}}function o0(e,t){let n=e.Au.get(t);if(n&&n.hu)return rp().add(n.key);{let n=rp(),r=e.Iu.get(t);if(!r)return n;for(let t of r){let r=e.Tu.get(t);n=n.unionWith(r.view.nu)}return n}}async function o1(e,t){let n=await an(e.localStore,t.query,!0),r=t.view.cu(n);return e.isPrimaryClient&&oH(e,t.targetId,r.au),r}async function o2(e,t){return ai(e.localStore,t).then(t=>oX(e,t))}async function o5(e,t,n,r){var i;let s=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.er(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):eE.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await a8(e.remoteStore):"acknowledged"===n||"rejected"===n?(oQ(e,t,r||null),oj(e,t),i=e.localStore,i.mutationQueue.ir(t)):x(6720,"Unknown batchState",{Su:n}),await oX(e,s)):b(oC,"Cannot apply mutation batch with id: "+t)}async function o4(e,t){if(le(e),lt(e),!0===t&&!0!==e.gu){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await o6(e,t.toArray());for(let t of(e.gu=!0,await os(e.remoteStore,!0),n))aW(e.remoteStore,t)}else if(!1===t&&!1!==e.gu){let t=[],n=Promise.resolve();e.Iu.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(oW(e,i),at(e.localStore,i,!0))),aJ(e.remoteStore,i)}),await n,await o6(e,t),e.Au.forEach((t,n)=>{aJ(e.remoteStore,n)}),e.Ru.Jr(),e.Au=new Map,e.du=new tB(X.comparator),e.gu=!1,await os(e.remoteStore,!1)}}async function o6(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.Iu.get(n);if(s&&0!==s.length)for(let n of(t=await ae(e.localStore,n8(s[0])),s)){let t=e.Tu.get(n),r=await o1(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await ar(e.localStore,n);t=await ae(e.localStore,r),await oF(e,o3(r),n,!1,t.resumeToken)}r.push(t)}return e.Pu.H_(i),r}function o3(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new n2(t,n,r,i,s,"F",e.startAt,e.endAt)}function o8(e){return e.localStore.persistence.Ts()}async function o9(e,t,n,r){if(e.gu)return void b(oC,"Ignoring unexpected query state notification.");let i=e.Iu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await ai(e.localStore,ra(i[0])),s=r3.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tH.EMPTY_BYTE_STRING);await oX(e,r,s);break}case"rejected":await at(e.localStore,t,!0),oW(e,t,r);break;default:x(64155,n)}}async function o7(e,t,n){let r=le(e);if(r.gu){for(let e of t){if(r.Iu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){b(oC,"Adding an already active target "+e);continue}let t=await ar(r.localStore,e),n=await ae(r.localStore,t);await oF(r,o3(t),n.targetId,!1,n.resumeToken),aW(r.remoteStore,n)}for(let e of n)r.Iu.has(e)&&await at(r.localStore,e,!1).then(()=>{aJ(r.remoteStore,e),oW(r,e)}).catch(eT)}}function le(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oU.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=o0.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oz.bind(null,e),e.Pu.H_=ow.bind(null,e.eventManager),e.Pu.yu=ov.bind(null,e.eventManager),e}function lt(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=o$.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=oK.bind(null,e),e}class ln{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aO(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){var t,n;return t=this.persistence,n=new s4,new s3(t,n,e.initialUser,this.serializer)}Cu(e){return new sG(sQ.mi,this.serializer)}Du(e){return new a_}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ln.provider={build:()=>new ln};class lr extends ln{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){return D(this.persistence.referenceDelegate instanceof sW,46915),new sE(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e){let t=void 0!==this.cacheSizeBytes?sd.withCacheSize(this.cacheSizeBytes):sd.DEFAULT;return new sG(e=>sW.mi(e,t),this.serializer)}}class li extends ln{constructor(e,t,n){super(),this.xu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xu.initialize(this,e),await lt(this.xu.syncEngine),await a8(this.xu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}vu(e){var t,n;return t=this.persistence,n=new s4,new s3(t,n,e.initialUser,this.serializer)}Fu(e,t){return new sE(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Mu(e,t){let n=new eL(t,this.persistence);return new eP(e.asyncQueue,n)}Cu(e){let t=s1(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?sd.withCacheSize(this.cacheSizeBytes):sd.DEFAULT;return new s0(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,aM(),aV(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Du(e){return new a_}}class ls extends li{constructor(e,t){super(e,t,!1),this.xu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.xu.syncEngine;this.sharedClientState instanceof aI&&(this.sharedClientState.syncEngine={Co:o5.bind(null,t),vo:o9.bind(null,t),Fo:o7.bind(null,t),Ts:o8.bind(null,t),Do:o2.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ji(async e=>{await o4(this.xu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Du(e){let t=aM();if(!aI.v(t))throw new k(A.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=s1(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new aI(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class la{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oB(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oZ.bind(null,this.syncEngine),await os(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new om}createDatastore(e){var t;let n=aO(e.databaseInfo.databaseId),r=new aR(e.databaseInfo);return t=e.authCredentials,new az(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new aG(t,n,e.asyncQueue,e=>oB(this.syncEngine,e,0),aE.v()?new aE:new ab)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new oR(e,t,n,r,i,s);return a&&(o.gu=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function(e){b(aK,"RemoteStore shutting down."),e.Ea.add(5),await aQ(e),e.Aa.shutdown(),e.Ra.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}function lo(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){let r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}la.provider={build:()=>new la};class ll{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):T("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class lu{constructor(e,t){this.Bu=e,this.serializer=t,this.metadata=new R,this.buffer=new Uint8Array,this.Lu=new TextDecoder("utf-8"),this.ku().then(e=>{e&&e.$a()?this.metadata.resolve(e.Qa.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(e?.Qa)}`))},e=>this.metadata.reject(e))}close(){return this.Bu.cancel()}async getMetadata(){return this.metadata.promise}async bu(){return await this.getMetadata(),this.ku()}async ku(){let e=await this.qu();if(null===e)return null;let t=this.Lu.decode(e),n=Number(t);return isNaN(n)&&this.Qu(`length string (${t}) is not valid number`),new ob(JSON.parse(await this.$u(n)),e.length+n)}Uu(){return this.buffer.findIndex(e=>123===e)}async qu(){for(;0>this.Uu()&&!await this.Ku(););if(0===this.buffer.length)return null;let e=this.Uu();e<0&&this.Qu("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $u(e){for(;this.buffer.length<e;)await this.Ku()&&this.Qu("Reached the end of bundle when more is expected.");let t=this.Lu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qu(e){throw this.Bu.cancel(),Error(`Invalid bundle format: ${e}`)}async Ku(){let e=await this.Bu.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class lc{constructor(e,t){this.bundleData=e,this.serializer=t,this.cursor=0,this.elements=[];let n=this.bu();if(!n||!n.$a())throw Error(`The first element of the bundle is not a metadata object, it is
         ${JSON.stringify(n?.Qa)}`);this.metadata=n;do null!==(n=this.bu())&&this.elements.push(n);while(null!==n)}getMetadata(){return this.metadata}Wu(){return this.elements}bu(){if(this.cursor===this.bundleData.length)return null;let e=this.qu();return new ob(JSON.parse(this.$u(e)),e)}$u(e){if(this.cursor+e>this.bundleData.length)throw new k(A.INTERNAL,"Reached the end of bundle when more is expected.");return this.bundleData.slice(this.cursor,this.cursor+=e)}qu(){let e=this.cursor,t=this.cursor;for(;t<this.bundleData.length;){if("{"===this.bundleData[t]){if(t===e)throw Error("First character is a bracket and not a number");return this.cursor=t,Number(this.bundleData.slice(e,t))}t++}throw Error("Reached the end of bundle when more is expected.")}}class lh{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(A.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>iw(e.serializer,t))},r=await e.Ho("BatchGetDocuments",e.serializer.databaseId,J.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){D(!!t.found,43571),t.found.name,t.found.updateTime;let n=iv(e,t.found.name),r=im(t.found.updateTime),i=t.found.createTime?im(t.found.createTime):ec.min(),s=new nx({mapValue:{fields:t.found.fields}});return nN.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){D(!!t.missing,3894),D(!!t.readTime,22933);let n=iv(e,t.missing),r=im(t.readTime);return nN.newNoDocument(n,r)}(n,t):x(7234,{result:t}));i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());D(!!t,55234,{key:e}),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new rK(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=X.fromPath(t);this.mutations.push(new rG(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>ix(e.serializer,t))};await e.Go("Commit",e.serializer.databaseId,J.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw x(50498,{Gu:e.constructor.name});t=ec.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new k(A.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ec.min())?rM.exists(!1):rM.updateTime(t):rM.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(ec.min()))throw new k(A.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return rM.updateTime(t)}return rM.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ld{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.zu=n.maxAttempts,this.M_=new aF(this.asyncQueue,"transaction_retry")}ju(){this.zu-=1,this.Ju()}Ju(){this.M_.p_(async()=>{let e=new lh(this.datastore),t=this.Hu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.Yu(e)}))}).catch(e=>{this.Yu(e)})})}Hu(e){try{let t=this.updateFunction(e);return!eU(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Yu(e){this.zu>0&&this.Zu(e)?(this.zu-=1,this.asyncQueue.enqueueAndForget(()=>(this.Ju(),Promise.resolve()))):this.deferred.reject(e)}Zu(e){if("FirebaseError"===e.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!rY(t)}return!1}}let lf="FirestoreClient";class lm{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=z.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{b(lf,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(b(lf,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new R;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=ou(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function lg(e,t){e.asyncQueue.verifyOperationInProgress(),b(lf,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await s8(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function lp(e,t){e.asyncQueue.verifyOperationInProgress();let n=await ly(e);b(lf,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>oi(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>oi(t.remoteStore,n)),e._onlineComponents=t}async function ly(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){b(lf,"Using user provided OfflineComponentProvider");try{await lg(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===A.FAILED_PRECONDITION||t.code===A.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;E("Error using user provided cache. Falling back to memory cache: "+t),await lg(e,new ln)}}else b(lf,"Using default OfflineComponentProvider"),await lg(e,new lr(void 0));return e._offlineComponents}async function lw(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(b(lf,"Using user provided OnlineComponentProvider"),await lp(e,e._uninitializedComponentsProvider._online)):(b(lf,"Using default OnlineComponentProvider"),await lp(e,new la))),e._onlineComponents}function lv(e){return ly(e).then(e=>e.persistence)}function lI(e){return ly(e).then(e=>e.localStore)}function l_(e){return lw(e).then(e=>e.remoteStore)}function lb(e){return lw(e).then(e=>e.syncEngine)}function lT(e){return lw(e).then(e=>e.datastore)}async function lE(e){let t=await lw(e),n=t.eventManager;return n.onListen=oM.bind(null,t.syncEngine),n.onUnlisten=oP.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=oV.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oL.bind(null,t.syncEngine),n}function lS(e,t,n={}){let r=new R;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new ll({next:o=>{s.Nu(),t.enqueueAndForget(()=>oy(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new k(A.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new k(A.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new o_(n5(n.path),s,{includeMetadataChanges:!0,qa:!0});return op(e,a)})(await lE(e),e.asyncQueue,t,n,r)),r.promise}function lx(e,t,n={}){let r=new R;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new ll({next:n=>{s.Nu(),t.enqueueAndForget(()=>oy(e,a)),n.fromCache&&"server"===r.source?i.reject(new k(A.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new o_(n,s,{includeMetadataChanges:!0,qa:!0});return op(e,a)})(await lE(e),e.asyncQueue,t,n,r)),r.promise}function lN(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let lD=new Map,lC="firestore.googleapis.com";class lA{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new k(A.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=lC,this.ssl=!0}else this.host=e.host,this.ssl=e.ssl??!0;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new k(A.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}ee("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=lN(e.experimentalLongPollingOptions??{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new k(A.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new k(A.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new k(A.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lk{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lA({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new k(A.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new k(A.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lA(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new V;switch(e.type){case"firstParty":return new L(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new k(A.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=lD.get(e);t&&(b("ComponentProvider","Removing Datastore"),lD.delete(e),t.terminate())}(this),Promise.resolve()}}function lR(e,t,n,r={}){e=es(e,lk);let i=(0,c.zJ)(t),s=e._getSettings(),a={...s,emulatorOptions:e._getEmulatorOptions()},o=`${t}:${n}`;i&&((0,c.gE)(`https://${o}`),(0,c.P1)("Firestore",!0)),s.host!==lC&&s.host!==o&&E("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l={...s,host:o,ssl:i,emulatorOptions:r};if(!(0,c.bD)(l,a)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=(0,c.Fy)(r.mockUserToken,e._app?.options.projectId);let i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new k(A.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(i)}e._authCredentials=new O(new M(t,n))}}class lM{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lM(this.firestore,e,this._query)}}class lV{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lO(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lV(this.firestore,e,this._key)}toJSON(){return{type:lV._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,n){if(el(t,lV._jsonSchema))return new lV(e,n||null,new X(J.fromString(t.referencePath)))}}lV._jsonSchemaVersion="firestore/documentReference/1.0",lV._jsonSchema={type:eo("string",lV._jsonSchemaVersion),referencePath:eo("string")};class lO extends lM{constructor(e,t,n){super(e,t,n5(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lV(this.firestore,null,new X(e))}withConverter(e){return new lO(this.firestore,e,this._path)}}function lF(e,t,...n){if(e=(0,c.Ku)(e),Z("collection","path",t),e instanceof lk){let r=J.fromString(t,...n);return en(r),new lO(e,null,r)}{if(!(e instanceof lV||e instanceof lO))throw new k(A.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(J.fromString(t,...n));return en(r),new lO(e.firestore,null,r)}}function lP(e,t){if(e=es(e,lk),Z("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new k(A.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lM(e,null,new n2(J.emptyPath(),t))}function lL(e,t,...n){if(e=(0,c.Ku)(e),1==arguments.length&&(t=z.newId()),Z("doc","path",t),e instanceof lk){let r=J.fromString(t,...n);return et(r),new lV(e,null,new X(r))}{if(!(e instanceof lV||e instanceof lO))throw new k(A.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(J.fromString(t,...n));return et(r),new lV(e.firestore,e instanceof lO?e.converter:null,new X(r))}}function lq(e,t){return e=(0,c.Ku)(e),t=(0,c.Ku)(t),(e instanceof lV||e instanceof lO)&&(t instanceof lV||t instanceof lO)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function lU(e,t){return e=(0,c.Ku)(e),t=(0,c.Ku)(t),e instanceof lM&&t instanceof lM&&e.firestore===t.firestore&&rn(e._query,t._query)&&e.converter===t.converter}let lB="AsyncQueue";class lz{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new aF(this,"async_queue_retry"),this._c=()=>{let e=aV();e&&b(lB,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;let t=aV();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=aV();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new R;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xu.push(e),this.lc()))}async lc(){if(0!==this.Xu.length){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!ek(e))throw e;b(lB,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{throw this.nc=e,this.rc=!1,T("INTERNAL UNHANDLED ERROR: ",l$(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,n){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let r=ol.createAndSchedule(this,e,t,n,e=>this.hc(e));return this.tc.push(r),r}uc(){this.nc&&x(47125,{Pc:l$(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{for(let t of(this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.tc))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}dc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}}function l$(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}function lK(e){if("object"!=typeof e||null===e)return!1;for(let t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}class lG{constructor(){this._progressObserver={},this._taskCompletionResolver=new R,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}let lj=-1;class lQ extends lk{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lz,this._persistenceKey=r?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new lz(e),this._firestoreClient=void 0,await e}}}function lW(e,t,n){n||(n=t7);let r=(0,o.j6)(e,"firestore");if(r.isInitialized(n)){let e=r.getImmediate({identifier:n}),i=r.getOptions(n);if((0,c.bD)(i,t))return e;throw new k(A.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new k(A.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new k(A.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return t.host&&(0,c.zJ)(t.host)&&(0,c.gE)(t.host),r.initialize({options:t,instanceIdentifier:n})}function lJ(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r="string"==typeof e?e:t||t7,i=(0,o.j6)(n,"firestore").getImmediate({identifier:r});if(!i._initialized){let e=(0,c.yU)("firestore");e&&lR(i,...e)}return i}function lH(e){if(e._terminated)throw new k(A.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lY(e),e._firestoreClient}function lY(e){var t,n;let r=e._freezeSettings(),i=(t=e._databaseId,n=e._app?.options.appId||"",new t9(t,n,e._persistenceKey,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,lN(r.experimentalLongPollingOptions),r.useFetchStreams,r.isUsingEmulator));e._componentsProvider||r.localCache?._offlineComponentProvider&&r.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:r.localCache._offlineComponentProvider,_online:r.localCache._onlineComponentProvider}),e._firestoreClient=new lm(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function(e){let t=e?._online.build();return{_offline:e?._offline.build(t),_online:t}}(e._componentsProvider))}function lX(e,t){E("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let n=e._freezeSettings();return l0(e,la.provider,{build:e=>new li(e,n.cacheSizeBytes,t?.forceOwnership)}),Promise.resolve()}async function lZ(e){E("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=e._freezeSettings();l0(e,la.provider,{build:e=>new ls(e,t.cacheSizeBytes)})}function l0(e,t,n){if((e=es(e,lQ))._firestoreClient||e._terminated)throw new k(A.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new k(A.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},lY(e)}function l1(e){if(e._initialized&&!e._terminated)throw new k(A.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new R;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!eN.v())return Promise.resolve();await eN.delete(e+sZ)}(s1(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}function l2(e){var t=lH(e=es(e,lQ));let n=new R;return t.asyncQueue.enqueueAndForget(async()=>oG(await lb(t),n)),n.promise}function l5(e){var t;return(t=lH(e=es(e,lQ))).asyncQueue.enqueue(async()=>{let e=await lv(t),n=await l_(t);return e.setNetworkEnabled(!0),n.Ea.delete(0),aj(n)})}function l4(e){var t;return(t=lH(e=es(e,lQ))).asyncQueue.enqueue(async()=>{let e=await lv(t),n=await l_(t);return e.setNetworkEnabled(!1),async function(e){e.Ea.add(0),await aQ(e),e.Ra.set("Offline")}(n)})}function l6(e){return(0,o.Us)(e.app,"firestore",e._databaseId.database),e._delete()}function l3(e,t){let n=lH(e=es(e,lQ)),r=new lG;return function(e,t,n,r){var i;let s=(i=aO(t),new lu(function(e,t){if(e instanceof Uint8Array)return lo(e,void 0);if(e instanceof ArrayBuffer)return lo(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?r0().encode(n):n),i));e.asyncQueue.enqueueAndForget(async()=>{var t;(async function(e,t,n){try{var r;let i=await t.getMetadata();if(await function(e,t){let n=im(t.createTime);return e.persistence.runTransaction("hasNewerBundle","readonly",n=>e.Ii.getBundleMetadata(n,t.id)).then(e=>!!e&&e.createTime.compareTo(n)>=0)}(e.localStore,i))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);n._updateProgress(oS(i));let s=new oE(i,t.serializer),a=await t.bu();for(;a;){let e=await s.Ga(a);e&&n._updateProgress(e),a=await t.bu()}let o=await s.ja(e.localStore);return await oX(e,o.Ha,void 0),await (r=e.localStore,r.persistence.runTransaction("Save bundle","readwrite",e=>r.Ii.saveBundleMetadata(e,i))),n._completeWith(o.progress),Promise.resolve(o.Ja)}catch(e){return E(oC,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(t=await lb(e),s,r).then(e=>{t.sharedClientState.notifyBundleLoaded(e)})})}(n,e._databaseId,t,r),r}function l8(e,t){var n;return(n=lH(e=es(e,lQ)),n.asyncQueue.enqueue(async()=>{var e;return e=await lI(n),e.persistence.runTransaction("Get named query","readonly",n=>e.Ii.getNamedQuery(n,t))})).then(t=>t?new lM(e,null,t.query):null)}class l9{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class l7{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class ue{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ue(tH.fromBase64String(e))}catch(e){throw new k(A.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ue(tH.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:ue._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(el(e,ue._jsonSchema))return ue.fromBase64String(e.bytes)}}ue._jsonSchemaVersion="firestore/bytes/1.0",ue._jsonSchema={type:eo("string",ue._jsonSchemaVersion),bytes:eo("string")};class ut{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new k(A.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Y(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function un(){return new ut(Q)}class ur{constructor(e){this._methodName=e}}class ui{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(A.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(A.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return $(this._lat,e._lat)||$(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:ui._jsonSchemaVersion}}static fromJSON(e){if(el(e,ui._jsonSchema))return new ui(e.latitude,e.longitude)}}ui._jsonSchemaVersion="firestore/geoPoint/1.0",ui._jsonSchema={type:eo("string",ui._jsonSchemaVersion),latitude:eo("number"),longitude:eo("number")};class us{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}toJSON(){return{type:us._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(el(e,us._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new us(e.vectorValues);throw new k(A.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}us._jsonSchemaVersion="firestore/vectorValue/1.0",us._jsonSchema={type:eo("string",us._jsonSchemaVersion),vectorValues:eo("object")};let ua=/^__.*__$/;class uo{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rU(e,this.data,this.fieldMask,t,this.fieldTransforms):new rq(e,this.data,t,this.fieldTransforms)}}class ul{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rU(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function uu(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x(40011,{Ac:e})}}class uc{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Rc(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new uc({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){let t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.gc(e),n}yc(e){let t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.Rc(),n}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return uA(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(0===e.length)throw this.Sc("Document fields must not be empty");if(uu(this.Ac)&&ua.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}}class uh{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||aO(e)}Cc(e,t,n,r=!1){return new uc({Ac:e,methodName:t,Dc:n,path:Y.emptyPath(),fc:!1,bc:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ud(e){let t=e._freezeSettings(),n=aO(e._databaseId);return new uh(e._databaseId,!!t.ignoreUndefinedProperties,n)}function uf(e,t,n,r,i,s={}){let a,o,l=e.Cc(s.merge||s.mergeFields?2:0,t,n,i);ux("Data must be an object, but it was:",l,r);let u=uE(r,l);if(s.merge)a=new tQ(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=uN(t,r,n);if(!l.contains(i))throw new k(A.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);uk(e,i)||e.push(i)}a=new tQ(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new uo(new nx(u),a,o)}class um extends ur{_toFieldTransform(e){if(2!==e.Ac)throw 1===e.Ac?e.Sc(`${this._methodName}() can only appear at the top level of your update data`):e.Sc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof um}}function ug(e,t,n){return new uc({Ac:3,Dc:t.settings.Dc,methodName:e._methodName,fc:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class up extends ur{_toFieldTransform(e){return new rk(e.path,new rT)}isEqual(e){return e instanceof up}}class uy extends ur{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=ug(this,e,!0),n=new rE(this.vc.map(e=>uT(e,t)));return new rk(e.path,n)}isEqual(e){return e instanceof uy&&(0,c.bD)(this.vc,e.vc)}}class uw extends ur{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=ug(this,e,!0),n=new rx(this.vc.map(e=>uT(e,t)));return new rk(e.path,n)}isEqual(e){return e instanceof uw&&(0,c.bD)(this.vc,e.vc)}}class uv extends ur{constructor(e,t){super(e),this.Fc=t}_toFieldTransform(e){let t=new rD(e.serializer,rI(e.serializer,this.Fc));return new rk(e.path,t)}isEqual(e){return e instanceof uv&&this.Fc===e.Fc}}function uI(e,t,n,r){let i=e.Cc(1,t,n);ux("Data must be an object, but it was:",i,r);let s=[],a=nx.empty();return tL(r,(e,r)=>{let o=uC(t,e,n);r=(0,c.Ku)(r);let l=i.yc(o);if(r instanceof um)s.push(o);else{let e=uT(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new ul(a,new tQ(s),i.fieldTransforms)}function u_(e,t,n,r,i,s){let a=e.Cc(1,t,n),o=[uN(t,r,n)],l=[i];if(s.length%2!=0)throw new k(A.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(uN(t,s[e])),l.push(s[e+1]);let u=[],h=nx.empty();for(let e=o.length-1;e>=0;--e)if(!uk(u,o[e])){let t=o[e],n=l[e];n=(0,c.Ku)(n);let r=a.yc(t);if(n instanceof um)u.push(t);else{let e=uT(n,r);null!=e&&(u.push(t),h.set(t,e))}}return new ul(h,new tQ(u),a.fieldTransforms)}function ub(e,t,n,r=!1){return uT(n,e.Cc(r?4:3,t))}function uT(e,t){if(uS(e=(0,c.Ku)(e)))return ux("Unsupported field value:",t,e),uE(e,t);if(e instanceof ur)return function(e,t){if(!uu(t.Ac))throw t.Sc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Sc(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.fc&&4!==t.Ac)throw t.Sc("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=uT(i,t.wc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){if(null===(e=(0,c.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rI(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=eu.fromDate(e);return{timestampValue:ih(t.serializer,n)}}if(e instanceof eu){let n=new eu(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ih(t.serializer,n)}}if(e instanceof ui)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ue)return{bytesValue:id(t.serializer,e._byteString)};if(e instanceof lV){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Sc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ig(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof us)return{mapValue:{fields:{[nt]:{stringValue:ni},[ns]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Sc("VectorValues must only contain numeric values.");return rw(t.serializer,e)})}}}}};throw t.Sc(`Unsupported field value: ${ei(e)}`)}(e,t)}function uE(e,t){let n={};return tU(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tL(e,(e,r)=>{let i=uT(r,t.mc(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function uS(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof eu||e instanceof ui||e instanceof ue||e instanceof lV||e instanceof ur||e instanceof us)}function ux(e,t,n){if(!uS(n)||!er(n)){let r=ei(n);throw"an object"===r?t.Sc(e+" a custom object"):t.Sc(e+" "+r)}}function uN(e,t,n){if((t=(0,c.Ku)(t))instanceof ut)return t._internalPath;if("string"==typeof t)return uC(e,t);throw uA("Field path arguments must be of type string or ",e,!1,void 0,n)}let uD=RegExp("[~\\*/\\[\\]]");function uC(e,t,n){if(t.search(uD)>=0)throw uA(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ut(...t.split("."))._internalPath}catch(r){throw uA(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function uA(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new k(A.INVALID_ARGUMENT,o+e+l)}function uk(e,t){return e.some(e=>e.isEqual(t))}class uR{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lV(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new uM(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(uV("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class uM extends uR{data(){return super.data()}}function uV(e,t){return"string"==typeof t?uC(e,t):t instanceof ut?t._internalPath:t._delegate._internalPath}function uO(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new k(A.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class uF{}class uP extends uF{}function uL(e,t,...n){let r=[];for(let i of(t instanceof uF&&r.push(t),function(e){let t=e.filter(e=>e instanceof uB).length,n=e.filter(e=>e instanceof uq).length;if(t>1||t>0&&n>0)throw new k(A.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e}class uq extends uP{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new uq(e,t,n)}_apply(e){let t=this._parse(e);return u4(e._query,t),new lM(e.firestore,e.converter,re(e._query,t))}_parse(e){let t=ud(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new k(A.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){u5(a,s);let t=[];for(let n of a)t.push(u2(r,e,n));o={arrayValue:{values:t}}}else o=u2(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||u5(a,s),o=ub(n,t,a,"in"===s||"not-in"===s);return nM.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}function uU(e,t,n){let r=uV("where",e);return uq._create(r,t,n)}class uB extends uF{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new uB(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nV.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())u4(n,e),n=re(n,e)}(e._query,t),new lM(e.firestore,e.converter,re(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function uz(...e){return e.forEach(e=>u6("or",e)),uB._create("or",e)}function u$(...e){return e.forEach(e=>u6("and",e)),uB._create("and",e)}class uK extends uP{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new uK(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new k(A.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new k(A.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nk(t,n)}(e._query,this._field,this._direction);return new lM(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new n2(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function uG(e,t="asc"){let n=uV("orderBy",e);return uK._create(n,t)}class uj extends uP{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new uj(e,t,n)}_apply(e){return new lM(e.firestore,e.converter,rt(e._query,this._limit,this._limitType))}}function uQ(e){return ea("limit",e),uj._create("limit",e,"F")}function uW(e){return ea("limitToLast",e),uj._create("limitToLast",e,"L")}class uJ extends uP{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uJ(e,t,n)}_apply(e){var t;let n=u1(e,this.type,this._docOrFields,this._inclusive);return new lM(e.firestore,e.converter,(t=e._query,new n2(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}function uH(...e){return uJ._create("startAt",e,!0)}function uY(...e){return uJ._create("startAfter",e,!1)}class uX extends uP{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uX(e,t,n)}_apply(e){var t;let n=u1(e,this.type,this._docOrFields,this._inclusive);return new lM(e.firestore,e.converter,(t=e._query,new n2(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function uZ(...e){return uX._create("endBefore",e,!1)}function u0(...e){return uX._create("endAt",e,!0)}function u1(e,t,n,r){if(n[0]=(0,c.Ku)(n[0]),n[0]instanceof uR)return function(e,t,n,r,i){if(!r)throw new k(A.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of n3(e))if(n.field.isKeyField())s.push(nm(t,r.key));else{let e=r.data.field(n.field);if(t6(e))throw new k(A.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new k(A.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new nD(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=ud(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new k(A.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new k(A.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!n6(e)&&-1!==l.indexOf("/"))throw new k(A.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(J.fromString(l));if(!X.isDocumentKey(n))throw new k(A.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new X(n);o.push(nm(t,i))}else{let e=ub(n,r,l);o.push(e)}}return new nD(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function u2(e,t,n){if("string"==typeof(n=(0,c.Ku)(n))){if(""===n)throw new k(A.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!n6(t)&&-1!==n.indexOf("/"))throw new k(A.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(J.fromString(n));if(!X.isDocumentKey(r))throw new k(A.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nm(e,new X(r))}if(n instanceof lV)return nm(e,n._key);throw new k(A.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ei(n)}.`)}function u5(e,t){if(!Array.isArray(e)||0===e.length)throw new k(A.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function u4(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new k(A.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new k(A.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function u6(e,t){if(!(t instanceof uq||t instanceof uB))throw new k(A.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class u3{convertValue(e,t="none"){switch(no(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tZ(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(t0(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tL(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){return new us(e.fields?.[ns].arrayValue?.values?.map(e=>tZ(e.doubleValue)))}convertGeoPoint(e){return new ui(tZ(e.latitude),tZ(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=t3(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(t8(e));default:return null}}convertTimestamp(e){let t=tX(e);return new eu(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=J.fromString(e);D(iV(n),9688,{name:e});let r=new ne(n.get(1),n.get(3)),i=new X(n.popFirst(5));return r.isEqual(t)||T(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function u8(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class u9 extends u3{constructor(e){super(),this.firestore=e}convertBytes(e){return new ue(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lV(this.firestore,null,t)}}function u7(e){return new l9("sum",uN("sum",e))}function ce(e){return new l9("avg",uN("average",e))}function ct(){return new l9("count")}function cn(e,t){return e instanceof l9&&t instanceof l9&&e.aggregateType===t.aggregateType&&e._internalFieldPath?.canonicalString()===t._internalFieldPath?.canonicalString()}function cr(e,t){return lU(e.query,t.query)&&(0,c.bD)(e.data(),t.data())}let ci="NOT SUPPORTED";class cs{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ca extends uR{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new cl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(uV("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new k(A.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e=this._document,t={};return t.type=ca._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),e&&e.isValidDocument()&&e.isFoundDocument()&&(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),this._firestore,this.ref.path,t.bundle="NOT SUPPORTED"),t}}function co(e,t,n){if(el(t,ca._jsonSchema)){var r;if(t.bundle===ci)throw new k(A.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");let i=aO(e._databaseId),s=(r=t.bundle,new lc(r,i)),a=s.Wu(),o=new oE(s.getMetadata(),i);for(let e of a)o.Ga(e);let l=o.documents;if(1!==l.length)throw new k(A.INVALID_ARGUMENT,`Expected bundle data to contain 1 document, but it contains ${l.length} documents.`);let u=iS(i,l[0].document),c=new X(J.fromString(t.bundleName));return new ca(e,new u9(e),c,u,new cs(!1,!1),n||null)}}ca._jsonSchemaVersion="firestore/documentSnapshot/1.0",ca._jsonSchema={type:eo("string",ca._jsonSchemaVersion),bundleSource:eo("string","DocumentSnapshot"),bundleName:eo("string"),bundle:eo("string")};class cl extends ca{data(e={}){return super.data(e)}}class cu{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new cs(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new cl(this._firestore,this._userDataWriter,n.key,n,new cs(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(A.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new cl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new cs(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new cl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new cs(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return x(61501,{type:e})}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new k(A.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e={};e.type=cu._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=z.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;let t=[],n=[],r=[];return this.docs.forEach(e=>{null!==e._document&&(t.push(e._document),n.push(this._userDataWriter.convertObjectMap(e._document.data.value.mapValue.fields,"previous")),r.push(e.ref.path))}),this._firestore,this.query._query,e.bundleName,e.bundle="NOT SUPPORTED",e}}function cc(e,t,n){if(el(t,cu._jsonSchema)){var r;if(t.bundle===ci)throw new k(A.INVALID_ARGUMENT,"The provided JSON object was created in a client environment, which is not supported.");let i=aO(e._databaseId),s=(r=t.bundle,new lc(r,i)),a=s.Wu(),o=new oE(s.getMetadata(),i);for(let e of a)o.Ga(e);if(1!==o.queries.length)throw new k(A.INVALID_ARGUMENT,`Snapshot data expected 1 query but found ${o.queries.length} queries.`);let l=iK(o.queries[0].bundledQuery),u=o.documents,c=new oc;u.map(e=>{let t=iS(i,e.document);c=c.add(t)});let h=od.fromInitialDocuments(l,c,rp(),!1,!1),d=new lM(e,n||null,l);return new cu(e,new u9(e),d,h)}}function ch(e,t){return e instanceof ca&&t instanceof ca?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof cu&&t instanceof cu&&e._firestore===t._firestore&&lU(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function cd(e){e=es(e,lV);let t=es(e.firestore,lQ);return lS(lH(t),e._key).then(n=>cN(t,e,n))}cu._jsonSchemaVersion="firestore/querySnapshot/1.0",cu._jsonSchema={type:eo("string",cu._jsonSchemaVersion),bundleSource:eo("string","QuerySnapshot"),bundleName:eo("string"),bundle:eo("string")};class cf extends u3{constructor(e){super(),this.firestore=e}convertBytes(e){return new ue(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lV(this.firestore,null,t)}}function cm(e){e=es(e,lV);let t=es(e.firestore,lQ),n=lH(t),r=new cf(t);return(function(e,t){let n=new R;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await e.persistence.runTransaction("read document","readonly",n=>e.localDocuments.getDocument(n,t));r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new k(A.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){let e=ou(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await lI(e),t,n)),n.promise})(n,e._key).then(n=>new ca(t,r,e._key,n,new cs(null!==n&&n.hasLocalMutations,!0),e.converter))}function cg(e){e=es(e,lV);let t=es(e.firestore,lQ);return lS(lH(t),e._key,{source:"server"}).then(n=>cN(t,e,n))}function cp(e){e=es(e,lM);let t=es(e.firestore,lQ),n=lH(t),r=new cf(t);return uO(e._query),lx(n,e._query).then(n=>new cu(t,r,e,n))}function cy(e){e=es(e,lM);let t=es(e.firestore,lQ),n=lH(t),r=new cf(t);return(function(e,t){let n=new R;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await an(e,t,!0),i=new oD(t,r.Qs),s=i.ru(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(r){let e=ou(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await lI(e),t,n)),n.promise})(n,e._query).then(n=>new cu(t,r,e,n))}function cw(e){e=es(e,lM);let t=es(e.firestore,lQ),n=lH(t),r=new cf(t);return lx(n,e._query,{source:"server"}).then(n=>new cu(t,r,e,n))}function cv(e,t,n){e=es(e,lV);let r=es(e.firestore,lQ),i=u8(e.converter,t,n);return cx(r,[uf(ud(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,rM.none())])}function cI(e,t,n,...r){e=es(e,lV);let i=es(e.firestore,lQ),s=ud(i);return cx(i,[("string"==typeof(t=(0,c.Ku)(t))||t instanceof ut?u_(s,"updateDoc",e._key,t,n,r):uI(s,"updateDoc",e._key,t)).toMutation(e._key,rM.exists(!0))])}function c_(e){return cx(es(e.firestore,lQ),[new rK(e._key,rM.none())])}function cb(e,t){let n=es(e.firestore,lQ),r=lL(e),i=u8(e.converter,t);return cx(n,[uf(ud(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,rM.exists(!1))]).then(()=>r)}function cT(e,...t){let n,r,i;e=(0,c.Ku)(e);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[0]||lK(t[a])||(s=t[a++]);let o={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(lK(t[a])){let e=t[a];t[a]=e.next?.bind(e),t[a+1]=e.error?.bind(e),t[a+2]=e.complete?.bind(e)}if(e instanceof lV)r=es(e.firestore,lQ),i=n5(e._key.path),n={next:n=>{t[a]&&t[a](cN(r,e,n))},error:t[a+1],complete:t[a+2]};else{let s=es(e,lM);r=es(s.firestore,lQ),i=s._query;let o=new cf(r);n={next:e=>{t[a]&&t[a](new cu(r,o,s,e))},error:t[a+1],complete:t[a+2]},uO(e._query)}var l=lH(r),u=i;let h=new ll(n),d=new o_(u,h,o);return l.asyncQueue.enqueueAndForget(async()=>op(await lE(l),d)),()=>{h.Nu(),l.asyncQueue.enqueueAndForget(async()=>oy(await lE(l),d))}}function cE(e,t,...n){var r,i,s,a,o,l;let u=(0,c.Ku)(e),h=function(e){let t={bundle:"",bundleName:"",bundleSource:""};for(let n of["bundle","bundleName","bundleSource"]){if(!(n in e)){t.error=`snapshotJson missing required field: ${n}`;break}let r=e[n];if("string"!=typeof r){t.error=`snapshotJson field '${n}' must be a string.`;break}if(0===r.length){t.error=`snapshotJson field '${n}' cannot be an empty string.`;break}"bundle"===n?t.bundle=r:"bundleName"===n?t.bundleName=r:"bundleSource"===n&&(t.bundleSource=r)}return t}(t);if(h.error)throw new k(A.INVALID_ARGUMENT,h.error);let d,f=0;if("object"!=typeof n[0]||lK(n[f])||(d=n[f++]),"QuerySnapshot"===h.bundleSource){let e,t,a=null;if("object"==typeof n[f]&&lK(n[f])){let e=n[f++];a={next:e.next,error:e.error,complete:e.complete}}else a={next:n[f++],error:n[f++],complete:n[f++]};return r=d,i=a,s=n[f],t=!1,l3(u,h.bundle).then(()=>l8(u,h.bundleName)).then(n=>{n&&!t&&(s&&n.withConverter(s),e=cT(n,r||{},i))}).catch(e=>(i.error&&i.error(e),()=>{})),()=>{t||(t=!0,e&&e())}}if("DocumentSnapshot"===h.bundleSource){let e,t,r=null;if("object"==typeof n[f]&&lK(n[f])){let e=n[f++];r={next:e.next,error:e.error,complete:e.complete}}else r={next:n[f++],error:n[f++],complete:n[f++]};return a=d,o=r,l=n[f],t=!1,l3(u,h.bundle).then(()=>{t||(e=cT(new lV(u,l||null,X.fromPath(h.bundleName)),a||{},o))}).catch(e=>(o.error&&o.error(e),()=>{})),()=>{t||(t=!0,e&&e())}}throw new k(A.INVALID_ARGUMENT,`unsupported bundle source: ${h.bundleSource}`)}function cS(e,t){return function(e,t){let n=new ll(t);return e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lE(e),void(t.Ca.add(n),n.next())}),()=>{n.Nu(),e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lE(e),void t.Ca.delete(n)})}}(lH(e=es(e,lQ)),lK(t)?t:{next:t})}function cx(e,t){var n=lH(e);let r=new R;return n.asyncQueue.enqueueAndForget(async()=>oq(await lb(n),t,r)),r.promise}function cN(e,t,n){let r=n.docs.get(t._key),i=new cf(e);return new ca(e,i,t._key,r,new cs(n.hasPendingWrites,n.fromCache),t.converter)}function cD(e){return cC(e,{count:ct()})}function cC(e,t){let n=es(e.firestore,lQ),r=lH(n),i=tq(t,(e,t)=>new rJ(t,e.aggregateType,e._internalFieldPath));return(function(e,t,n){let r=new R;return e.asyncQueue.enqueueAndForget(async()=>{try{let i=await lT(e);r.resolve(async function(e,t,n){let{request:r,gt:i,parent:s}=iA(e.serializer,n9(t),n);e.connection.$o||delete r.parent;let a=(await e.Ho("RunAggregationQuery",e.serializer.databaseId,s,r,1)).filter(e=>!!e.result);D(1===a.length,64727);let o=a[0].result?.aggregateFields;return Object.keys(o).reduce((e,t)=>(e[i[t]]=o[t],e),{})}(i,t,n))}catch(e){r.reject(e)}}),r.promise})(r,e._query,i).then(t=>new l7(e,new cf(n),t))}class cA{constructor(e){this.kind="memory",this._onlineComponentProvider=la.provider,this._offlineComponentProvider=e?.garbageCollector?e.garbageCollector._offlineComponentProvider:{build:()=>new lr(void 0)}}toJSON(){return{kind:this.kind}}}class ck{constructor(e){let t;this.kind="persistent",e?.tabManager?(e.tabManager._initialize(e),t=e.tabManager):(t=cU(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class cR{constructor(){this.kind="memoryEager",this._offlineComponentProvider=ln.provider}toJSON(){return{kind:this.kind}}}class cM{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new lr(e)}}toJSON(){return{kind:this.kind}}}function cV(){return new cR}function cO(e){return new cM(e?.cacheSizeBytes)}function cF(e){return new cA(e)}function cP(e){return new ck(e)}class cL{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=la.provider,this._offlineComponentProvider={build:t=>new li(t,e?.cacheSizeBytes,this.forceOwnership)}}}class cq{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=la.provider,this._offlineComponentProvider={build:t=>new ls(t,e?.cacheSizeBytes)}}}function cU(e){return new cL(e?.forceOwnership)}function cB(){return new cq}let cz={maxAttempts:5};class c${constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=ud(e)}set(e,t,n){this._verifyNotCommitted();let r=cK(e,this._firestore),i=u8(r.converter,t,n),s=uf(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,rM.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=cK(e,this._firestore);return i="string"==typeof(t=(0,c.Ku)(t))||t instanceof ut?u_(this._dataReader,"WriteBatch.update",s._key,t,n,r):uI(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,rM.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=cK(e,this._firestore);return this._mutations=this._mutations.concat(new rK(t._key,rM.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(A.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function cK(e,t){if((e=(0,c.Ku)(e)).firestore!==t)throw new k(A.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class cG{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=ud(e)}get(e){let t=cK(e,this._firestore),n=new u9(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return x(24041);let r=e[0];if(r.isFoundDocument())return new uR(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new uR(this._firestore,n,t._key,null,t.converter);throw x(18433,{doc:r})})}set(e,t,n){let r=cK(e,this._firestore),i=u8(r.converter,t,n),s=uf(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=cK(e,this._firestore);return i="string"==typeof(t=(0,c.Ku)(t))||t instanceof ut?u_(this._dataReader,"Transaction.update",s._key,t,n,r):uI(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=cK(e,this._firestore);return this._transaction.delete(t._key),this}}class cj extends cG{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=cK(e,this._firestore),n=new cf(this._firestore);return super.get(e).then(e=>new ca(this._firestore,n,t._key,e._document,new cs(!1,!1),t.converter))}}function cQ(e,t,n){e=es(e,lQ);let r={...cz,...n};if(r.maxAttempts<1)throw new k(A.INVALID_ARGUMENT,"Max attempts must be at least 1");return function(e,t,n){let r=new R;return e.asyncQueue.enqueueAndForget(async()=>{let i=await lT(e);new ld(e.asyncQueue,i,n,t,r).ju()}),r.promise}(lH(e),n=>t(new cj(e,n)),r)}function cW(){return new um("deleteField")}function cJ(){return new up("serverTimestamp")}function cH(...e){return new uy("arrayUnion",e)}function cY(...e){return new uw("arrayRemove",e)}function cX(e){return new uv("increment",e)}function cZ(e){return new us(e)}function c0(e){return lH(e=es(e,lQ)),new c$(e,t=>cx(e,t))}function c1(e,t){let n=lH(e=es(e,lQ));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return E("Cannot enable indexes when persistence is disabled"),Promise.resolve();let r=function(e){let t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new k(A.INVALID_ARGUMENT,"Failed to parse JSON: "+e?.message)}}(e):e,n=[];if(Array.isArray(t.indexes))for(let e of t.indexes){let t=c2(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(let t of e.fields){let e=uC("setIndexConfiguration",c2(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new eg(e,2)):"ASCENDING"===t.order?r.push(new eg(e,0)):"DESCENDING"===t.order&&r.push(new eg(e,1))}n.push(new eh(eh.UNKNOWN_ID,t,r,ep.empty()))}return n}(t);return n.asyncQueue.enqueue(async()=>(async function(e,t){let n=e.indexManager,r=[];return e.persistence.runTransaction("Configure indexes","readwrite",e=>n.getFieldIndexes(e).next(i=>(function(e,t,n,r,i){t=[...t],(e=[...e]).sort(n),t.sort(n);let s=e.length,a=t.length,o=0,l=0;for(;o<a&&l<s;){let s=n(e[l],t[o]);s<0?i(e[l++]):s>0?r(t[o++]):(o++,l++)}for(;o<a;)r(t[o++]);for(;l<s;)i(e[l++])})(i,t,em,t=>{r.push(n.addFieldIndex(e,t))},t=>{r.push(n.deleteFieldIndex(e,t))})).next(()=>eE.waitFor(r)))})(await lI(n),r))}function c2(e,t){if("string"!=typeof e[t])throw new k(A.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class c5{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function c4(e){e=es(e,lQ);let t=c7.get(e);if(t)return t;let n=lH(e);if("persistent"!==n._uninitializedComponentsProvider?._offline.kind)return null;let r=new c5(e);return c7.set(e,r),r}function c6(e){c9(e,!0)}function c3(e){c9(e,!1)}function c8(e){var t;(t=lH(e._firestore)).asyncQueue.enqueue(async()=>(function(e){let t=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",e=>t.deleteAllFieldIndexes(e))})(await lI(t))).then(e=>b("deleting all persistent cache indexes succeeded")).catch(e=>E("deleting all persistent cache indexes failed",e))}function c9(e,t){var n;(n=lH(e._firestore),n.asyncQueue.enqueue(async()=>{var e;return e=await lI(n),void(e.Fs.Vs=t)})).then(e=>b(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>E(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}let c7=new WeakMap;function he(e){let t=lH(es(e.firestore,lQ)),n=t._onlineComponents?.datastore.serializer;return void 0===n?null:iC(n,n8(e._query)).ft}function ht(e,t){let n=tq(t,(e,t)=>new rJ(t,e.aggregateType,e._internalFieldPath)),r=lH(es(e.firestore,lQ)),i=r._onlineComponents?.datastore.serializer;return void 0===i?null:iA(i,n9(e._query),n,!0).request}class hn{constructor(){throw Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return hr.instance.onExistenceFilterMismatch(e)}}class hr{constructor(){this.Mc=new Map}static get instance(){return hi||function(e){if(rZ)throw Error("a TestingHooksSpi instance is already set");rZ=e}(hi=new hr),hi}lt(e){this.Mc.forEach(t=>t(e))}onExistenceFilterMismatch(e){let t=Symbol(),n=this.Mc;return n.set(t,e),()=>n.delete(t)}}let hi=null;!function(e,t=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:n,options:r})=>{let i=e.getProvider("app").getImmediate(),s=new lQ(new F(e.getProvider("auth-internal")),new U(i,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new k(A.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ne(e.options.projectId,t)}(i,n),i);return r={useFetchStreams:t,...r},s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2020")}()}}]);