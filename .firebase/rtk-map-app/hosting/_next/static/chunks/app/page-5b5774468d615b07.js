(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{591:e=>{e.exports={"flowchart-physics-node":"FlowchartPhysics_flowchart-physics-node__NKcOQ","node-top-priority":"FlowchartPhysics_node-top-priority__SO2vw","priority-badge":"FlowchartPhysics_priority-badge__yVMFM","group-frame":"FlowchartPhysics_group-frame__fEWMf","group-label":"FlowchartPhysics_group-label__Af4Sf"}},887:(e,t,i)=>{"use strict";i.d(t,{A:()=>p});var r=i(5155),s=i(2115),n=i(6278),a=i(8515),l=i(9927),o=i(3127),d=i(9242),c=i(5317),h=i(3201);function p(e){let{user:t,open:i,onClose:p}=e,[m,u]=(0,s.useState)(""),[g,y]=(0,s.useState)(""),[f,x]=(0,s.useState)(""),[b,j]=(0,s.useState)(!1),[v,w]=(0,s.useState)(""),[P,D]=(0,s.useState)("");(0,s.useEffect)(()=>{i&&(async()=>{j(!0),w(""),D("");try{let e=(0,c.doc)(h.db,"users",t.uid),i=(await (0,c.getDoc)(e)).data();i&&i.studentData&&(u(i.studentData.studentId||""),y(i.studentData.name||""),x(i.studentData.class||""))}catch(e){w("プロフィール取得に失敗しました")}finally{j(!1)}})()},[t,i]);let S=async e=>{if(e.preventDefault(),!m||!g||!f)return void w("クラス（組）・学籍番号・名前を入力してください");if(!/^[0-9]+$/.test(m))return void w("学籍番号は半角数字で入力してください");j(!0),w(""),D("");try{let e=(0,c.doc)(h.db,"users",t.uid);await (0,c.setDoc)(e,{email:t.email,studentData:{studentId:m,name:g,class:f}},{merge:!0}),D("プロフィールを更新しました")}catch(e){w("更新に失敗しました: "+(e.message||""))}finally{j(!1)}};return(0,r.jsxs)(n.A,{open:i,onClose:p,maxWidth:"xs",fullWidth:!0,children:[(0,r.jsxs)(a.A,{sx:{m:0,p:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsx)("span",{children:"プロフィール編集"}),(0,r.jsx)(o.A,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:e=>e.palette.grey[500]},children:(0,r.jsx)(d.A,{})})]}),(0,r.jsx)(l.A,{dividers:!0,children:(0,r.jsxs)("form",{onSubmit:S,children:[(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"クラス（組）"}),(0,r.jsx)("input",{type:"text",value:f,onChange:e=>x(e.target.value),style:{width:"100%",fontSize:16,padding:6},placeholder:"クラス名"})]}),(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"学籍番号"}),(0,r.jsx)("input",{type:"text",value:m,onChange:e=>u(e.target.value.replace(/[^0-9]/g,"")),style:{width:"100%",fontSize:16,padding:6},inputMode:"numeric",pattern:"[0-9]*",placeholder:"半角数字のみ"})]}),(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"名前"}),(0,r.jsx)("input",{type:"text",value:g,onChange:e=>y(e.target.value),style:{width:"100%",fontSize:16,padding:6},placeholder:"氏名"})]}),(0,r.jsx)("button",{type:"submit",disabled:b,style:{width:"100%",fontSize:16,padding:8},children:b?"保存中...":"保存"}),v&&(0,r.jsx)("div",{style:{color:"red",marginTop:8},children:v}),P&&(0,r.jsx)("div",{style:{color:"green",marginTop:8},children:P})]})})]})}},2835:(e,t,i)=>{Promise.resolve().then(i.bind(i,4866))},3201:(e,t,i)=>{"use strict";i.d(t,{db:()=>o,j:()=>l});var r=i(3915),s=i(5404),n=i(5317);let a=(0,r.Dk)().length?(0,r.Sx)():(0,r.Wp)({apiKey:"AIzaSyBhyFZVgwSjiIv7J8OjqkK9-YCpoKnTyNs",authDomain:"rtk-map-app.firebaseapp.com",projectId:"rtk-map-app",storageBucket:"rtk-map-app.firebasestorage.app",messagingSenderId:"770512095150",appId:"1:770512095150:web:897c370a971298b55f2a3f",measurementId:"G-Y267HG23R7"}),l=(0,s.xI)(a),o=(0,n.getFirestore)(a)},4866:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>M});var r=i(5155),s=i(2115),n=i(5404),a=i(4974),l=i(5317),o=i(591),d=i.n(o),c=i(8947),h=i(8534),p=i(1977),m=i(9540),u=i(9197),g=i(6278),y=i(8515),f=i(9927),x=i(3127),b=i(9242),j=i(8991);function v(e){let{children:t}=e;return(0,r.jsx)(j.n,{maxSnack:3,anchorOrigin:{vertical:"top",horizontal:"right"},children:t})}function w(){let{enqueueSnackbar:e}=(0,j.dh)();return e}function P(e){if(e.materials){let t=e.materials.map(e=>e.url?"- ".concat(e.label,"：[").concat(e.title,"](").concat(e.url,")"):"- ".concat(e.label,"：").concat(e.title)).join("\n"),i=new c.xI.Renderer;i.link=e=>{let{href:t,text:i}=e;return'<a href="'.concat(t,'" target="_blank" rel="noopener noreferrer">').concat(i,"</a>")};let s=(0,c.xI)(t,{renderer:i});return(0,r.jsx)("div",{dangerouslySetInnerHTML:{__html:s}})}let t=(e.text||"").split(/\n/),i=/(https?:\/\/[\w\-._~:/?#[\]@!$&'()*+,;=%]+)/g;return(0,r.jsx)("div",{children:t.map((e,t)=>{let s=e.match(/^(.+?):\s*\[(.+?)\]\s*,?\s*(https?:\/\/.+)$/);if(s){let e=s[1].trim(),i=s[2].trim(),n=s[3].trim();return(0,r.jsxs)("div",{children:[e,":"," ",(0,r.jsx)("a",{href:n,target:"_blank",rel:"noopener noreferrer",children:i})]},t)}let n=e.replace(i,e=>"<a href='".concat(e,"' target='_blank' rel='noopener noreferrer'>").concat(e,"</a>"));return(0,r.jsx)("div",{dangerouslySetInnerHTML:{__html:n}},t)})})}let D={"正解（微妙）":["たまたま解けたが微妙","時間がかかってしまった"],"不正解（惜しい）":["理解したので次は解けそう","計算ミスなどの惜しい間違い方をした"]};function S(e){let{problem:t,record:i,lastRecord:n,handleRecord:a,loading:l}=e,[o,d]=(0,s.useState)(""),[c,h]=(0,s.useState)(""),[p,g]=(0,s.useState)([]),[y,f]=(0,s.useState)(!1),[x,b]=(0,s.useState)(!1);(0,s.useEffect)(()=>{f(!1),b(!1),d(""),h(""),g([])},[t.id]);let j=i.attempts>0||i.probremPriority>0?i.probremPriority.toFixed(1):"不明",[,v]=(0,s.useState)({}),P=w(),S=async()=>{if(!await a(t.id,o,c))return void P("記録に失敗しました",{variant:"error"});i&&i.history&&(i.history.push({scs:o,scsReason:c,timestamp:new Date}),v({})),f(!0),P("記録に成功しました",{variant:"success"}),setTimeout(()=>b(!0),1200)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("td",{children:[t.ProblemNumber,(0,r.jsxs)("div",{className:"previous-record",children:["セミナー物理基礎+物理 P. ",t.page]})]}),(0,r.jsxs)("td",{children:[(0,r.jsx)(m.A,{disablePortal:!0,options:[{label:"⭕（\uD83D\uDE00完璧）",value:"正解（完璧）"},{label:"⭕（\uD83D\uDE42微妙）",value:"正解（微妙）"},{label:"❌（\uD83E\uDD14惜しい）",value:"不正解（惜しい）"},{label:"❌（\uD83D\uDE25まだまだ）",value:"不正解（まだまだ）"}],getOptionLabel:e=>"string"==typeof e?e:e.label,value:[{label:"⭕（\uD83D\uDE00完璧）",value:"正解（完璧）"},{label:"⭕（\uD83D\uDE42微妙）",value:"正解（微妙）"},{label:"❌（\uD83E\uDD14惜しい）",value:"不正解（惜しい）"},{label:"❌（\uD83D\uDE25まだまだ）",value:"不正解（まだまだ）"}].find(e=>e.value===o)||null,onChange:(e,t)=>{let i=t?t.value:"";d(i),h(""),g(D[i]||[])},disabled:y,sx:{width:180},renderInput:e=>(0,r.jsx)(u.A,{...e,label:"正解・不正解",size:"small"})}),(0,r.jsxs)("div",{className:"previous-record",children:["前回: ",(null==n?void 0:n.scs)||"記録なし"]})]}),(0,r.jsxs)("td",{children:[(0,r.jsx)(m.A,{disablePortal:!0,options:p,getOptionLabel:e=>e,value:c||null,onChange:(e,t)=>h(t||""),disabled:0===p.length||y,sx:{width:180},renderInput:e=>(0,r.jsx)(u.A,{...e,label:"理解状況",size:"small"})}),(0,r.jsx)("div",{className:"previous-record",children:(null==n?void 0:n.scsReason)||""})]}),(0,r.jsx)("td",{className:"problemPriority-display",children:j}),(0,r.jsx)("td",{className:"attempts-count",children:i.attempts}),(0,r.jsx)("td",{children:(0,r.jsx)("button",{className:"record-btn".concat(y?" recorded":"").concat(x?" fade":""),disabled:l||y,onClick:S,style:y?{background:"#ccc",color:"#888",cursor:"not-allowed"}:{},children:y?"記録完了":l?"記録中...":"記録"})})]})}function I(e){let{user:t,unitId:n,appState:o,setAppState:d,onClose:c,onUnitNodeClick:m,initialProblemId:u=null}=e;(0,s.useCallback)(async()=>{let e=(0,l.doc)(a.db,"users",t.uid),i=await (0,l.getDocs)((0,l.collection)(e,"problemRecords")),r={};i.forEach(e=>{r[e.id]=e.data()});let s=await (0,l.getDocs)((0,l.collection)(e,"unitPriorities")),n={};s.forEach(e=>{let t=e.data();"number"==typeof t.priority&&(n[e.id]=t.priority)}),d(e=>({...e,records:r,unitPriorities:{...e.unitPriorities,...n}}))},[t,d]);let[j,v]=(0,s.useState)(u),[D,I]=(0,s.useState)(!1),[k,A]=(0,s.useState)(0),[C,E]=(0,s.useState)(!1),[N,_]=(0,s.useState)(""),[O,M]=(0,s.useState)(!1),R=()=>{A(e=>e+1),c()},W=o.units.find(e=>e.id===n),U=o.problems.filter(e=>e.UnitID===n),z=async()=>{if(E(!0),!N&&W){M(!0);try{let e=(0,l.doc)(a.db,"units",W.id),t=await Promise.resolve().then(i.bind(i,5317)).then(t=>t.getDoc(e));if(t.exists()){let e=t.data();Array.isArray(e.teachingMaterials)||"string"==typeof e.teachingMaterials?_(e.teachingMaterials):_("教材情報が登録されていません。")}else _("教材情報が見つかりませんでした。")}catch(e){_("教材情報の取得に失敗しました。")}finally{M(!1)}}},F=()=>{E(!1)},L=j?o.problems.find(e=>e.id===j):null,B=()=>L&&L.imagePath?L.imagePath:W&&W.imagePath?W.imagePath:void 0,H=[];if(L&&L.DependsOn){let e=String(L.DependsOn).split(",").map(e=>e.trim());H=o.units.filter(t=>e.includes(t.id))}let T=w(),G=async(e,i,r)=>{if(!i)return T("正解・不正解を選択してください。",{variant:"warning"}),!1;if(("正解（微妙）"===i||"不正解（惜しい）"===i)&&!r)return T("理解状況を選択してください。",{variant:"warning"}),!1;I(!0);try{let s=((e,t,i)=>{let r=JSON.parse(JSON.stringify(o.records));r[e]||(r[e]={attempts:0,history:[],probremPriority:0}),r[e].attempts=(r[e].attempts||0)+1;let s=r[e].probremPriority,n=o.problems.find(t=>t.id===e);if(!n)return{newRecords:r};let a=o.units.find(e=>e.id===n.UnitID);if(!a)return{newRecords:r};if("正解（完璧）"===t&&(s=0,r[e].history?r[e].history.push({scs:"正解（完璧）",scsReason:i,timestamp:new Date}):r[e].history=[{scs:"正解（完璧）",scsReason:i,timestamp:new Date}]),"たまたま解けたが微妙"===i){for(let n of(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}],o.problems))if(n.UnitID===a.id&&n.id!==e){let e=r[n.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){r[n.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}if("時間がかかってしまった"===i&&(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"計算ミスなどの惜しい間違い方をした"===i&&(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"理解したので次は解けそう"===i){s=Math.min(s+2,4);let l=[a.id];a.DependsOn&&l.push(...String(a.DependsOn).split(",").map(e=>e.trim())),n.DependsOn&&l.push(...String(n.DependsOn).split(",").map(e=>e.trim()));let d=Array.from(new Set(l));for(let t of d)for(let i of o.problems)if(i.UnitID===t&&i.id!==e){let e=r[i.id],t=e&&e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0;if(e&&(0!==e.attempts||e.history&&0!==e.history.length))"正解（完璧）"!==t&&(e.probremPriority=Math.min((e.probremPriority||0)+1,4));else{let t=e&&"number"==typeof e.probremPriority?e.probremPriority:0;r[i.id]={attempts:0,history:[],probremPriority:Math.min((t||0)+1,4)}}}return r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}],{newRecords:r,relatedUnitIds:d}}if("不正解（まだまだ）"===t){s=Math.min(s+2,4);let l=[a.id];a.DependsOn&&l.push(...String(a.DependsOn).split(",").map(e=>e.trim())),n.DependsOn&&l.push(...String(n.DependsOn).split(",").map(e=>e.trim()));let d=Array.from(new Set(l));for(let t of d)for(let i of o.problems)if(i.UnitID===t&&i.id!==e){let e=r[i.id],s=e&&e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0,n=t===a.id?1:2;if(e&&(0!==e.attempts||e.history&&0!==e.history.length))"正解（完璧）"!==s&&(e.probremPriority=Math.min((e.probremPriority||0)+2,4));else{let t=e&&"number"==typeof e.probremPriority?e.probremPriority:0;r[i.id]={attempts:0,history:[],probremPriority:Math.min((t||0)+n,4)}}}return r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}],r[e].probremPriority=s,{newRecords:r,relatedUnitIds:d}}return r[e].probremPriority=s,{newRecords:r}})(e,i,r),n=s.newRecords,c=s.relatedUnitIds,{updatedUnitPriorities:h}=((e,t,i)=>{let r={},s=o.problems.reduce((e,t)=>(e[t.id]=t.UnitID,e),{}),n=o.units.reduce((e,t)=>(e[t.id]=t,e),{}),a=[];if(i&&i.length>0)a=[...i];else{let t=s[e],i=n[t];a=[t],i&&i.DependsOn&&a.push(...String(i.DependsOn).split(",").map(e=>e.trim()))}for(let e of[...new Set(a)]){let i=o.problems.filter(t=>t.UnitID===e).map(e=>e.id),s=0,n=0;i.forEach(e=>{t[e]&&(t[e].probremPriority>0||(t[e].attempts||0)>0)&&(s+=t[e].probremPriority,n++)}),n>0&&(r[e]=Math.min(s/n,4))}return{updatedUnitPriorities:r}})(e,n,c);d(e=>({...e,records:n,unitPriorities:{...e.unitPriorities,...h}}));let p=(0,l.doc)(a.db,"users",t.uid),m=(0,l.writeBatch)(a.db),u=(0,l.doc)((0,l.collection)(p,"learningLog"));return m.set(u,{problemId:e,scs:i,scsReason:r,probremPriority:n[e].probremPriority,timestamp:(0,l.serverTimestamp)()}),Object.entries(n).forEach(e=>{let[t,i]=e;if(i&&(i.probremPriority>0||i.attempts>0)){let e=(0,l.doc)(p,"problemRecords",t);m.set(e,{probremPriority:i.probremPriority,attempts:i.attempts,history:i.history||[]},{merge:!0})}}),Object.keys(h).forEach(e=>{let t=(0,l.doc)(p,"unitPriorities",e);m.set(t,{priority:h[e]})}),await m.commit(),!0}catch(e){return console.error("記録エラー:",e),T("記録中にエラーが発生しました。",{variant:"error"}),!1}finally{I(!1)}};return W?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(g.A,{open:C,onClose:F,maxWidth:"sm",fullWidth:!0,children:[(0,r.jsxs)(y.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["教材リスト",(0,r.jsx)(x.A,{onClick:F,size:"small",children:(0,r.jsx)(b.A,{})})]}),(0,r.jsx)(f.A,{dividers:!0,children:O?(0,r.jsx)("div",{children:"読み込み中..."}):(0,r.jsx)(P,{...Array.isArray(N)?{materials:N}:{text:N}})}),(0,r.jsx)(p.A,{children:(0,r.jsx)(h.A,{onClick:F,children:"閉じる"})})]}),(0,r.jsxs)(g.A,{open:!0,onClose:R,maxWidth:!1,fullWidth:!0,PaperProps:{style:{borderRadius:16,minWidth:320,maxWidth:"98vw",width:"98vw",margin:0}},children:[(0,r.jsxs)(y.A,{sx:{m:0,p:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsx)("span",{children:W.UnitName}),(0,r.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[(0,r.jsx)(h.A,{variant:"contained",color:"success",size:"small",onClick:z,sx:{minWidth:120},children:"教材を確認する"}),(0,r.jsx)(x.A,{"aria-label":"close",onClick:R,sx:{color:e=>e.palette.grey[500]},children:(0,r.jsx)(b.A,{})})]})]}),(0,r.jsxs)(f.A,{dividers:!0,sx:{p:0},className:"detailDialogContent",children:[(0,r.jsxs)("div",{style:{display:"flex",flexDirection:"row",minHeight:200},children:[(0,r.jsx)("div",{id:"detail-image-container",style:{width:400,height:300,display:"flex",alignItems:"center",justifyContent:"center",background:"#fff"},children:B()&&(0,r.jsx)("img",{id:"detail-image",src:B(),alt:W.UnitName,style:{maxWidth:"100%",maxHeight:"100%",width:"auto",height:"auto",display:"block"}})}),(0,r.jsx)("div",{style:{flex:1,marginLeft:24,minWidth:0,maxWidth:"420px",boxSizing:"border-box"},children:L&&(0,r.jsxs)("div",{style:{border:"2px solid #222",borderRadius:16,padding:12,marginBottom:12},children:[(0,r.jsx)("div",{style:{fontWeight:"bold",marginBottom:8},children:"この問題に関連する知識"}),(0,r.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:12},children:H.map(e=>(0,r.jsxs)("div",{style:{border:"1px solid #aaa",borderRadius:8,padding:8,width:100,cursor:"pointer",textAlign:"center"},onClick:()=>{v(null),m&&(c(),m(e.id))},children:[(0,r.jsx)("div",{style:{fontSize:13,fontWeight:600},children:e.UnitName}),e.imagePath&&(0,r.jsx)("img",{src:e.imagePath,alt:e.UnitName,style:{maxWidth:80,maxHeight:50,marginTop:4}})]},e.id))})]})})]}),(0,r.jsx)("h3",{style:{margin:"24px 0 8px 0",paddingLeft:8},children:"問題リスト"}),(0,r.jsx)("div",{className:"table-wrapper",style:{padding:8},children:(0,r.jsxs)("table",{id:"problem-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"問題番号"}),(0,r.jsx)("th",{children:"正解・不正解"}),(0,r.jsx)("th",{children:"理解状況"}),(0,r.jsx)("th",{children:"復習優先度"}),(0,r.jsx)("th",{children:"解いた回数"}),(0,r.jsx)("th",{children:"アクション"})]})}),(0,r.jsx)("tbody",{children:U.map(e=>{var t;let i=o.records[e.id]||{attempts:0,probremPriority:0,history:[]},s=(null==(t=i.history)?void 0:t.slice(-1)[0])||{},n=j===e.id;return(0,r.jsx)("tr",{style:n?{background:"#ffeedd"}:{},onClick:()=>v(e.id),children:(0,r.jsx)(S,{problem:e,record:i,lastRecord:s,handleRecord:G,loading:D})},e.id+"-"+k)})})]})})]})]})]}):null}var k=i(7316);let A=(0,k.A)("div")({position:"sticky",top:"-8px",padding:"4px 10px",color:"#1976d2",backgroundColor:"#e3f2fd",fontWeight:700}),C=(0,k.A)("ul")({padding:0});function E(e){let{options:t,onSelect:i}=e;return(0,r.jsx)(m.A,{options:t,groupBy:e=>"P.".concat(e.page),getOptionLabel:e=>"".concat(e.ProblemNumber,"（P.").concat(e.page,"）"),sx:{width:320},renderInput:e=>(0,r.jsx)(u.A,{...e,label:"問題を検索",size:"small"}),renderGroup:e=>(0,r.jsxs)("li",{children:[(0,r.jsx)(A,{children:e.group}),(0,r.jsx)(C,{children:e.children})]},e.key),onChange:(e,t)=>t&&i(t),isOptionEqualToValue:(e,t)=>e.id===t.id})}function N(e){let{user:t}=e,[n,o]=(0,s.useState)(null),[c,h]=(0,s.useState)({units:[],problems:[],records:{},unitPriorities:{}}),[p,m]=(0,s.useState)(!0),[u,g]=(0,s.useState)(null),y=w(),f=(0,s.useRef)([]);if((0,s.useEffect)(()=>{(async()=>{if(t){m(!0);try{let e=(await (0,l.getDocs)((0,l.collection)(a.db,"units"))).docs.map(e=>{var t,i;let r=e.data(),s=(t=r.PosX,i=r.PosY,1===t&&i>=2&&i<=4?"モーメントの基本":2===t&&i>=3&&i<=4?"つり合いの式":3===t&&i>=3&&i<=4?"棒のつり合い":4===t&&i>=2&&i<=4?"重心":5===t&&i>=2&&i<=4?"モーメントの応用":1===i&&t>=1&&t<=5?"今までの復習":"");return{...r,id:e.id,group:s}}),i=(await (0,l.getDocs)((0,l.collection)(a.db,"problems"))).docs.map(e=>({id:e.id,...e.data()})),r=(0,l.doc)(a.db,"users",t.uid),s=await (0,l.getDocs)((0,l.collection)(r,"problemRecords")),n={};s.forEach(e=>{n[e.id]=e.data()});let o={};e.forEach(e=>{let t=i.filter(t=>t.UnitID===e.id),r=0,s=0;t.forEach(e=>{let t=n[e.id];t&&"number"==typeof t.probremPriority&&t.probremPriority>0&&(r+=t.probremPriority,s++)}),o[e.id]=s>0?r/s:0}),h({units:e,problems:i,records:n,unitPriorities:o})}catch(e){console.error("Initialization failed:",e),alert("データの読み込みに失敗しました。")}finally{m(!1)}}})()},[t]),(0,s.useEffect)(()=>{f.current.forEach(e=>e.remove()),f.current=[];let e=null;return c.units.length>0&&!p&&i.e(495).then(i.t.bind(i,7495,23)).then(t=>{c.units.forEach(e=>{if(e.DependsOn){let i=document.getElementById(e.id);String(e.DependsOn).split(",").forEach(e=>{let r=document.getElementById(e.trim());if(r&&i){let e=new t.default(r,i,{color:"rgba(0, 0, 0, 0.6)",size:2,path:"straight",endPlug:"arrow1",dropShadow:!0,startSocket:"auto",endSocket:"auto"});f.current.push(e)}})}});let i=document.getElementById("flowchart-container");if(i){let t=()=>{f.current.forEach(e=>e.position())};i.addEventListener("scroll",t,{passive:!0}),e=()=>{i.removeEventListener("scroll",t)}}}),()=>{f.current.forEach(e=>e.remove()),f.current=[],e&&e()}},[c.units,p]),p)return(0,r.jsx)("div",{style:{padding:"2rem"},children:"Loading Flowchart..."});let x=c.units.length>0?Math.max(...c.units.map(e=>e.PosY||0)):1,b={},j=0;c.units.forEach(e=>{let t=c.unitPriorities[e.id];if(void 0!==t&&t>0){let i=Math.ceil(t);b[e.id]=i,i>j&&(j=i)}else b[e.id]=0});let v=["モーメントの基本","つり合いの式","棒のつり合い","重心","モーメントの応用","今までの復習"],P={};v.forEach(e=>{P[e]=c.units.filter(t=>t.group===e)});let D=v.map(e=>{let t=P[e];if(0===t.length)return null;let i=Math.min(...t.map(e=>e.PosX)),r=Math.max(...t.map(e=>e.PosX)),s=Math.min(...t.map(e=>e.PosY)),n=Math.max(...t.map(e=>e.PosY));return{group:e,left:40+(i-1)*200,top:50+(x-n)*150,width:(r-i+1)*200-30,height:(n-s+1)*150-30}});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",marginBottom:16},children:(0,r.jsx)(E,{options:[...c.problems].sort((e,t)=>Number(e.page)-Number(t.page)),onSelect:e=>{g(e.UnitID),o(e)}})}),(0,r.jsxs)("div",{id:"flowchart-container",style:{position:"relative",minHeight:810,minWidth:1080,maxWidth:1080,maxHeight:810,overflow:"hidden",padding:"40px"},children:[D.map((e,t)=>e&&(0,r.jsx)("div",{className:d()["group-frame"],style:{left:e.left,top:e.top,width:e.width,height:e.height},children:(0,r.jsx)("span",{className:d()["group-label"],children:e.group})},e.group)),(()=>{let e=v.indexOf("つり合いの式"),t=0;t=D[e]?D[e].top+D[e].height/2:D[1]?D[1].top+D[1].height/2:300;let i=[];for(let e=0;e<4;e++){let s=D[e],n=D[e+1];if(!s||!n)continue;let a=(s.left+s.width+n.left)/2-20,l=t-20;i.push((0,r.jsx)("img",{src:"/images/materials/arrow.png",alt:"arrow",style:{position:"absolute",left:a,top:l,width:40,height:40,transform:"rotate(0deg)",zIndex:20,pointerEvents:"none",opacity:.85}},"arrow-".concat(e)))}return i})(),c.units.map(e=>{let t=c.unitPriorities[e.id],i=d()["flowchart-physics-node"];b[e.id]===j&&j>0&&(i+=" "+d()["node-top-priority"]);let s=null;if(void 0!==t&&t>0){let e=Math.ceil(t);e>0&&(s=(0,r.jsx)("span",{className:d()["priority-badge"],children:"⭐".repeat(e)}))}return(0,r.jsxs)("div",{id:e.id,className:i,style:{left:"".concat(42+(e.PosX-1)*200,"px"),top:"".concat(60+(x-e.PosY)*150,"px"),zIndex:10},onClick:()=>g(e.id),children:[(0,r.jsx)("span",{children:e.UnitName}),s,e.imagePath&&(0,r.jsx)("img",{src:e.imagePath,alt:e.UnitName,style:{maxWidth:120,maxHeight:80,marginTop:8}})]},e.id)})]}),u&&(0,r.jsx)(I,{user:t,unitId:u,appState:c,setAppState:h,onClose:()=>g(null),onUnitNodeClick:e=>{g(e),o(null);let t=c.units.find(t=>t.id===e);t&&y("".concat(t.UnitName,"のパネルに移動しました"),{variant:"default"})},initialProblemId:(null==n?void 0:n.id)||null})]})}var _=i(887),O=i(3201);function M(){let[e,t]=(0,s.useState)(null),[i,o]=(0,s.useState)(!0),[d,c]=(0,s.useState)(!1),[h,p]=(0,s.useState)("loading");(0,s.useEffect)(()=>{let e=(0,n.hg)(a.j,e=>{t(e),o(!1)});return()=>e()},[]),(0,s.useEffect)(()=>{if(!e)return void p("loading");(async()=>{try{let t=(0,l.doc)(O.db,"users",e.uid),i=(await (0,l.getDoc)(t)).data();i&&i.studentData&&i.studentData.studentId&&i.studentData.name&&i.studentData.class?p("registered"):p("unregistered")}catch(e){p("unregistered")}})()},[e,d]);let m=async()=>{let e=new n.HF;try{await (0,n.df)(a.j,e)}catch(e){console.error("Login failed:",e)}},u=async()=>{try{await (0,n.CI)(a.j)}catch(e){console.error("Logout failed:",e)}};return i?(0,r.jsx)("div",{style:{padding:"2rem"},children:"Loading..."}):(0,r.jsx)(v,{children:(0,r.jsxs)("div",{id:"app",children:[(0,r.jsxs)("header",{children:[(0,r.jsx)("h1",{children:"物理学習マップ（剛体にはたらく力）"}),(0,r.jsx)("div",{id:"auth-container",children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{id:"user-info",children:["ようこそ, ",(0,r.jsx)("span",{id:"user-email",children:e.email})," さん"]}),(0,r.jsx)("button",{onClick:()=>c(!0),style:"unregistered"===h?{marginRight:8,background:"orange",color:"#fff",fontWeight:"bold"}:{marginRight:8},children:"unregistered"===h?"プロフィールを登録してください":"プロフィール変更"}),(0,r.jsx)("button",{id:"logout-btn",onClick:u,children:"ログアウト"})]}):(0,r.jsx)("button",{id:"login-btn",onClick:m,children:"Googleアカウントでログイン"})})]}),(0,r.jsx)("main",{children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(N,{user:e}),(0,r.jsx)(_.A,{user:e,open:d,onClose:()=>c(!1)})]}):(0,r.jsx)("div",{style:{padding:"2rem",textAlign:"center"},children:(0,r.jsx)("p",{children:"Googleアカウントでログインしてください。"})})})]})})}},4974:(e,t,i)=>{"use strict";i.d(t,{db:()=>o,j:()=>l,y:()=>a});var r=i(3915),s=i(5404),n=i(5317);let a=(0,r.Dk)().length?(0,r.Sx)():(0,r.Wp)({apiKey:"AIzaSyBu4trMNDk_2ZzCq4gfn0hs7nsXGJFnJIw",authDomain:"physics-app-e10d2.firebaseapp.com",projectId:"physics-app-e10d2",storageBucket:"physics-app-e10d2.firebasestorage.app",messagingSenderId:"925210606673",appId:"1:925210606673:web:efd104fc824d381d484c70",measurementId:"G-DLZ2L7ZK3F"}),l=(0,s.xI)(a),o=(0,n.getFirestore)(a)}},e=>{e.O(0,[220,135,965,670,901,472,441,964,358],()=>e(e.s=2835)),_N_E=e.O()}]);