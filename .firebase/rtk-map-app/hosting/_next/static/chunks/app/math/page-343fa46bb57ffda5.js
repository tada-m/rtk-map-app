(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[397],{887:(e,t,i)=>{"use strict";i.d(t,{A:()=>l});var r=i(5155),s=i(2115),n=i(5317),a=i(3201);function l(e){let{user:t,open:i,onClose:l}=e,[o,d]=(0,s.useState)(""),[c,h]=(0,s.useState)(""),[u,p]=(0,s.useState)(""),[m,y]=(0,s.useState)(!1),[x,f]=(0,s.useState)(""),[j,b]=(0,s.useState)("");(0,s.useEffect)(()=>{i&&(async()=>{y(!0),f(""),b("");try{let e=(0,n.H9)(a.db,"users",t.uid),i=(await (0,n.x7)(e)).data();i&&i.studentData&&(d(i.studentData.studentId||""),h(i.studentData.name||""),p(i.studentData.class||""))}catch(e){f("プロフィール取得に失敗しました")}finally{y(!1)}})()},[t,i]);let g=async e=>{if(e.preventDefault(),!o||!c||!u)return void f("学籍番号・名前・クラスを入力してください");y(!0),f(""),b("");try{let e=(0,n.H9)(a.db,"users",t.uid);await (0,n.BN)(e,{studentData:{studentId:o,name:c,class:u}},{merge:!0}),b("プロフィールを更新しました")}catch(e){f("更新に失敗しました: "+(e.message||""))}finally{y(!1)}};return i?(0,r.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.3)",zIndex:1e3},children:(0,r.jsxs)("div",{style:{background:"#fff",maxWidth:360,margin:"60px auto",padding:24,borderRadius:8,position:"relative"},children:[(0,r.jsx)("button",{onClick:l,style:{position:"absolute",right:12,top:12,fontSize:20},children:"\xd7"}),(0,r.jsx)("h2",{children:"プロフィール編集"}),(0,r.jsxs)("form",{onSubmit:g,children:[(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"学籍番号"}),(0,r.jsx)("input",{type:"text",value:o,onChange:e=>d(e.target.value),style:{width:"100%",fontSize:16,padding:6}})]}),(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"名前"}),(0,r.jsx)("input",{type:"text",value:c,onChange:e=>h(e.target.value),style:{width:"100%",fontSize:16,padding:6}})]}),(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsx)("label",{children:"クラス"}),(0,r.jsxs)("select",{value:u,onChange:e=>p(e.target.value),style:{width:"100%",fontSize:16,padding:6},children:[(0,r.jsx)("option",{value:"",children:"選択してください"}),(0,r.jsx)("option",{value:"A",children:"A"}),(0,r.jsx)("option",{value:"B",children:"B"})]})]}),(0,r.jsx)("button",{type:"submit",disabled:m,style:{width:"100%",fontSize:16,padding:8},children:m?"保存中...":"保存"}),x&&(0,r.jsx)("div",{style:{color:"red",marginTop:8},children:x}),j&&(0,r.jsx)("div",{style:{color:"green",marginTop:8},children:j})]})]})}):null}},3201:(e,t,i)=>{"use strict";i.d(t,{db:()=>o,j:()=>l});var r=i(3915),s=i(5404),n=i(5317);let a=(0,r.Dk)().length?(0,r.Sx)():(0,r.Wp)({apiKey:"AIzaSyBhyFZVgwSjiIv7J8OjqkK9-YCpoKnTyNs",authDomain:"rtk-map-app.firebaseapp.com",projectId:"rtk-map-app",storageBucket:"rtk-map-app.firebasestorage.app",messagingSenderId:"770512095150",appId:"1:770512095150:web:897c370a971298b55f2a3f",measurementId:"G-Y267HG23R7"}),l=(0,s.xI)(a),o=(0,n.aU)(a)},5535:(e,t,i)=>{Promise.resolve().then(i.bind(i,8057))},8057:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var r=i(5155),s=i(2115),n=i(5404),a=i(3201),l=i(5317);let o={"正解（微妙）":["たまたま解けた","時間がかかってしまった"],"不正解（惜しい）":["解き方をギリギリ思い出せなかった","防げた計算ミスがあった"]};function d(e){let{problem:t,record:i,lastRecord:n,handleRecord:a,loading:l}=e,[d,c]=(0,s.useState)(""),[h,u]=(0,s.useState)(""),[p,m]=(0,s.useState)([]),[y,x]=(0,s.useState)(!1),[f,j]=(0,s.useState)(!1);(0,s.useEffect)(()=>{x(!1),j(!1),c(""),u(""),m([])},[t.id]);let b=i.attempts>0||i.probremPriority>0?i.probremPriority.toFixed(1):"不明",[,g]=(0,s.useState)({}),v=async()=>{await a(t.id,d,h)&&(i&&i.history&&(i.history.push({scs:d,scsReason:h,timestamp:new Date}),g({})),x(!0),setTimeout(()=>j(!0),1200))};return(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:t.ProblemNumber}),(0,r.jsxs)("td",{children:[(0,r.jsxs)("select",{className:"scs-select",value:d,onChange:e=>{let t=e.target.value;c(t),u(""),m(o[t]||[])},disabled:y,children:[(0,r.jsx)("option",{value:""}),(0,r.jsx)("option",{value:"正解（完璧）",children:" ⭕（\uD83D\uDE00完璧）"}),(0,r.jsx)("option",{value:"正解（微妙）",children:" ⭕（\uD83D\uDE42微妙）"}),(0,r.jsx)("option",{value:"不正解（惜しい）",children:" ❌（\uD83E\uDD14惜しい）"}),(0,r.jsx)("option",{value:"不正解（まだまだ）",children:" ❌（\uD83D\uDE25まだまだ）"})]}),(0,r.jsxs)("div",{className:"previous-record",children:["前回: ",(null==n?void 0:n.scs)||"記録なし"]})]}),(0,r.jsxs)("td",{children:[(0,r.jsxs)("select",{className:"scsReason-select",value:h,onChange:e=>u(e.target.value),disabled:0===p.length||y,children:[(0,r.jsx)("option",{value:""}),p.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]}),(0,r.jsx)("div",{className:"previous-record",children:(null==n?void 0:n.scsReason)||""})]}),(0,r.jsx)("td",{className:"problemPriority-display",children:b}),(0,r.jsx)("td",{className:"attempts-count",children:i.attempts}),(0,r.jsx)("td",{children:(0,r.jsx)("button",{className:"record-btn".concat(y?" recorded":"").concat(f?" fade":""),disabled:l||y,onClick:v,style:y?{background:"#ccc",color:"#888",cursor:"not-allowed"}:{},children:y?"記録完了":l?"記録中...":"記録"})})]})}function c(e){let{user:t,unitId:i,appState:n,setAppState:o,onClose:c}=e,[h,u]=(0,s.useState)(!1),[p,m]=(0,s.useState)(n.records),[y,x]=(0,s.useState)(0);(0,s.useEffect)(()=>{m(n.records)},[n.records]);let f=n.units.find(e=>e.id===i),j=n.problems.filter(e=>e.UnitID===i),b=async(e,i,r)=>{if(!i)return alert("正解・不正解を選択してください。"),!1;if(("正解（微妙）"===i||"不正解（惜しい）"===i)&&!r)return alert("理解状況を選択してください。"),!1;u(!0);try{var s;let d=((e,t,i)=>{let r=JSON.parse(JSON.stringify(p));r[e]||(r[e]={attempts:0,history:[],probremPriority:0}),r[e].attempts=(r[e].attempts||0)+1;let s=r[e].probremPriority,a=n.problems.find(t=>t.id===e);if(!a)return r;let l=n.units.find(e=>e.id===a.UnitID);if(!l)return r;if("正解（完璧）"===t&&(s=0,r[e].history?r[e].history.push({scs:"正解（完璧）",scsReason:i,timestamp:new Date}):r[e].history=[{scs:"正解（完璧）",scsReason:i,timestamp:new Date}]),"たまたま解けた"===i){for(let a of(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}],n.problems))if(a.UnitID===l.id&&a.id!==e){let e=r[a.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){r[a.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}if("時間がかかってしまった"===i&&(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"防げた計算ミスがあった"===i&&(s=Math.min(s+1,4),r[e].history?r[e].history.push({scs:t,scsReason:i,timestamp:new Date}):r[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"解き方をギリギリ思い出せなかった"===i){s=Math.min(s+2,4);let t=[l.id];for(let i of(l.DependsOn&&t.push(...String(l.DependsOn).split(",").map(e=>e.trim())),n.problems))if(t.includes(i.UnitID)&&i.id!==e){let e=r[i.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){r[i.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}if("不正解（まだまだ）"===t){s=Math.min(s+2,4);let t=[l.id];for(let i of(l.DependsOn&&t.push(...String(l.DependsOn).split(",").map(e=>e.trim())),n.problems))if(t.includes(i.UnitID)&&i.id!==e){let e=r[i.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){r[i.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}return r[e].probremPriority=s,r})(e,i,r),{updatedUnitPriorities:c}=((e,t)=>{let i={},r=n.problems.reduce((e,t)=>(e[t.id]=t.UnitID,e),{}),s=n.units.reduce((e,t)=>(e[t.id]=t,e),{}),a=r[e],l=s[a],o=[a];for(let e of(l.DependsOn&&o.push(...String(l.DependsOn).split(",").map(e=>e.trim())),[...new Set(o)])){let r=n.problems.filter(t=>t.UnitID===e).map(e=>e.id),s=0,a=0;r.forEach(e=>{t[e]&&(t[e].probremPriority>0||(t[e].attempts||0)>0)&&(s+=t[e].probremPriority,a++)}),a>0&&(i[e]=Math.min(s/a,4))}return{updatedUnitPriorities:i}})(e,d);m(d);let h=(0,l.H9)(a.db,"users",t.uid),u=(0,l.wP)(a.db),y=(0,l.H9)((0,l.rJ)(h,"learningLog"));u.set(y,{problemId:e,scs:i,scsReason:r,probremPriority:d[e].probremPriority,timestamp:(0,l.O5)()});let x=(0,l.H9)(h,"problemRecords",e);return u.set(x,{probremPriority:d[e].probremPriority,attempts:((null==(s=n.records[e])?void 0:s.attempts)||0)+1,history:(0,l.hq)({scs:i,scsReason:r,timestamp:new Date})},{merge:!0}),Object.keys(c).forEach(e=>{let t=(0,l.H9)(h,"unitPriorities",e);u.set(t,{priority:c[e]})}),await u.commit(),o(e=>({...e,records:d,unitPriorities:{...e.unitPriorities,...c}})),!0}catch(e){return console.error("記録エラー:",e),alert("記録中にエラーが発生しました。"),m(n.records),!1}finally{u(!1)}};return f?(0,r.jsx)("div",{id:"detail-panel",children:(0,r.jsxs)("div",{className:"panel-content",children:[(0,r.jsxs)("div",{id:"detail-header",children:[(0,r.jsx)("h2",{id:"detail-unit-name",children:f.UnitName}),(0,r.jsx)("button",{id:"close-detail",title:"閉じる",onClick:()=>{x(e=>e+1),c()},children:"\xd7"})]}),(0,r.jsxs)("div",{id:"detail-body",children:[f.imagePath&&(0,r.jsx)("div",{id:"detail-image-container",children:(0,r.jsx)("img",{id:"detail-image",src:f.imagePath,alt:f.UnitName})}),(0,r.jsx)("h3",{children:"問題リスト"}),(0,r.jsx)("div",{className:"table-wrapper",children:(0,r.jsxs)("table",{id:"problem-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"問題番号"}),(0,r.jsx)("th",{children:"正解・不正解"}),(0,r.jsx)("th",{children:"主観的な理解状況"}),(0,r.jsx)("th",{children:"問題復習優先度"}),(0,r.jsx)("th",{children:"解いた回数"}),(0,r.jsx)("th",{children:"アクション"})]})}),(0,r.jsx)("tbody",{children:j.map(e=>{var t;let i=p[e.id]||{attempts:0,probremPriority:0,history:[]},s=(null==(t=i.history)?void 0:t.slice(-1)[0])||{};return(0,r.jsx)(d,{problem:e,record:i,lastRecord:s,handleRecord:b,loading:h},e.id+"-"+y)})})]})})]})]})}):null}function h(e){let{user:t}=e,[n,o]=(0,s.useState)({units:[],problems:[],records:{},unitPriorities:{}}),[d,h]=(0,s.useState)(!0),[u,p]=(0,s.useState)(null),m=(0,s.useRef)([]);if((0,s.useEffect)(()=>{(async()=>{if(t){h(!0);try{let e=(await (0,l.GG)((0,l.rJ)(a.db,"units"))).docs.map(e=>({id:e.id,...e.data()})),i=(await (0,l.GG)((0,l.rJ)(a.db,"problems"))).docs.map(e=>({id:e.id,...e.data()})),r=(0,l.H9)(a.db,"users",t.uid),s=await (0,l.GG)((0,l.rJ)(r,"problemRecords")),n={};s.forEach(e=>{n[e.id]=e.data()});let d=await (0,l.GG)((0,l.rJ)(r,"unitPriorities")),c={};d.forEach(e=>{c[e.id]=e.data().priority}),o({units:e,problems:i,records:n,unitPriorities:c})}catch(e){console.error("Initialization failed:",e),alert("データの読み込みに失敗しました。")}finally{h(!1)}}})()},[t]),(0,s.useEffect)(()=>(m.current.forEach(e=>e.remove()),m.current=[],n.units.length>0&&!d&&i.e(495).then(i.t.bind(i,7495,23)).then(e=>{n.units.forEach(t=>{if(t.DependsOn){let i=document.getElementById(t.id);String(t.DependsOn).split(",").forEach(t=>{let r=document.getElementById(t.trim());if(r&&i){let t=new e.default(r,i,{color:"rgba(0, 0, 0, 0.6)",size:2,path:"straight",endPlug:"arrow1",dropShadow:!0});m.current.push(t)}})}})}),()=>{m.current.forEach(e=>e.remove()),m.current=[]}),[n.units,d]),d)return(0,r.jsx)("div",{style:{padding:"2rem"},children:"Loading Flowchart..."});let y=n.units.length>0?Math.max(...n.units.map(e=>e.PosY||0)):1,x={},f=0;return n.units.forEach(e=>{let t=n.unitPriorities[e.id];if(void 0!==t&&t>0){let i=Math.ceil(t);x[e.id]=i,i>f&&(f=i)}else x[e.id]=0}),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{id:"flowchart-container",children:n.units.map(e=>{let t=n.unitPriorities[e.id],i="flowchart-node";x[e.id]===f&&f>0&&(i+=" node-top-priority");let s=null;if(void 0!==t&&t>0){let e=Math.ceil(t);e>0&&(s=(0,r.jsx)("span",{className:"priority-badge",children:"⭐".repeat(e)}))}return(0,r.jsxs)("div",{id:e.id,className:i,style:{left:"".concat((e.PosX-1)*200,"px"),top:"".concat((y-e.PosY)*130,"px")},onClick:()=>p(e.id),children:[(0,r.jsx)("span",{children:e.UnitName}),s]},e.id)})}),u&&(0,r.jsx)(c,{user:t,unitId:u,appState:n,setAppState:o,onClose:()=>p(null)})]})}var u=i(887);function p(){let[e,t]=(0,s.useState)(null),[i,l]=(0,s.useState)(!0),[o,d]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e=(0,n.hg)(a.j,e=>{t(e),l(!1)});return()=>e()},[]);let c=async()=>{let e=new n.HF;try{await (0,n.df)(a.j,e)}catch(e){console.error("Login failed:",e)}},p=async()=>{try{await (0,n.CI)(a.j)}catch(e){console.error("Logout failed:",e)}};return i?(0,r.jsx)("div",{style:{padding:"2rem"},children:"Loading..."}):(0,r.jsxs)("div",{id:"app",children:[(0,r.jsxs)("header",{children:[(0,r.jsx)("h1",{children:"数学学習フローチャート"}),(0,r.jsx)("div",{id:"auth-container",children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{id:"user-info",children:["ようこそ, ",(0,r.jsx)("span",{id:"user-email",children:e.email})," さん"]}),(0,r.jsx)("button",{onClick:()=>d(!0),style:{marginRight:8},children:"プロフィール変更"}),(0,r.jsx)("button",{id:"logout-btn",onClick:p,children:"ログアウト"})]}):(0,r.jsx)("button",{id:"login-btn",onClick:c,children:"Googleアカウントでログイン"})})]}),(0,r.jsx)("main",{children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(h,{user:e}),(0,r.jsx)(u.A,{user:e,open:o,onClose:()=>d(!1)})]}):(0,r.jsx)("div",{style:{padding:"2rem",textAlign:"center"},children:(0,r.jsx)("p",{children:"Googleアカウントでログインしてください。"})})})]})}}},e=>{e.O(0,[135,965,670,441,964,358],()=>e(e.s=5535)),_N_E=e.O()}]);