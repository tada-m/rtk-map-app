(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[397],{887:(e,t,i)=>{"use strict";i.d(t,{A:()=>u});var s=i(5155),r=i(2115),n=i(6278),a=i(8515),o=i(9927),l=i(3127),d=i(9242),c=i(5317),h=i(3201);function u(e){let{user:t,open:i,onClose:u}=e,[p,m]=(0,r.useState)(""),[y,x]=(0,r.useState)(""),[f,j]=(0,r.useState)(""),[g,b]=(0,r.useState)(!1),[v,D]=(0,r.useState)(""),[w,S]=(0,r.useState)("");(0,r.useEffect)(()=>{i&&(async()=>{b(!0),D(""),S("");try{let e=(0,c.doc)(h.db,"users",t.uid),i=(await (0,c.getDoc)(e)).data();i&&i.studentData&&(m(i.studentData.studentId||""),x(i.studentData.name||""),j(i.studentData.class||""))}catch(e){D("プロフィール取得に失敗しました")}finally{b(!1)}})()},[t,i]);let P=async e=>{if(e.preventDefault(),!p||!y||!f)return void D("クラス（組）・番号・名前を入力してください");if(!/^[0-9]+$/.test(p))return void D("番号は半角数字で入力してください");b(!0),D(""),S("");try{let e=(0,c.doc)(h.db,"users",t.uid);await (0,c.setDoc)(e,{email:t.email,studentData:{studentId:p,name:y,class:f}},{merge:!0}),S("プロフィールを更新しました")}catch(e){D("更新に失敗しました: "+(e.message||""))}finally{b(!1)}};return(0,s.jsxs)(n.A,{open:i,onClose:u,maxWidth:"xs",fullWidth:!0,children:[(0,s.jsxs)(a.A,{sx:{m:0,p:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,s.jsx)("span",{children:"プロフィール編集"}),(0,s.jsx)(l.A,{"aria-label":"close",onClick:u,sx:{position:"absolute",right:8,top:8,color:e=>e.palette.grey[500]},children:(0,s.jsx)(d.A,{})})]}),(0,s.jsx)(o.A,{dividers:!0,children:(0,s.jsxs)("form",{onSubmit:P,children:[(0,s.jsxs)("div",{style:{marginBottom:12},children:[(0,s.jsx)("label",{children:"クラス（組）"}),(0,s.jsx)("input",{type:"text",value:f,onChange:e=>j(e.target.value),style:{width:"100%",fontSize:16,padding:6},placeholder:"クラス名"})]}),(0,s.jsxs)("div",{style:{marginBottom:12},children:[(0,s.jsx)("label",{children:"番号"}),(0,s.jsx)("input",{type:"text",value:p,onChange:e=>m(e.target.value.replace(/[^0-9]/g,"")),style:{width:"100%",fontSize:16,padding:6},inputMode:"numeric",pattern:"[0-9]*",placeholder:"半角数字のみ"})]}),(0,s.jsxs)("div",{style:{marginBottom:12},children:[(0,s.jsx)("label",{children:"名前"}),(0,s.jsx)("input",{type:"text",value:y,onChange:e=>x(e.target.value),style:{width:"100%",fontSize:16,padding:6},placeholder:"氏名"})]}),(0,s.jsx)("button",{type:"submit",disabled:g,style:{width:"100%",fontSize:16,padding:8},children:g?"保存中...":"保存"}),v&&(0,s.jsx)("div",{style:{color:"red",marginTop:8},children:v}),w&&(0,s.jsx)("div",{style:{color:"green",marginTop:8},children:w})]})})]})}},3201:(e,t,i)=>{"use strict";i.d(t,{db:()=>l,j:()=>o});var s=i(3915),r=i(5404),n=i(5317);let a=(0,s.Dk)().length?(0,s.Sx)():(0,s.Wp)({apiKey:"AIzaSyBhyFZVgwSjiIv7J8OjqkK9-YCpoKnTyNs",authDomain:"rtk-map-app.firebaseapp.com",projectId:"rtk-map-app",storageBucket:"rtk-map-app.firebasestorage.app",messagingSenderId:"770512095150",appId:"1:770512095150:web:897c370a971298b55f2a3f",measurementId:"G-Y267HG23R7"}),o=(0,r.xI)(a),l=(0,n.getFirestore)(a)},5535:(e,t,i)=>{Promise.resolve().then(i.bind(i,8057))},8057:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var s=i(5155),r=i(2115),n=i(5317),a=i(3201),o=i(5404);let l={"正解（微妙）":["たまたま解けた","時間がかかってしまった"],"不正解（惜しい）":["解き方をギリギリ思い出せなかった","防げた計算ミスがあった"]};function d(e){let{problem:t,record:i,lastRecord:n,handleRecord:a,loading:o}=e,[d,c]=(0,r.useState)(""),[h,u]=(0,r.useState)(""),[p,m]=(0,r.useState)([]),[y,x]=(0,r.useState)(!1),[f,j]=(0,r.useState)(!1);(0,r.useEffect)(()=>{x(!1),j(!1),c(""),u(""),m([])},[t.id]);let g=i.attempts>0||i.probremPriority>0?i.probremPriority.toFixed(1):"不明",[,b]=(0,r.useState)({}),v=async()=>{await a(t.id,d,h)&&(i&&i.history&&(i.history.push({scs:d,scsReason:h,timestamp:new Date}),b({})),x(!0),setTimeout(()=>j(!0),1200))};return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:t.ProblemNumber}),(0,s.jsxs)("td",{children:[(0,s.jsxs)("select",{className:"scs-select",value:d,onChange:e=>{let t=e.target.value;c(t),u(""),m(l[t]||[])},disabled:y,children:[(0,s.jsx)("option",{value:""}),(0,s.jsx)("option",{value:"正解（完璧）",children:" ⭕（\uD83D\uDE00完璧）"}),(0,s.jsx)("option",{value:"正解（微妙）",children:" ⭕（\uD83D\uDE42微妙）"}),(0,s.jsx)("option",{value:"不正解（惜しい）",children:" ❌（\uD83E\uDD14惜しい）"}),(0,s.jsx)("option",{value:"不正解（まだまだ）",children:" ❌（\uD83D\uDE25まだまだ）"})]}),(0,s.jsxs)("div",{className:"previous-record",children:["前回: ",(null==n?void 0:n.scs)||"記録なし"]})]}),(0,s.jsxs)("td",{children:[(0,s.jsxs)("select",{className:"scsReason-select",value:h,onChange:e=>u(e.target.value),disabled:0===p.length||y,children:[(0,s.jsx)("option",{value:""}),p.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),(0,s.jsx)("div",{className:"previous-record",children:(null==n?void 0:n.scsReason)||""})]}),(0,s.jsx)("td",{className:"problemPriority-display",children:g}),(0,s.jsx)("td",{className:"attempts-count",children:i.attempts}),(0,s.jsx)("td",{children:(0,s.jsx)("button",{className:"record-btn".concat(y?" recorded":"").concat(f?" fade":""),disabled:o||y,onClick:v,style:y?{background:"#ccc",color:"#888",cursor:"not-allowed"}:{},children:y?"記録完了":o?"記録中...":"記録"})})]})}function c(e){let{user:t,unitId:i,appState:o,setAppState:l,onClose:c}=e,[h,u]=(0,r.useState)(!1),[p,m]=(0,r.useState)(o.records),[y,x]=(0,r.useState)(0);(0,r.useEffect)(()=>{m(o.records)},[o.records]);let f=o.units.find(e=>e.id===i),j=o.problems.filter(e=>e.UnitID===i),g=async(e,i,s)=>{if(!i)return alert("正解・不正解を選択してください。"),!1;if(("正解（微妙）"===i||"不正解（惜しい）"===i)&&!s)return alert("理解状況を選択してください。"),!1;u(!0);try{var r;let d=((e,t,i)=>{let s=JSON.parse(JSON.stringify(p));s[e]||(s[e]={attempts:0,history:[],probremPriority:0}),s[e].attempts=(s[e].attempts||0)+1;let r=s[e].probremPriority,n=o.problems.find(t=>t.id===e);if(!n)return s;let a=o.units.find(e=>e.id===n.UnitID);if(!a)return s;if("正解（完璧）"===t&&(r=0,s[e].history?s[e].history.push({scs:"正解（完璧）",scsReason:i,timestamp:new Date}):s[e].history=[{scs:"正解（完璧）",scsReason:i,timestamp:new Date}]),"たまたま解けた"===i){for(let n of(r=Math.min(r+1,4),s[e].history?s[e].history.push({scs:t,scsReason:i,timestamp:new Date}):s[e].history=[{scs:t,scsReason:i,timestamp:new Date}],o.problems))if(n.UnitID===a.id&&n.id!==e){let e=s[n.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){s[n.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}if("時間がかかってしまった"===i&&(r=Math.min(r+1,4),s[e].history?s[e].history.push({scs:t,scsReason:i,timestamp:new Date}):s[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"防げた計算ミスがあった"===i&&(r=Math.min(r+1,4),s[e].history?s[e].history.push({scs:t,scsReason:i,timestamp:new Date}):s[e].history=[{scs:t,scsReason:i,timestamp:new Date}]),"解き方をギリギリ思い出せなかった"===i){r=Math.min(r+2,4);let t=[a.id];for(let i of(a.DependsOn&&t.push(...String(a.DependsOn).split(",").map(e=>e.trim())),o.problems))if(t.includes(i.UnitID)&&i.id!==e){let e=s[i.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){s[i.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}if("不正解（まだまだ）"===t){r=Math.min(r+2,4);let t=[a.id];for(let i of(a.DependsOn&&t.push(...String(a.DependsOn).split(",").map(e=>e.trim())),o.problems))if(t.includes(i.UnitID)&&i.id!==e){let e=s[i.id];if(!e||0===e.attempts&&(!e.history||0===e.history.length)){s[i.id]={attempts:0,history:[],probremPriority:1};continue}"正解（完璧）"!==(e.history&&e.history.length>0?e.history[e.history.length-1].scs:void 0)&&(e.probremPriority=Math.min(e.probremPriority+1,4))}}return s[e].probremPriority=r,s})(e,i,s),{updatedUnitPriorities:c}=((e,t)=>{let i={},s=o.problems.reduce((e,t)=>(e[t.id]=t.UnitID,e),{}),r=o.units.reduce((e,t)=>(e[t.id]=t,e),{}),n=s[e],a=r[n],l=[n];for(let e of(a.DependsOn&&l.push(...String(a.DependsOn).split(",").map(e=>e.trim())),[...new Set(l)])){let s=o.problems.filter(t=>t.UnitID===e).map(e=>e.id),r=0,n=0;s.forEach(e=>{t[e]&&(t[e].probremPriority>0||(t[e].attempts||0)>0)&&(r+=t[e].probremPriority,n++)}),n>0&&(i[e]=Math.min(r/n,4))}return{updatedUnitPriorities:i}})(e,d);m(d);let h=(0,n.doc)(a.db,"users",t.uid),u=(0,n.writeBatch)(a.db),y=(0,n.doc)((0,n.collection)(h,"learningLog"));u.set(y,{problemId:e,scs:i,scsReason:s,probremPriority:d[e].probremPriority,timestamp:(0,n.serverTimestamp)()});let x=(0,n.doc)(h,"problemRecords",e);return u.set(x,{probremPriority:d[e].probremPriority,attempts:((null==(r=o.records[e])?void 0:r.attempts)||0)+1,history:(0,n.arrayUnion)({scs:i,scsReason:s,timestamp:new Date})},{merge:!0}),Object.keys(c).forEach(e=>{let t=(0,n.doc)(h,"unitPriorities",e);u.set(t,{priority:c[e]})}),await u.commit(),l(e=>({...e,records:d,unitPriorities:{...e.unitPriorities,...c}})),!0}catch(e){return console.error("記録エラー:",e),alert("記録中にエラーが発生しました。"),m(o.records),!1}finally{u(!1)}};return f?(0,s.jsx)("div",{id:"detail-panel",children:(0,s.jsxs)("div",{className:"panel-content",children:[(0,s.jsxs)("div",{id:"detail-header",children:[(0,s.jsx)("h2",{id:"detail-unit-name",children:f.UnitName}),(0,s.jsx)("button",{id:"close-detail",title:"閉じる",onClick:()=>{x(e=>e+1),c()},children:"\xd7"})]}),(0,s.jsxs)("div",{id:"detail-body",children:[f.imagePath&&(0,s.jsx)("div",{id:"detail-image-container",children:(0,s.jsx)("img",{id:"detail-image",src:f.imagePath,alt:f.UnitName})}),(0,s.jsx)("h3",{children:"問題リスト"}),(0,s.jsx)("div",{className:"table-wrapper",children:(0,s.jsxs)("table",{id:"problem-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"問題番号"}),(0,s.jsx)("th",{children:"正解・不正解"}),(0,s.jsx)("th",{children:"主観的な理解状況"}),(0,s.jsx)("th",{children:"問題復習優先度"}),(0,s.jsx)("th",{children:"解いた回数"}),(0,s.jsx)("th",{children:"アクション"})]})}),(0,s.jsx)("tbody",{children:j.map(e=>{var t;let i=p[e.id]||{attempts:0,probremPriority:0,history:[]},r=(null==(t=i.history)?void 0:t.slice(-1)[0])||{};return(0,s.jsx)(d,{problem:e,record:i,lastRecord:r,handleRecord:g,loading:h},e.id+"-"+y)})})]})})]})]})}):null}function h(e){let{user:t}=e,[o,l]=(0,r.useState)({units:[],problems:[],records:{},unitPriorities:{}}),[d,h]=(0,r.useState)(!0),[u,p]=(0,r.useState)(null),m=(0,r.useRef)([]);if((0,r.useEffect)(()=>{(async()=>{if(t){h(!0);try{let e=(await (0,n.getDocs)((0,n.collection)(a.db,"units"))).docs.map(e=>({id:e.id,...e.data()})),i=(await (0,n.getDocs)((0,n.collection)(a.db,"problems"))).docs.map(e=>({id:e.id,...e.data()})),s=(0,n.doc)(a.db,"users",t.uid),r=await (0,n.getDocs)((0,n.collection)(s,"problemRecords")),o={};r.forEach(e=>{o[e.id]=e.data()});let d=await (0,n.getDocs)((0,n.collection)(s,"unitPriorities")),c={};d.forEach(e=>{c[e.id]=e.data().priority}),l({units:e,problems:i,records:o,unitPriorities:c})}catch(e){console.error("Initialization failed:",e),alert("データの読み込みに失敗しました。")}finally{h(!1)}}})()},[t]),(0,r.useEffect)(()=>(m.current.forEach(e=>e.remove()),m.current=[],o.units.length>0&&!d&&i.e(495).then(i.t.bind(i,7495,23)).then(e=>{o.units.forEach(t=>{if(t.DependsOn){let i=document.getElementById(t.id);String(t.DependsOn).split(",").forEach(t=>{let s=document.getElementById(t.trim());if(s&&i){let t=new e.default(s,i,{color:"rgba(0, 0, 0, 0.6)",size:2,path:"straight",endPlug:"arrow1",dropShadow:!0});m.current.push(t)}})}})}),()=>{m.current.forEach(e=>e.remove()),m.current=[]}),[o.units,d]),d)return(0,s.jsx)("div",{style:{padding:"2rem"},children:"Loading Flowchart..."});let y=o.units.length>0?Math.max(...o.units.map(e=>e.PosY||0)):1,x={},f=0;return o.units.forEach(e=>{let t=o.unitPriorities[e.id];if(void 0!==t&&t>0){let i=Math.ceil(t);x[e.id]=i,i>f&&(f=i)}else x[e.id]=0}),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{id:"flowchart-container",children:o.units.map(e=>{let t=o.unitPriorities[e.id],i="flowchart-node";x[e.id]===f&&f>0&&(i+=" node-top-priority");let r=null;if(void 0!==t&&t>0){let e=Math.ceil(t);e>0&&(r=(0,s.jsx)("span",{className:"priority-badge",children:"⭐".repeat(e)}))}return(0,s.jsxs)("div",{id:e.id,className:i,style:{left:"".concat((e.PosX-1)*200,"px"),top:"".concat((y-e.PosY)*130,"px")},onClick:()=>p(e.id),children:[(0,s.jsx)("span",{children:e.UnitName}),r]},e.id)})}),u&&(0,s.jsx)(c,{user:t,unitId:u,appState:o,setAppState:l,onClose:()=>p(null)})]})}var u=i(887);function p(){let[e,t]=(0,r.useState)(null),[i,l]=(0,r.useState)(!0),[d,c]=(0,r.useState)(!1);(0,r.useEffect)(()=>{let e=(0,o.hg)(a.j,async e=>{if(t(e),l(!1),e){let t=(0,n.doc)(a.db,"users",e.uid);(await (0,n.getDoc)(t)).exists()||await (0,n.setDoc)(t,{email:e.email},{merge:!0})}});return()=>e()},[]);let p=async()=>{let e=new o.HF;try{await (0,o.df)(a.j,e)}catch(e){console.error("Login failed:",e)}},m=async()=>{try{await (0,o.CI)(a.j)}catch(e){console.error("Logout failed:",e)}};return i?(0,s.jsx)("div",{style:{padding:"2rem"},children:"Loading..."}):(0,s.jsxs)("div",{id:"app",children:[(0,s.jsxs)("header",{children:[(0,s.jsx)("h1",{children:"数学学習フローチャート"}),(0,s.jsx)("div",{id:"auth-container",children:e?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{id:"user-info",children:["ようこそ, ",(0,s.jsx)("span",{id:"user-email",children:e.email})," さん"]}),(0,s.jsx)("button",{onClick:()=>c(!0),style:{marginRight:8},children:"プロフィール変更"}),(0,s.jsx)("button",{id:"logout-btn",onClick:m,children:"ログアウト"})]}):(0,s.jsx)("button",{id:"login-btn",onClick:p,children:"Googleアカウントでログイン"})})]}),(0,s.jsx)("main",{children:e?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h,{user:e}),(0,s.jsx)(u.A,{user:e,open:d,onClose:()=>c(!1)})]}):(0,s.jsx)("div",{style:{padding:"2rem",textAlign:"center"},children:(0,s.jsx)("p",{children:"Googleアカウントでログインしてください。"})})})]})}}},e=>{e.O(0,[135,965,670,901,441,964,358],()=>e(e.s=5535)),_N_E=e.O()}]);